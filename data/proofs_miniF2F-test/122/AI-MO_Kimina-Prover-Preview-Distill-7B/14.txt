-- A small note: $9/(x+y+z)$ is the arithmetic mean of $2/(x+y)$, $2/(y+z)$, and $2/(z+x)$.
  -- The "convexity" of the mapping $t \mapsto 1/t$ should be used, rather than the Cauchy-Schwarz inequality.

  -- Let $a = 1/(x+y)$, $b = 1/(y+z)$, and $c = 1/(z+x)$, then we have $1/x = b+c$, $1/y = c+a$, and $1/z = a+b$.
  let a := 1 / (x + y)
  let b := 1 / (y + z)
  let c := 1 / (z + x)

  have h₁ : 1 / x = b + c := by
    calc
      1 / x = 1 / (x + y + z - y - z) := by ring
      _ = 1 / (x + y + z) * (1 / (1 - y / (x + y + z) - z / (x + y + z))) := by
        rw [div_div, sub_div, add_div, div_div, div_one]
        apply Or.inl
        similar
        apply And.intro
        first | field_simp
        | apply And.intro
          first | field_simp
          | linarith only [h₀.left, h₀.right.left, h₀.right.right]
      _ = 1 / (x + y + z) * (1 / ((x + y) / (x + y + z) + (z + y) / (x + y + z))) := by
        congr
        push_cast
        ring
      _ = 1 / (x + y + z) * (1 / ((x + y) / (x + y + z) + 1 - (z + x) / (x + y + z))) := by
        simp
        ring
      _ = 1 / (x + y + z) * (1 / (1 - (z + x) / (x + y + z))) := by
        congr
        push_cast
        ring
      _ = 1 / (x + y + z) * ((x + y + z) / (x + y)) := by
        congr
        push_cast
        field_simp
        ring
      _ = (x + y + z) / (x + y) / (x + y + z) := by
        congr
        norm_num
      _ = 1 / (x + y) := by
        norm_num
  have h₂ : 1 / y = c + a := by
    calc
      1 / y = 1 / (x + y + z - x - z) := by ring
      _ = 1 / (x + y + z) * (1 / (1 - x / (x + y + z) - z / (x + y + z))) := by
        rw [div_div, sub_div, add_div, div_div, div_one]
        apply Or.inl
        similar
        apply And.intro
        first | field_simp
        | apply And.intro
          first | field_simp
          | linarith only [h₀.left, h₀.right.left, h₀.right.right]
      _ = 1 / (x + y + z) * (1 / ((y + x) / (x + y + z) + (z + y) / (x + y + z))) := by
        congr
        push_cast
        ring
      _ = 1 / (x + y + z) * (1 / ((y + x) / (x + y + z) + 1 - (x + z) / (x + y + z))) := by
        simp
        ring
      _ = 1 / (x + y + z) * (1 / (1 - (x + z) / (x + y + z))) := by
        congr
        push_cast
        field_simp
        ring
      _ = 1 / (y + z) := by
        calc
          1 / (x + y + z) * (1 / (1 - (x + z) / (x + y + z))) = 1 / (x + y + z) * ((x + y + z) / (y + z)) := by
            congr
            push_cast
            field_simp
            ring
          _ = (x + y + z) / (y + z) / (x + y + z) := by
            congr
            norm_num
          _ = 1 / (y + z) := by
            norm_num
  have h₃ : 1 / z = a + b := by
    calc
      1 / z = 1 / (x + y + z - x - y) := by ring
      _ = 1 / (x + y + z) * (1 / (1 - x / (x + y + z) - y / (x + y + z))) := by
        rw [div_div, sub_div, add_div, div_div, div_one]
        apply Or.inl
        similar
        apply And.intro
        first | field_simp
        | apply And.intro
          first | field_simp
          | linarith only [h₀.left, h₀.right.left, h₀.right.right]
      _ = 1 / (x + y + z) * (1 / ((z + y) / (x + y + z) + (x + z) / (x + y + z))) := by
        congr
        push_cast
        ring
      _ = 1 / (x + y + z) * (1 / ((z + y) / (x + y + z) + 1 - (y + x) / (x + y + z))) := by
        simp
        ring
      _ = 1 / (x + y + z) * (1 / (1 - (y + x) / (x + y + z))) := by
        congr
        push_cast
        field_simp
        ring
      _ = 1 / (z + x) := by
        calc
          1 / (x + y + z) * (1 / (1 - (y + x) / (x + y + z))) = 1 / (x + y + z) * ((x + y + z) / (z + x)) := by
            congr
            push_cast
            field_simp
            ring
          _ = (x + y + z) / (z + x) / (x + y + z) := by
            congr
            norm_num
          _ = 1 / (z + x) := by
            norm_num

  -- We have $1/x = b+c$, $1/y = c+a$, $1/z = a+b$. So, $9/(x+y+z) = 1/3 \cdot (1/x + 1/y + 1/z) = 1/3 \cdot (2a+2b+2c)$.
  have h₄ : 9 / (x + y + z) = 1 / 3 * (1 / x + 1 / y + 1 / z) := by
    calc
      9 / (x + y + z) = 1 / 3 * (3 / (x + y + z)) := by
        ring
      _ = 1 / 3 * ((x + y + z) / (x + y + z)) := by
        rw [div_div, mul_div_cancel_right₀]
        norm_num
      _ = 1 / 3 * (1 / (x + y + z) * (x + y + z)) := by
        ring
      _ = 1 / 3 * ((1 / (x + y + z)) * (x + y + z)) := by
        ring
      _ = 1 / 3 * (1 / x + 1 / y + 1 / z) := by
        rw [h₁, h₂, h₃]
        ring
  rw [h₄]

  -- The rest is to show that $1/3 \cdot (1/x + 1/y + 1/z) \leq 2/(x+y) + 2/(y+z) + 2/(z+x)$, which is a direct result of the convexity of $t \mapsto 1/t$.
  -- We need to use convexity, e.g., the `mul_le_mul_left` lemma with $1/3$.
  have h₅ : 1 / 3 * (1 / x + 1 / y + 1 / z) ≤ 2 / (x + y) + 2 / (y + z) + 2 / (z + x) := by
    -- We have $1/x = b+c$, $1/y = c+a$, $1/z = a+b$. So, $1/3 \cdot (1/x + 1/y + 1/z) = 1/3 \cdot (2a+2b+2c) = 2/3 \cdot (a+b+c)$.
    rw [h₁, h₂, h₃]
    -- We also have $a+b+c = 1/x + 1/y + 1/z$.
    have h₆ : 1 / (x + y) + 1 / (y + z) + 1 / (z + x) = 1 / x + 1 / y + 1 / z := by
      calc
        1 / (x + y) + 1 / (y + z) + 1 / (z + x) = a + b + c := by
          ring
        _ = 1 / x + 1 / y + 1 / z := by
          calc
            1 / (x + y) + 1 / (y + z) + 1 / (z + x) = a + b + c := by
              ring
            _ = 1 / x + 1 / y + 1 / z := by
              rw [h₁, h₂, h₃]
    rw [←h₆]

    -- Let's generalize the goal to $a+b+c \leq 3 \cdot (2/3 \cdot a + 2/3 \cdot b + 2/3 \cdot c)$, where $a = 1/(x+y)$, $b = 1/(y+z)$, and $c = 1/(z+x)$.
    suffices ∀ a > 0 ∧ b > 0 ∧ c > 0, a + b + c ≤ 3 * (2 / 3 * a + 2 / 3 * b + 2 / 3 * c) by
      specialize this a b c
      simpa

    -- The last inequality is equivalent to $0 \leq (a-b)^2 + (b-c)^2 + (c-a)^2$.
    intro a b c
    suffices 0 ≤ (a - b) ^ 2 + (b - c) ^ 2 + (c - a) ^ 2 by
      linarith
    positivity

  exact h₅

```