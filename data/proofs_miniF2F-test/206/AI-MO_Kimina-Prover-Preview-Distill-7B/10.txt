-- Lemma 1. Let $x$ be a real number. If $f(x) - f(x)^2 ≥ 0$, then $1 / 2 ≤ f(x + a) < 1$.
  have h₂ (x : ℝ) : 0 ≤ f x - f x ^ 2 → 1 / 2 ≤ f (x + a) ∧ f (x + a) < 1 := by
    intro h
    rw [h₁ x, add_comm]
    -- Let $y = f(x) - f(x)^2$. We have $1 / 2 + \sqrt{y} = f(x + a)$ and $0 ≤ y$.
    set y := f x - f x ^ 2 with y_def
    -- We want to prove that $1 / 2 + \sqrt{y} < 1$.
    have h₃ : 1 / 2 + Real.sqrt y < 1 := by
      -- $\sqrt{y} < 1 - 1 / 2 = 1 / 2$.
      suffices Real.sqrt y < 1 / 2 by linarith
      suffices y < (1 / 2)^2 by exact (Real.sqrt_lt' (by positivity)).mpr this
      rw [y_def]
      linarith [sq_nonneg (f x), sq_nonneg (f x - 1)]
    -- $\sqrt{y} ≥ 0$ so $1 / 2 + \sqrt{y} ≥ 1 / 2$.
    have h₄ : 1 / 2 ≤ 1 / 2 + Real.sqrt y := by
      linarith [Real.sqrt_nonneg y]
    -- The goal follows from the previous two inequalities.
    constructor <;> linarith

  -- Lemma 2. Let $x$ be a real number. If $f(x) - f(x)^2 ≥ 0$ and $f(x + ka) = f(x)$ for all $k \in \mathbb{N}$, then $f(x + a) = f(x)$.
  have h₃ (x : ℝ) (h₄ : 0 ≤ f x - f x ^ 2) (h₅ : ∀ k, f (x + k * a) = f x) : f (x + a) = f x := by
    -- Take $k = 1$ to the hypothesis.
    have h₆ := h₅ 1
    rwa [add_comm] at h₆

  -- Lemma 3. Let $x$ be a real number. If $f(x) - f(x)^2 ≥ 0$, then $f(x + a) = f(x)$.
  have h₄ (x : ℝ) (h₅ : 0 ≤ f x - f x ^ 2) : f (x + a) = f x := by
    -- By lemma 2, there exists $b > 0$ such that $f(x + b) = f(x)$.
    have ⟨b, h₆, h₇⟩ := h₅
    -- Take $k = b / a$ to the hypothesis.
    have h₈ := h₆ (b / a)
    -- Do some calculation.
    rw [mul_div_cancel₀ _ (by positivity), show b / a * a = b + a - a by ring] at h₈
    rwa [sub_add_cancel] at h₈

  -- We now start proving the theorem.
  -- Set $x = 0$ to the functional equation. We get $f(a) = 1 / 2 + \sqrt{f(0) - f(0)^2}$.
  have h₅ := h₁ 0
  -- Set $x = a$ to the functional equation. We get $f(2a) = 1 / 2 + \sqrt{f(a) - f(a)^2}$.
  have h₆ := h₁ a
  -- Do some calculation.
  rw [add_comm] at h₅
  rw [show a + a = 2 * a by ring] at h₆
  -- Substitute the expression of $f(a)$ to $f(2a)$.
  rw [h₅] at h₆
  -- Do some algebra.
  have h₇ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2)) ^ 2) = 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - ((1 / 2 + Real.sqrt (f 0 - f 0 ^ 2)) ^ 2)) := by
    rw [add_sub_add_right]
  rw [h₇] at h₆
  -- Note that $1 / 2 + \sqrt{f(0) - f(0)^2} ≥ 1 / 2$.
  have h₈ : 1 / 2 ≤ 1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) := by
    linarith [Real.sqrt_nonneg (f 0 - f 0 ^ 2)]
  -- And $f(2a) ≥ 1 / 2 + \sqrt{1 / 2 - (1 / 2 + \sqrt{f(0) - f(0)^2})^2} = 1 / 2 + \sqrt{1 / 2 - (1 / 2)^2} = 1 / 2 + \sqrt{1 / 4} = 1 / 2 + 1 / 2 = 1$.
  have h₉ : f (2 * a) ≥ 1 := by
    -- Calculate the expression under the square root.
    have h₁₀ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - ((1 / 2 + Real.sqrt (f 0 - f 0 ^ 2)) ^ 2)) = 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + 2 * (1 / 2) * Real.sqrt (f 0 - f 0 ^ 2) + (Real.sqrt (f 0 - f 0 ^ 2)) ^ 2)) := by
      rw [add_sub_add_right]
    -- Simplify the expression under the square root.
    rw [h₁₀]
    have h₁₁ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + 2 * (1 / 2) * Real.sqrt (f 0 - f 0 ^ 2) + (Real.sqrt (f 0 - f 0 ^ 2)) ^ 2)) = 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + 2 * (1 / 2) * Real.sqrt (f 0 - f 0 ^ 2) + f 0 - f 0 ^ 2)) := by
      congr
      rw [Real.sq_sqrt (by linarith)]
    -- Further simplify the expression under the square root.
    rw [h₁₁]
    have h₁₂ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + 2 * (1 / 2) * Real.sqrt (f 0 - f 0 ^ 2) + f 0 - f 0 ^ 2)) = 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + f 0 - f 0 ^ 2)) := by
      congr
      ring
    -- Still simplify the expression under the square root.
    rw [h₁₂]
    have h₁₃ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + f 0 - f 0 ^ 2)) = 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + f 0 - f 0 ^ 2)) := by
      exact rfl
    -- Simplify the expression under the square root.
    rw [h₁₃]
    have h₁₄ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) - (1 / 2 ^ 2 + f 0 - f 0 ^ 2)) = 1 / 2 + Real.sqrt (2 * (1 / 2) * Real.sqrt (f 0 - f 0 ^ 2)) := by
      congr
      ring
    -- Simplify the expression under the square root.
    rw [h₁₄]
    have h₁₅ : 1 / 2 + Real.sqrt (2 * (1 / 2) * Real.sqrt (f 0 - f 0 ^ 2)) = 1 / 2 + Real.sqrt (Real.sqrt (f 0 - f 0 ^ 2)) := by
      congr
      rw [mul_assoc, Real.sqrt_mul (by positivity)]
      ring
    -- Simplify the expression under the square root.
    rw [h₁₅]
    have h₁₆ : 1 / 2 + Real.sqrt (Real.sqrt (f 0 - f 0 ^ 2)) ≥ 1 := by
      have h₁₇ : Real.sqrt (f 0 - f 0 ^ 2) ≥ 0 := by
        exact Real.sqrt_nonneg (f 0 - f 0 ^ 2)
      have h₁₈ : Real.sqrt (Real.sqrt (f 0 - f 0 ^ 2)) ≥ 0 := by
        exact Real.sqrt_nonneg (Real.sqrt (f 0 - f 0 ^ 2))
      linarith
    linarith

  -- Prove that $f(0) - f(0)^2 ≥ 0$.
  have h₅ : 0 ≤ f 0 - f 0 ^ 2 := by
    -- Assume on the contrary that $f(0) - f(0)^2 < 0$.
    by_contra! h₅
    -- Then $1 / 2 + \sqrt{f(0) - f(0)^2} < 1 / 2 + 1$.
    have h₆ : 1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) < 1 := by
      have h₇ : Real.sqrt (f 0 - f 0 ^ 2) < 1 - 1 / 2 := by
        suffices Real.sqrt (f 0 - f 0 ^ 2) < 1 / 2 by linarith
        suffices f 0 - f 0 ^ 2 < (1 / 2) ^ 2 by exact (Real.sqrt_lt' (by positivity)).mpr this
        linarith
      linarith [Real.sqrt_nonneg (f 0 - f 0 ^ 2)]
    -- The inequality is equivalent to $f(a) < 1$.
    rw [h₅] at h₆
    have h₇ : f (a) < 1 := by
      linarith
    -- Since $f(a) ≥ 1$, we have a contradiction.
    linarith

  -- By lemma 3, $f(a) = f(0)$.
  have h₆ : f a = f 0 := by
    -- Apply lemma 3 to $x = 0$.
    apply h₄ 0
    assumption

  -- By lemma 1, $f(2a) = 1 / 2 + \sqrt{f(a) - f(a)^2} = 1 / 2 + \sqrt{f(0) - f(0)^2} = 1 / 2 + \sqrt{f(0) - f(0)^2}$.
  have h₇ : f (2 * a) = 1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) := by
    -- Set $x = 0$ to the functional equation.
    have h₈ := h₁ 0
    -- Simplify the expression.
    rw [show 0 + a = a by ring, h₆] at h₈
    exact h₈

  -- By lemma 2, there exists $b > 0$ such that $f(x + b) = f(x)$ for all $x \in \mathbb{R}$.
  have ⟨b, h₈, h₉⟩ := h₃ 0 (by linarith) (fun k => h₅)
  -- Take $x = a$ to the hypothesis.
  have h₁₀ := h₉ a
  -- Note that $b > 0$.
  have h₁₁ : 0 < b := by
    by_contra! h₁₁
    -- If $b ≤ 0$, then $b = 0$.
    have h₁₂ : b = 0 := by
      linarith [h₁₁]
    -- Substitute $b = 0$ to $h₉$.
    simp [h₁₂] at h₉
    -- We get $f(a) = f(0)$ which is true.
    linarith [h₆]

  -- We have $f(a + b) = f(a)$ and $f(a) = f(0)$ so $f(a + b) = f(0)$.
  have h₁₂ : f (a + b) = f 0 := by
    rw [h₉, h₆]

  -- We also have $f(2a) = 1 / 2 + \sqrt{f(0) - f(0)^2}$ and $f(a + b) = f(0)$.
  have h₁₃ : f (a + b) = 1 / 2 + Real.sqrt (f 0 - f 0 ^ 2) := by
    rw [h₇]

  -- Now we prove that $b = 0$.
  have h₁₄ : b = 0 := by
    -- Assume on the contrary that $b ≠ 0$.
    by_contra! h₁₄
    -- Then $b > 0$.
    have h₁₅ : 0 < b := by
      by_contra! h₁₅
      have h₁₆ : b = 0 := by
        linarith [h₁₅]
      simp [h₁₆] at h₉
      have h₁₇ := h₅ (b / a)
      have h₁₈ := h₆
      have h₁₉ := h₈ (b / a)
      have h₁₂₀ := h₉
      -- Do some calculation.
      have h₁₂₁ : f (b / a * a) = f (b / a * a + b) := by
        exact h₁₂₁
      -- This is equivalent to $f(b + a) = f(2b + a)$.
      rw [show b / a * a = b + a - a by ring, show b / a * a + b = 2 * b + a - a by ring] at h₁₂₁
      rwa [sub_add_cancel, sub_add_cancel] at h₁₂₁

    -- $f(b + a) ≥ 1$ by applying lemma 1 to $x = b$.
    have h₁₆ : f (b + a) ≥ 1 := by
      -- Apply lemma 1 to $x = b$.
      have h₁₇ := h₁ b
      -- Simplify the expression.
      rw [show b + a + a = 2 * b + a by ring] at h₁₇
      -- Substitute the expression of $f(2b + a)$.
      rw [h₁₇]
      -- Do some algebra.
      have h₁₈ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f b - f b ^ 2) - (1 / 2 + Real.sqrt (f b - f b ^ 2)) ^ 2) = 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f b - f b ^ 2) - ((1 / 2) ^ 2 + 2 * (1 / 2) * Real.sqrt (f b - f b ^ 2) + (Real.sqrt (f b - f b ^ 2)) ^ 2)) := by
        rw [add_sub_add_right]
      rw [h₁₈]
      -- Simplify the expression under the square root.
      have h₁₉ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f b - f b ^ 2) - ((1 / 2) ^ 2 + 2 * (1 / 2) * Real.sqrt (f b - f b ^ 2) + (Real.sqrt (f b - f b ^ 2)) ^ 2)) = 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f b - f b ^ 2) - (1 / 2 ^ 2 + 2 * (1 / 2) * Real.sqrt (f b - f b ^ 2) + f b - f b ^ 2)) := by
        congr
        rw [Real.sq_sqrt (by linarith)]
      rw [h₁₉]
      have h₂₀ : 1 / 2 + Real.sqrt (1 / 2 + Real.sqrt (f b - f b ^ 2) - (1 / 2 ^ 2 + f b - f b ^ 2)) = 1 / 2 + Real.sqrt (2 * (1 / 2) * Real.sqrt (f b - f b ^ 2)) :=