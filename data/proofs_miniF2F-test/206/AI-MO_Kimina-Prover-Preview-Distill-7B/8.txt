-- First, we need to show that the expression under the square root is non-negative.
  have h₂ (x : ℝ) : f x - f x ^ 2 ≥ 0 := by
    have h₂ : f x - f x ^ 2 = (f x - 1 / 2) ^ 2 + (1 / 2) * (f x - 1 / 2) + 1 / 4 := by ring
    rw [h₂]
    positivity

  -- Applying the Cauchy-Schwarz inequality to show that the expression under the square root is non-negative.
  have h₂ (x : ℝ) : 0 ≤ Real.sqrt (f x - f x ^ 2) := by
    apply Real.sqrt_nonneg

  -- Prove that the expression under the square root is strictly positive.
  have h₃ (x : ℝ) : 0 < Real.sqrt (f x - f x ^ 2) := by
    have h₃ : 0 < f x - f x ^ 2 := by linarith
    positivity

  -- Show that the sequence $f(x+n*a)$ is positive and bounded above by 1.
  have h₄ (x : ℝ) : ∀ n : ℕ, 0 < f (x + n * a) ∧ f (x + n * a) < 1 := by
    intro n
    induction n with
    | zero =>
      simp
      constructor
      · linarith
      · specialize h₁ x
        linarith
    | succ n hn =>
      push_cast
      specialize h₁ (x + n * a)
      specialize h₃ (x + n * a)
      rcases hn with ⟨hn₁, hn₂⟩
      constructor
      · linarith
      · linarith

  -- Prove that the sequence $f(x+n*a)$ is strictly increasing.
  have h₅ (x : ℝ) : ∀ n : ℕ, f (x + n * a) < f (x + (n + 1) * a) := by
    intro n
    specialize h₁ (x + n * a)
    simp_rw [add_assoc] at h₁
    rw [h₁]
    specialize h₂ (x + n * a)
    linarith

  -- Show that the sequence $f(x+n*a)$ is unbounded if $f(x+na) > 1/2$ for some $n$.
  have h₆ (x : ℝ) : (∃ n : ℕ, 1 / 2 < f (x + n * a)) → unboundedSet (Set.range (fun n ↦ f (x + n * a))) := by
    intro h
    rcases h with ⟨n, hn⟩
    simp [Set.unboundedSet]
    use (n + ⌊(1 / (f (x + n * a) - 1 / 2)) / (f (x + (n + 1) * a) - 1 / 2)⌋.natAbs⌋.natAbs
    apply le_of_lt
    set T := (1 / (f (x + n * a) - 1 / 2)) / (f (x + (n + 1) * a) - 1 / 2)
    have hT : T > 0 := by
      simp [T]
      linarith
    rw [show (⌊T⌋.natAbs : ℝ) = (⌊T⌋.natAbs : ℤ) by norm_cast]
    rw [show ↑⌊T⌋.natAbs = ⌊T⌋.natAbs by norm_cast]
    suffices h : (⌊T⌋.natAbs : ℤ) < (⌊T⌋.natAbs + 1 : ℤ) by
      norm_cast at h
      apply lt_trans h
      apply le_of_lt
      calc
        (⌊T⌋.natAbs : ℝ) < ⌊T⌋.natAbs + 1 := by
          norm_cast
          apply Int.lt_add_one
        _ ≤ (⌊T⌋.natAbs + 1 : ℤ) := by norm_cast
    simp
    apply Int.lt_add_one

  -- Show that the sequence $f(x+n*a)$ is unbounded if $f(x+na) ≥ 1/2$ for some $n$.
  have h₆' (x : ℝ) : (∃ n : ℕ, 1 / 2 ≤ f (x + n * a)) → unboundedSet (Set.range (fun n ↦ f (x + n * a))) := by
    intro h
    rcases h with ⟨n, hn⟩
    simp [Set.unboundedSet]
    apply exists_unboundedSet_atTop
    apply Set.unboundedSet_atTop_of_infinite
    have h : unboundedSet (Set.range (fun n ↦ f (x + n * a))) := by
      apply Set.infinite_of_unboundedSet
      apply Set.infinite_range_of_forall_exists_gt
      intro y
      specialize h₅ x
      rcases h₅ with ⟨n, hn⟩
      specialize h₁ (x + n * a)
      simp_rw [add_assoc] at h₁
      rw [h₁]
      suffices h : (f (x + (n + 1) * a) - 1 / 2) * (y - 1 / 2) > 0 by
        apply lt_of_mul_pos_left at h
        apply lt_trans h
        apply h₃
        linarith
        apply lt_of_le_of_ne h₁
        apply le_of_lt
        linarith
      apply mul_pos_of_pos_of_pos
      · linarith
      · apply lt_trans?_
        · apply h₄
          linarith
        · linarith
    exact h

  -- Show that the sequence $f(x+n*a)$ takes values in a closed interval.
  have h₇ (x : ℝ) : ∀ n : ℕ, f (x + n * a) ∈ Set.Icc (1 / 2) 1 := by
    intro n
    constructor
    · specialize h₃ (x + n * a)
      linarith
    · specialize h₄ (x + n * a)
      linarith

  -- Show that the sequence $f(x+n*a)$ is eventually constant.
  have h₈ (x : ℝ) : ∃ N : ℕ, ∀ n ≥ N, f (x + n * a) = f (x + (n + 1) * a) := by
    by_cases h : ∃ n, 1 / 2 < f (x + n * a)
    · obtain ⟨n, hn⟩ := h
      rw [show n = (n + 1) - 1 by omega] at hn
      specialize h₅ x (n - 1)
      simp_rw [add_assoc] at h₅
      rw [← hn] at h₅
      use (n - 1).natAbs
      intro m hm
      rw [show m = (m + 1) - 1 by omega] at hm
      specialize h₅ (x + (n - 1) * a) m
      simp_rw [add_assoc] at h₅
      rw [h₅, hn]
      ring
    · push_neg at h
      rw [Set.not_exists] at h
      simp at h
      have h₈ : unboundedSet (Set.range (fun n ↦ f (x + n * a))) := by
        apply Set.infinite_of_unboundedSet
        apply Set.infinite_range_of_forall_exists_gt
        intro y
        specialize h₅ x
        rcases h₅ with ⟨n, hn⟩
        specialize h₄ (x + n * a)
        linarith
        apply lt_of_le_of_ne h₃
        apply le_of_lt
        linarith
        linarith
      absurd h₈
      apply h₆'
      intro n hn
      specialize h₄ (x + n * a)
      linarith

  -- Define the number b as the least element of the set of positive real numbers such that $f(x+b)=f(x)$ for all $x$.
  let b := inf (Set.univ.filter (fun n ↦ f (x + n * a) = f x).filter (fun n ↦ n > 0))

  -- Show that $b$ is positive.
  have h₉ : b > 0 := by
    apply inf_pos
    simp
    intro n hn
    specialize h₅ x n
    linarith

  -- Show that $f(x+b)=f(x)$ for all $x$.
  have h₁₀ : ∀ x, f (x + b) = f x := by
    intro x
    by_cases h: ∃ n, (n > 0 ∧ f (x + n * a) = f x) ∧ (f (x + (n + 1) * a) ≠ f x)
    · obtain ⟨n, ⟨hn₁, hn₂⟩⟩ := h
      have h₁₀ : (n + 1) * a ≥ b := by
        simp [b]
        constructor
        · linarith
        · specialize h₈ x
          simp at h₈
          rcases h₈ with ⟨N, h₈⟩
          use (n + 1 - N).natAbs
          intro m hm
          have hm₁ : (n + 1) * a = x + (n + 1 - m) * a := by
            rw [show n + 1 - m = n + 1 - m + 0 by simp]
            rw [← add_sub_assoc]
            simp
            rw [Nat.cast_sub]
            simp
            linarith
            simp
          have hm₂ : f (x + (n + 1 - m) * a) = f x := by
            specialize h₈ (x + (n + 1 - m) * a)
            rw [show x + (n + 1 - m) * a + (m + 1) * a = x + (n + 1) * a by ring] at h₈
            rw [show x + (n + 1) * a = x + (m + 1) * a + (n + 1 - m) * a by ring] at h₈
            rw [add_comm] at h₈
            apply h₈
            linarith
          rw [hm₁, hm₂]
      linarith
    · push_neg at h
      rw [Set.not_exists] at h
      simp at h
      have h₁₀ : f (x + b) = f x := by
        specialize h₈ x
        simp at h₈
        rcases h₈ with ⟨N, h₈⟩
        have h₁₁ : b ≥ N := by
          simp [b]
          constructor
          · linarith
          · simp
            intro n hn
            specialize h₈ x n
            specialize h₁ (x + n * a)
            rw [h₈, add_comm] at h₁
            linarith
        specialize h₈ x (b - N)
        simp at h₈
        rw [show b - N = (b - N).natAbs by simp] at h₈
        exact h₈
      exact h₁₀

  -- Show that the number b is a positive real number.
  have h₁₁ : ∃ b₀ : ℝ, 0 < b₀ ∧ ∀ x, f (x + b₀) = f x := by
    use b
    constructor
    · exact h₉
    · exact h₁₀

  -- Show that $b$ is the least such number.
  have h₁₂ : ∀ b' : ℝ, 0 < b' → ∀ x, f (x + b') = f x → b' ≥ b := by
    intro b' hb' h₁₂
    by_contra! h₁₂'
    specialize h₈ x
    simp at h₈
    rcases h₈ with ⟨N, h₈⟩
    have h₁₃ : b ≥ N := by
      simp [b]
      constructor
      · linarith
      · simp
        intro n hn
        specialize h₈ x n
        specialize h₁₂ (x + n * a)
        rw [h₈, add_comm] at h₁₂
        linarith
    specialize h₈ x (b' - N)
    simp at h₈
    rw [show b' - N = (b' - N).natAbs by simp] at h₈
    linarith

  -- Conclude that $b$ is the least element of the set.
  exact ⟨b, h₉, h₁₀⟩
```