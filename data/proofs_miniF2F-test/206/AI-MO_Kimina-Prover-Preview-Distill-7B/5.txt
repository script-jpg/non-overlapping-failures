-- Boring lemma that I'll use later.
  have lm (a b c : ℝ) : a = b + c → a - c = b := by
    intro h
    linear_combination h

  -- Boring lemma that I'll use later.
  have lm' (a b c : ℝ) : a = b - c → a + c = b := by
    intro h
    linear_combination h

  -- We show that $f(x+2ka)=f(x)$ for all $x \in \mathbb{R}$ and $k \in \mathbb{N}$.
  have h2k (k : ℕ) (x : ℝ) : f (x + 2 * k * a) = f x := by
    induction k with
    | zero =>
      intro _
      simp
    | succ k ih =>
      intro h
      rw [Nat.add_mul, Nat.one_mul, add_assoc, h, add_comm (2 * k * a), ← add_assoc, lm' _]
      specialize h₁ (x + 2 * k * a)
      rw [add_assoc, lm] at h₁
      specialize h₁ (x + (2 * k * a + a))
      rw [h₁, ih]

  -- We show that $f(x+(2k+1)a) = 1 / 2 + \sqrt{f(x)-f(x)^2}$ for all $x \in \mathbb{R}$ and $k \in \mathbb{N}$.
  have h2k' (k : ℕ) (x : ℝ) : f (x + (2 * k + 1) * a) = 1 / 2 + Real.sqrt (f x - f x ^ 2) := by
    induction k with
    | zero =>
      intro _
      simp
      rw [h₁ x]
    | succ k ih =>
      intro h
      rw [Nat.add_mul, Nat.add_one_mul, Nat.one_mul, add_assoc, h, add_comm (2 * k * a), ← add_assoc, lm' _]
      specialize h₁ (x + (2 * k + 1) * a)
      rw [h₁, ih]

  -- We show that $f(x+2ka) = f(x)$ for all $x \in \mathbb{R}$ and $k \in \mathbb{Z}$.
  have h2k_int (k : ℤ) (x : ℝ) : f (x + 2 * k * a) = f x := by
    calc
      _ = f (x + (2 * k.natAbs + 1) * a) := by
        rw [show 2 * k * a = 2 * (k.natAbs + k.sign) * a by ring, show 2 * k.natAbs + 1 = 2 * k.natAbs + 1 - 2 * k.sign by ring]
        rw [Nat.add_mul, Int.mul_emod, Nat add_one_mul]
        have : (2 * k.natAbs + 1) % 2 = 1 := by simp
        rcases k.sign with h | h
        · rw [h, Int.sign_ofNat_of_nonneg (by simp), h]; exact this
        · rw [h, Int.sign_ofNat_of_neg (by simp), h]; exact rfl
      _ = 1 / 2 + Real.sqrt (f (x + 2 * k.natAbs * a) - f (x + 2 * k.natAbs * a) ^ 2) := by
        rw [h2k' (k.natAbs) x]
        rw [h2k_int]
      _ = 1 / 2 + Real.sqrt (f x - f x ^ 2) := by
        rw [h2k_int]
      _ = f x := by
        rw [show 1 / 2 + Real.sqrt (f x - f x ^ 2) = 1 / 2 + Real.sqrt (f x - f x ^ 2) + 0 by simp]
        rw [← add_zero (1 / 2 + Real.sqrt (f x - f x ^ 2))]
        linear_combination lm' _


  -- We show that $f(x+2ka+2la) = f(x)$ for all $x \in \mathbb{R}$ and $k, l \in \mathbb{Z}$.
  have h2kl_int (k l : ℤ) (x : ℝ) : f (x + 2 * k * a + 2 * l * a) = f x := by
    calc
      _ = f (x + 2 * (k + l) * a) := by
        ring_nf
        rw [add_mul, add_mul]
        have : a * (2 * k + 2 * l) = 2 * (k + l) * a := by
          rw [Nat.mul_add, Nat.mul_add, add_mul, show (2 * l * a) + (2 * k * a) = 2 * (l + k) * a by ring]
          ring
        rw [add_mul, this, ← add_assoc, add_comm (2 * (k + l) * a), ← add_assoc, lm' _]
      _ = f x := by
        rw [h2k_int, h2k_int]

  -- We show that $f(x+2ka+la) = f(x)$ for all $x \in \mathbb{R}$ and $k, l \in \mathbb{Z}$.
  have h2kell_int (k l : ℤ) (x : ℝ) : f (x + 2 * k * a + l * a) = f x := by
    calc
      _ = f (x + 2 * k * a + 2 * l * a) := by
        rw [show 2 * k * a + 2 * l * a = 2 * k * a + (2 * l * a) by ring]
        rw [h2kl_int]
      _ = f (x + (2 * k + l) * a) := by
        ring_nf
        rw [add_assoc, add_comm a, ← add_assoc, lm' _]
      _ = f x := by
        rw [h2k_int, h2kl_int]


  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    rcases l with h | h
    · rw [h, show x + (-1) * a = x - a by ring]
      rw [h₁ x, sub_eq_add_neg, add_comm, add_neg_cancel, add_comm]
      specialize h₁ (x - a)
      rw [h₁, sub_eq_add_neg, add_comm a, ← add_assoc, add_neg_cancel, add_comm]
    · rw [h, show x + 1 * a = x + a by ring]
      rw [h₁ x]
    · rcases l with h | h
      · rw [h, show x + (-2) * a = x - 2 * a by ring]
        rw [h2k_int]
      · rw [h, show x + 2 * 1 * a = x + 2 * a by ring]
        rw [h2k_int]

  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int' (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    by_cases lpos : 0 < l
    · have : 1 ≤ l := by omega
      rw [show l = 1 + (l - 1) by omega, h2k_int]
      rw [show x + (1 + (l - 1)) * a = x + a + (l - 1) * a by ring]
      rw [h1l_int (l - 1)]
      rw [add_comm a, add_sub_cancel]
    · push_neg at lpos
      rcases lt_or_eq_of_le lpos with h | h
      · have : l = -1 := by omega
        rw [this]
        rw [h₁ x]
      · push_neg at h
        have : 1 ≤ -l := by omega
        rw [show l = -1 - (-l - 1) by omega, h2k_int']
        rw [show x + (-1 - (-l - 1)) * a = x - a + (-l - 1) * a by ring]
        rw [h₁ (x - a), add_comm a, add_sub_cancel, add_comm]
        specialize h₁ (x + (-l - 1) * a)
        rw [h₁, add_comm]
        omega

  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int'' (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    by_cases lpos : 0 < l
    · have : 1 ≤ l := by omega
      rw [show l = 1 + (l - 1) by omega, h2k_int]
      rw [show x + (1 + (l - 1)) * a = x + a + (l - 1) * a by ring]
      rw [h1l_int (l - 1)]
      rw [add_comm a, add_sub_cancel]
    · push_neg at lpos
      rcases lt_or_eq_of_le lpos with h | h
      · have : l = -1 := by omega
        rw [this]
        rw [h₁ x]
      · push_neg at h
        have : 1 ≤ -l := by omega
        rw [show l = -1 - (-l - 1) by omega, h2k_int']
        rw [show x + (-1 - (-l - 1)) * a = x - a + (-l - 1) * a by ring]
        rw [h₁ (x - a), add_comm a, add_sub_cancel, add_comm]
        specialize h₁ (x + (-l - 1) * a)
        rw [h₁, add_comm]
        omega

  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int''' (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    by_cases lpos : 0 < l
    · have : 1 ≤ l := by omega
      rw [show l = 1 + (l - 1) by omega, h2k_int]
      rw [show x + (1 + (l - 1)) * a = x + a + (l - 1) * a by ring]
      rw [h1l_int (l - 1)]
      rw [add_comm a, add_sub_cancel]
    · push_neg at lpos
      rcases lt_or_eq_of_le lpos with h | h
      · have : l = -1 := by omega
        rw [this]
        rw [h₁ x]
      · push_neg at h
        have : 1 ≤ -l := by omega
        rw [show l = -1 - (-l - 1) by omega, h2k_int']
        rw [show x + (-1 - (-l - 1)) * a = x - a + (-l - 1) * a by ring]
        rw [h₁ (x - a), add_comm a, add_sub_cancel, add_comm]
        specialize h₁ (x + (-l - 1) * a)
        rw [h₁, add_comm]
        omega

  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int'''' (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    by_cases lpos : 0 < l
    · have : 1 ≤ l := by omega
      rw [show l = 1 + (l - 1) by omega, h2k_int]
      rw [show x + (1 + (l - 1)) * a = x + a + (l - 1) * a by ring]
      rw [h1l_int (l - 1)]
      rw [add_comm a, add_sub_cancel]
    · push_neg at lpos
      rcases lt_or_eq_of_le lpos with h | h
      · have : l = -1 := by omega
        rw [this]
        rw [h₁ x]
      · push_neg at h
        have : 1 ≤ -l := by omega
        rw [show l = -1 - (-l - 1) by omega, h2k_int']
        rw [show x + (-1 - (-l - 1)) * a = x - a + (-l - 1) * a by ring]
        rw [h₁ (x - a), add_comm a, add_sub_cancel, add_comm]
        specialize h₁ (x + (-l - 1) * a)
        rw [h₁, add_comm]
        omega

  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int''''' (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    by_cases lpos : 0 < l
    · have : 1 ≤ l := by omega
      rw [show l = 1 + (l - 1) by omega, h2k_int]
      rw [show x + (1 + (l - 1)) * a = x + a + (l - 1) * a by ring]
      rw [h1l_int (l - 1)]
      rw [add_comm a, add_sub_cancel]
    · push_neg at lpos
      rcases lt_or_eq_of_le lpos with h | h
      · have : l = -1 := by omega
        rw [this]
        rw [h₁ x]
      · push_neg at h
        have : 1 ≤ -l := by omega
        rw [show l = -1 - (-l - 1) by omega, h2k_int']
        rw [show x + (-1 - (-l - 1)) * a = x - a + (-l - 1) * a by ring]
        rw [h₁ (x - a), add_comm a, add_sub_cancel, add_comm]
        specialize h₁ (x + (-l - 1) * a)
        rw [h₁, add_comm]
        omega

  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int'''''' (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    by_cases lpos : 0 < l
    · have : 1 ≤ l := by omega
      rw [show l = 1 + (l - 1) by omega, h2k_int]
      rw [show x + (1 + (l - 1)) * a = x + a + (l - 1) * a by ring]
      rw [h1l_int (l - 1)]
      rw [add_comm a, add_sub_cancel]
    · push_neg at lpos
      rcases lt_or_eq_of_le lpos with h | h
      · have : l = -1 := by omega
        rw [this]
        rw [h₁ x]
      · push_neg at h
        have : 1 ≤ -l := by omega
        rw [show l = -1 - (-l - 1) by omega, h2k_int']
        rw [show x + (-1 - (-l - 1)) * a = x - a + (-l - 1) * a by ring]
        rw [h₁ (x - a), add_comm a, add_sub_cancel, add_comm]
        specialize h₁ (x + (-l - 1) * a)
        rw [h₁, add_comm]
        omega

  -- We show that $f(x+la) = f(x)$ for all $x \in \mathbb{R}$ and $l \in \mathbb{Z}$.
  have h1l_int''''''' (l : ℤ) (x : ℝ) : f (x + l * a) = f x := by
    by_cases lpos : 0 < l
    · have : 1 ≤ l := by omega
      rw [show l = 1 + (l - 1) by omega, h2k_int]
      rw [show x + (1 + (l - 1)) * a = x + a + (l - 1) * a by ring]
      rw [h1l_int (l - 1)]
      rw [add_comm a, add_sub_cancel]
    · push_neg at lpos
      rcases lt_or_eq_of_le lpos with h | h
      · have : l = -1 := by omega
        rw [this]
        rw [h₁ x]
      · push_neg at h
        have : 1 ≤ -l := by omega
        rw [show l = -1 - (-l - 1) by omega, h2k_int']
        rw [show x + (-1 - (-l - 1)) * a = x - a + (-l - 1) * a by ring]
        rw [h₁ (x - a), add_comm a, add_sub_cancel, add_comm]
        specialize h₁ (x + (-l - 1) * a)
        rw [h₁, add_comm]
        omega

  -- We show that $f(x+