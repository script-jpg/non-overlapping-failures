-- Let $p, q, r$ be integers with $1 < p < q < r$. Show that if $(p - 1) (q - 1) (r - 1)$ divides $pqr - 1$, then $(p, q, r) = (2, 4, 8)$ or $(p, q, r) = (3, 5, 15)$.

  -- https://artofproblemsolving.com/wiki/index.php/1992IMOProblem1

  -- 1.1.1992年国际数学奥林匹克问题1

  have h₂ : p - 1 ∣ p * q * r - 1
    := Dvd.dvd.mul_left (Int.dvd_refl _) (Int.dvd_trans (Int.dvd_mul_left (p - 1) (q - 1)) h₁)
  have h₃ : q - 1 ∣ p * q * r - 1
    := Dvd.dvd.mul_left (Int.dvd_refl _) (Int.dvd_trans (Int.dvd_mul_left (q - 1) (p - 1)) h₁)
  have h₄ : r - 1 ∣ p * q * r - 1
    := Dvd.dvd.mul_left (Int.dvd_refl _) (Int.dvd_trans (Int.dvd_mul_left (r - 1) (p - 1)) h₁)

  have h₅ : p - 1 ∣ (p - 1) * (q - 1) * (r - 1)
    := Dvd.dvd.mul_left (Int.dvd_refl _) (Dvd.dvd.mul_left (Int.dvd_refl _) (Dvd.dvd.mul_left (Int.dvd_refl _) h₄))
  have h₆ : (q - 1) ∣ (p - 1) * (q - 1) * (r - 1)
    := Dvd.dvd.mul_left (Dvd.dvd.mul_left (Int.dvd_refl _) (Dvd.dvd.mul_left (Int.dvd_refl _) h₄))
  have h₇ : (r - 1) ∣ (p - 1) * (q - 1) * (r - 1)
    := Dvd.dvd.mul_left (Dvd.dvd.mul_left (Dvd.dvd.mul_left (Int.dvd_refl _) h₄))

  have h₈ : p - 1 ∣ p - 1
    := Int.dvd_refl _
  have h₉ : q - 1 ∣ q - 1
    := Int.dvd_refl _
  have h₁₀ : r - 1 ∣ r - 1
    := Int.dvd_refl _

  have g₅ : p - 1 ∣ (p - 1) * (q - 1) * (r - 1) - (p - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (dvd_refl _) (Dvd.dvd.mul_left (dvd_refl _) (Dvd.dvd.mul_left (dvd_refl _) h₄)) h₈)
  have g₆ : (q - 1) ∣ (p - 1) * (q - 1) * (r - 1) - (q - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.mul_left (dvd_refl _) (Dvd.dvd.mul_left (dvd_refl _) h₄)) h₉)
  have g₇ : (r - 1) ∣ (p - 1) * (q - 1) * (r - 1) - (r - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.mul_left (Dvd.dvd.mul_left (dvd_refl _) h₄)) h₁₀)

  have g₈ : p - 1 ∣ (p * q * r - 1) - (p - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (dvd_refl _) (Dvd.dvd.mul_left (dvd_refl _)) h₁)
  have g₉ : (q - 1) ∣ (p * q * r - 1) - (q - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.mul_left (dvd_refl _)) (Dvd.dvd.mul_left (dvd_refl _)) h₁)
  have g₁₀ : (r - 1) ∣ (p * q * r - 1) - (r - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.mul_left (dvd_refl _)) (Dvd.dvd.mul_left (dvd_refl _)) h₁)

  have g₁₁ : p - 1 ∣ ((p * q * r - 1) - (p - 1)) - (p - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (dvd_refl _) (Dvd.dvd.sub_dvd g₈ g₅))
  have g₁₂ : (q - 1) ∣ ((p * q * r - 1) - (q - 1)) - (q - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.sub_dvd g₉ g₆)) (Dvd.dvd.sub_dvd g₉ g₆))
  have g₁₃ : (r - 1) ∣ ((p * q * r - 1) - (r - 1)) - (r - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.sub_dvd g₁₀ g₇)) (Dvd.dvd.sub_dvd g₁₀ g₇))

  have g₁₄ : p - 1 ∣ (p * q * r - 1) - ((p - 1) * (q - 1) * (r - 1)) 
    := Int.dvd_sub (Dvd.dvd.mul_left (dvd_refl _) h₁) h₅
  have g₁₅ : (q - 1) ∣ (p * q * r - 1) - ((p - 1) * (q - 1) * (r - 1))
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.mul_left (dvd_refl _)) h₁) h₆
  have g₁₆ : (r - 1) ∣ (p * q * r - 1) - ((p - 1) * (q - 1) * (r - 1))
    := Int.dvd_sub (Dvd.dvd.mul_left (Dvd.dvd.mul_left (Dvd.dvd.mul_left (dvd_refl _)) h₁) h₇)

  have g₁₇ : (p - 1) * (q - 1) * (r - 1) ∣ (p * q * r - 1) - ((p - 1) * (q - 1) * (r - 1))
    := Int.dvd_sub (Dvd.dvd.mul_left (h₂) (h₃)) h₄
  have g₁₈ : (p - 1) * (q - 1) * (r - 1) ∣ (p - 1) * (q - 1) * (r - 1) - (p - 1) * (q - 1) * (r - 1)
    := Int.dvd_sub (Dvd.dvd.mul_left (h₅) (h₆)) h₇

  have g₁₉ : (p - 1) * (q - 1) * (r - 1) ∣ (p * q * r - 1) - (p - 1) * (q - 1) * (r - 1)
    := Int.dvd_trans g₁₇ g₁₈

  have g₂₀ : (p - 1) * (q - 1) * (r - 1) ∣ (p * q * r - 1) - ((p - 1) * (q - 1) * (r - 1) - (p - 1) * (q - 1) * (r - 1))
    := Int.dvd_sub (Dvd.dvd.mul_left (g₁₄) (g₁₅)) (g₁₆))

  have g₂₁ : (p - 1) * (q - 1) * (r - 1) ∣ ((p * q * r - 1) - ((p - 1) * (q - 1) * (r - 1)) - ((p * q * r - 1) - ((p - 1) * (q - 1) * (r - 1)) - (p - 1) * (q - 1) * (r - 1))) 
    := Int.dvd_sub (Dvd.dvd.mul_left (g₁₄) (g₁₅)) (g₁₆))

  simp at g₂₁


  -- We have $(p - 1) (q - 1) (r - 1) \leq pqr - 1$.
  have g₂₂ : 0 < (p - 1) * (q - 1) * (r - 1) := by
    exact Int.mul_pos (Int.mul_pos (Int.sub_pos_of_lt h₂) (Int.sub_pos_of_lt h₃)) (Int.sub_pos_of_lt h₄)
  have g₂₃ : (p - 1) * (q - 1) * (r - 1) ≤ p * q * r - 1 := by
    apply Int.le_of_dvd
    exact g₂₂
    exact g₁₉

  -- We have $p \leq 4$.
  have g₂₄ : p ≤ 4 := by
    by_contra!
    -- If $p \geq 5$, then $q \geq 6$ and $r \geq 7$.
    have g₂₄: q ≥ 6 := by
      by_contra!
      have g₂₄ : q ≤ 5 := by omega
      have g₂₅ : q - 1 ≤ 4 := by omega
      have g₂₆ : (p - 1) * (q - 1) ≤ 4 * 4 := by
        apply Int.mul_le_mul
        · exact Int.sub_le_self _ 
        · exact g₂₅
        · exact g₂₅
        · exact Int.sub_le_self _
      have g₂₇ : (p - 1) * (q - 1) * (r - 1) ≤ 4 * 4 * 6 := by
        apply Int.mul_le_mul
        · exact g₂₆
        · exact Int.sub_le_self _
        · exact g₂₅
        · exact Int.sub_le_self _
      simp at g₂₇
      -- We have $pqr - 1 \leq 96$.
      have g₂₈: p * q * r - 1 ≤ 95 := by
        apply Int.sub_le_sub_left
        apply Int.mul_le_mul
        · exact Int.sub_le_self _ 
        · exact g₂₇
        · exact Int.sub_le_self _
        · exact Int.sub_le_self _
      simp at g₂₈
      -- We have $p - 1 \geq 4$.
      have g₂₉ : p - 1 ≥ 4 := by omega
      -- We have $p - 1 \mid pqr - 1$.
      have g₃₀ := Dvd.intro (r - 1) h₁
      simp at g₃₀
      -- We have $p - 1 \mid 96$.
      have g₃₁ : p - 1 ∣ 95 + 1 := by
        apply Int.dvd_add
        · exact g₃₀
        · exact g₂₈
      -- So $p - 1$ is a divisor of $96$.
      replace g₃₁ : p - 1 ∈ (96).divisors := by
        simp [Nat.divisors]
        refine ⟨(Int.ofNat_div_dvd _ _).symm, (Int.ofNat_dvd_of_dvd_add _ _ _).symm, rfl⟩
      -- But the divisors of $96$ are $1, 2, 3, 4, 6, 8, 12, 16, 24, 32, 48, 96$.
      have g₃₂ : (96 : ℕ).divisors = {1, 2, 3, 4, 6, 8, 12, 16, 24, 32, 48, 96} := by rfl
      rw [g₃₂] at g₃₁
      simp at g₃₁
      -- So $p - 1 \in \{1, 2, 3, 4, 6, 8, 12, 16, 24, 32, 48, 96\}$.
      replace g₃₁ : p - 1 ∈ ({1, 2, 3, 4, 6, 8, 12, 16, 24, 32, 48, 96} : Finset ℤ) := by
        simp
        exact g₃₁
      -- Since $p - 1 \geq 4$, we have $p - 1 \in \{4, 6, 8, 12, 16, 24, 32, 48, 96\}$.
      have g₃₃ : p - 1 ∈ ({4, 6, 8, 12, 16, 24, 32, 48, 96} : Finset ℤ) := by
        simp
        exact g₃₁
        -- We have $p - 1 \leq 95$.
        have g₂₈ : p - 1 ≤ 95 := by omega
        -- So $p - 1 \in \{4, 6, 8, 12, 16, 24, 32, 48, 96\}$.
        interval_cases p - 1 <;> simp at g₂₈ <;> tauto
      -- So $p \in \{5, 7, 9, 13, 17, 25, 33, 49, 97\}$.
      have g₃₄ : p ∈ ({5, 7, 9, 13, 17, 25, 33, 49, 97} : Finset ℤ) := by
        simp
        omega
      -- These values of $p$ are impossible.
      simp at g₃₄
      rcases g₃₄ with (rfl | rfl | rfl | rfl | rfl | rfl | rfl | rfl | rfl)
      all_goals (
        -- If $p = 5$, we have $q \geq 6$ and $r \geq 7$.
        have g₂₄: q ≥ 6 := by
          by_contra!
          have g₂₄ : q ≤ 5 := by omega
          have g₂₅ : q - 1 ≤ 4 := by omega
          have g₂₆ : (p - 1) * (q - 1) ≤ 4 * 4 := by
            apply Int.mul_le_mul
            · exact Int.sub_le_self _ 
            · exact g₂₅
            · exact g₂₅
            · exact Int.sub_le_self _
          have g₂₇ : (p - 1) * (q - 1) * (r - 1) ≤ 4 * 4 * 6 := by
            apply Int.mul_le_mul
            · exact g₂₆
            · exact Int.sub_le_self _
            · exact g₂₅
            · exact Int.sub_le_self _
          simp at g₂₇
          -- We have $pqr - 1 \leq 96$.
          have g₂₈: p * q * r - 1 ≤ 95 := by
            apply Int.sub_le_sub_left
            apply Int.mul_le_mul
            · exact Int.sub_le_self _ 
            · exact g₂₇
            · exact Int.sub_le_self _
            · exact Int.sub_le_self _
          -- A contradiction is derived.
          simp at g₂₈
          have g₂₉ : r ≥ 7 := by
            by_contra!
            have g₂₉ : r ≤ 6 := by omega
            have g₃₀ : r - 1 ≤ 5 := by omega
            have g₃₁ : (p - 1) * (q - 1) * (r - 1) ≤ 4 * 5 * 5 := by
              apply Int.mul_le_mul
              · exact g₂₆
              · exact Int.sub_le_self _
              · exact g₂₅
              · exact g₃₀
            simp at g₃₁
            have g₃₂ : p * q * r - 1 ≤ 95 := by
              apply Int.sub_le_sub_left
              apply Int.mul_le_mul
              · exact Int.sub_le_self _ 
              · exact g₃₁
              · exact Int.sub_le_self _
              · exact Int.sub_le_self _
            linarith
          -- A contradiction is derived.
          have g₃₃ : (r - 1) * (q - 1) ≤ 25 := by
            rw [show (4 * 5 * 5 : ℤ) = (100 : ℤ) by omega] at g₃₁
            apply Int.mul_le_mul
            · exact Int.sub_le_self _ 
            · exact g₃₂
            · exact g₃