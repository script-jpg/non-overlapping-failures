-- Let $p, q, r$ be integers with $1 < p < q < r$. Show that if $(p - 1) (q - 1) (r - 1)$ divides $pqr - 1$, then $(p, q, r) = (2, 4, 8)$ or $(p, q, r) = (3, 5, 15)$.

  -- Need to prove that $p = 2 \or p = 3$.

  have h₂ : p = 2 ∨ p = 3 := by

    -- The condition that $(p - 1) (q - 1) (r - 1)$ divides $pqr - 1$ is equivalent to that $(p - 1) (q - 1) (r - 1)$ divides $pqr - 1 - p(p - 1)(q - 1)(r - 1)$.

    have h₂ (a b c : ℤ) (h : a ≠ 0) (h₃ : a * b * c ∣ d) :
      a * b * c ∣ d - a * (b - 1) * (c - 1) := by
      rw [sub_eq_add_neg]
      exact Int.dvd_add (Dvd.dvd.sub h₃ (Int.dvd_mul_left a b)) (Int.dvd_mul_left a (b - 1) (c - 1))
    have h₃ := h₂ _ _ _ (by omega) h₁
    rw [show p * q * r - 1 - (p - 1) * (q - 1) * (r - 1) = p + q + r - 3 by ring] at h₃

    -- Since $p < q < r$, we have $p - 1 < q - 1 < r - 1$.

    have h₄ : p - 1 < q - 1 ∧ q - 1 < r - 1 := by
      constructor
      omega
      omega

    -- We have $p - 1 \mid q + r + p - 3$ since $(p - 1) \mid (p + q + r - 3)$.

    have h₅ : p - 1 ∣ q + r + p - 3 := by
      apply Int.dvd_of_dvd_mul_left_of_dvd
      omega
      exact h₃
    rcases h₅ with ⟨t, h₅⟩

    -- We have $p - 1 \mid q - 1$ since $p - 1 \mid (q - 1)(t - 1)$.

    have h₆ : p - 1 ∣ q - 1 := by
      have h₆ : p - 1 ∣ (q - 1) * (t - 1) := by
        apply Int.dvd_mul_left
        rw [show q + r + p - 3 = (q - 1) * (t - 1) + p + r - 2 by ring]
        omega
      apply Int.dvd_of_dvd_mul_left_of_dvd at h₆
      exact h₆
      exact h₄.left
    apply exists_eq_mul_right_of_dvd at h₆
    rcases h₆ with ⟨u, h₆⟩

    -- Reducing the equation $(p - 1)u = q - 1$ modulo $p$ gives $u \equiv q - 1 \pmod{p}$.

    have h₇ : u ≡ q - 1 [ZMOD p] := by
      apply Int.ModEq.symm
      apply Int.modEq_of_dvd
      rw [show q - 1 = u * (p - 1) by linarith only [h₆]]
      apply Int.dvd_mul_right

    -- Reducing the equation $(p - 1) t (q - 1) = r + p + q - 2$ modulo $p$ gives $0 \equiv r + p + q - 2 \pmod{p}$.

    have h₈ : 0 ≡ r + p + q - 2 [ZMOD p] := by
      apply Int.ModEq.symm
      apply Int.modEq_of_dvd
      apply Int.dvd_sub
      omega
      apply Int.dvd_add
      omega
      apply Int.dvd_add
      apply Int.dvd_mul_right
      rw [show r + p + q - 2 = (p - 1) * t * (q - 1) + p + q - 2 by ring]
      omega
      apply Int.dvd_mul_right

    -- Since $1 < p$, we have $p \mid r + p + q - 2$ since $0 \equiv r + p + q - 2 \pmod{p}$.

    have h₉ : p ∣ r + p + q - 2 := by
      apply Int.dvd_of_emod_eq_zero
      reduce_mod_char
      exact h₈
    have h₁₀ := Int.dvd_sub h₉ (Int.dvd_refl _)
    rw [show r + p + q - 2 - p = q + r - 2 by ring] at h₁₀

    -- Since $p \mid q + r + p - 3$ and $p \mid p + r + q - 2$, we have $p \mid (q + r + p - 3) - (p + r + q - 2)$ which is $p \mid 1$.

    have h₁₁ : p ∣ 1 := by
      apply Int.dvd_sub
      omega
      omega
      omega
    have h₁₂ := Int.le_of_dvd (by omega) h₁₁
    have h₁₃ : 1 = p := by omega
    rw [h₁₃] at h₄
    rw [h₁₃] at h₅

    -- We have $q = 2t + 1$ and $2(t + 1) = r + 1$.

    have h₁₄ : q = 2 * t + 1 := by
      apply exists_eq_mul_right_of_dvd
      rw [show 1 = 1 * p by omega]
      exact h₄
    have h₁₅ : r + 1 = 2 * (t + 1) := by
      linarith only [h₅]

    -- $t$ is odd.

    have h₁₆ : t % 2 = 1 := by
      by_contra!
      have h₁₆ : t % 2 = 0 := by omega
      have h₁₇ : ¬ t % 2 = 0 := by
        refine Nat.not_mod_eq_zero_of_dvd?_?_
        omega
        omega
      contradiction
    have h₁₇ := Int.mod_add_div t 2
    rw [show t % 2 = 1 by omega] at h₁₇
    rw [show t / 2 * 2 = t - 1 by omega] at h₁₇

    -- Let $t = 2s + 1$.

    have h₁₈ : t = 2 * s + 1 := by
      use s
      omega

    -- We have $q = 4s + 3$ and $r = 4s + 4$.

    have h₁₉ : q = 4 * s + 3 := by
      rw [h₁₈] at h₁₄
      linarith only [h₁₄]
    have h₂₀ : r = 4 * s + 4 := by
      rw [h₁₈] at h₁₅
      linarith only [h₁₅]

    -- $s \geq 0$.

    have h₂₁ : s ≥ 0 := by
      by_contra!
      have h₂₁ : s < 0 := by omega
      have h₂₂ : s ≤ -1 := by omega
      have h₂₃ : r ≤ 0 := by
        omega
      have h₂₄ : r < 0 := by omega
      have h₂₅ : ¬ r < 0 := by
        exact Int.not_lt_zero_of_le h₂₃
      contradiction

    -- We have $s \leq 2$ since otherwise $r - 1 \geq 4s + 3$.

    have h₂₂ : s ≤ 2 := by
      by_contra!
      have h₂₂ : s > 2 := by omega
      have h₂₃ : r - 1 > 2 := by
        omega
      have h₂₄ : r + p + q - 2 > 2 + 1 + 4 * 3 + 2 - 2 := by
        apply Int.lt_of_sub_lt
        omega
        omega
      have h₂₅ : ¬ r + p + q - 2 > 2 + 1 + 4 * 3 + 2 - 2 := by
        omega
      contradiction

    -- Since $s \geq 0$ and $s \leq 2$, we have $s = 0, 1, 2$.

    have h₂₃ : s = 0 ∨ s = 1 ∨ s = 2 := by omega

    -- We have $p = 2$ or $p = 3$.

    have h₂₄ : p = 2 ∨ p = 3 := by
      rcases h₂₃ with h₂₃ | h₂₃ | h₂₃
     . omega
     . omega
     . omega
    exact h₂₄

  -- Prove that $p = 2 \implies (p, q, r) = (2, 4, 8)$.

  have h₃ (p q r : ℤ) (h : p = 2) :
      (p, q, r) = (2, 4, 8) := by
    have h₃ := h₅ h
    rw [h] at h₃ h₄
    have h₄ : q - 1 = 2 * t := by
      linarith only [h₃]
    have h₅ : 2 * (t - 1) = r - 2 := by
      linarith only [h₄]
    have h₆ : r = 2 * (t + 1) := by
      omega
    have h₇ : q = 2 * (t + 1) := by
      omega
    have h₈ : t = 1 := by
      have h₈ : t > 0 := by
        by_contra!
        have h₈ : t ≤ 0 := by omega
        have h₉ : q - 1 ≤ 0 := by
          omega
        have h₁₀ : q - 1 < 0 := by omega
        have h₁₁ : ¬ q - 1 < 0 := by
          exact Int.not_lt_zero_of_le h₉
        contradiction
      by_contra!
      have h₁₀ : t ≥ 2 := by omega
      have h₁₁ : r - 2 ≥ 2 * (2 + 1) := by
        omega
      have h₁₂ : r - 2 < 2 * (2 + 1) := by
        omega
      have h₁₃ : ¬ r - 2 < 2 * (2 + 1) := by
        exact Int.not_lt_zero_of_le h₁₁
      contradiction
    have h₉ : t = 2 := by omega
    have h₁₀ : t = 3 := by omega
    omega

  -- Prove that $p = 3 \implies (p, q, r) = (3, 5, 15)$.

  have h₄ (p q r : ℤ) (h : p = 3) :
      (p, q, r) = (3, 5, 15) := by
    have h₃ := h₅ h
    rw [h] at h₃ h₄
    have h₄ : q - 1 = 3 * t := by
      linarith only [h₃]
    have h₅ : 3 * (t - 1) = r - 3 := by
      linarith only [h₄]
    have h₆ : r = 3 * (t + 1) := by
      omega
    have h₇ : q = 3 * (t + 1) := by
      omega
    have h₈ : t = 1 := by
      have h₈ : t > 0 := by
        by_contra!
        have h₈ : t ≤ 0 := by omega
        have h₉ : q - 1 ≤ 0 := by
          omega
        have h₁₀ : q - 1 < 0 := by omega
        have h₁₁ : ¬ q - 1 < 0 := by
          exact Int.not_lt_zero_of_le h₈
        contradiction
      by_contra!
      have h₁₀ : t ≥ 2 := by omega
      have h₁₁ : r - 3 ≥ 3 * (2 + 1) := by
        omega
      have h₁₂ : r - 3 < 3 * (2 + 1) := by
        omega
      have h₁₃ : ¬ r - 3 < 3 * (2 + 1) := by
        exact Int.not_lt_zero_of_le h₁₁
      contradiction
    have h₉ : t = 2 := by omega
    have h₁₀ : t = 4 := by omega
    omega

  -- Combined, the above two lemmas show that $(p, q, r) = (2, 4, 8) \or (p, q, r) = (3, 5, 15)$.

  rcases h₂ with h₂ | h₂
 . left
    exact h₃ _ _ _
 . right
    exact h₄ _ _ _
```