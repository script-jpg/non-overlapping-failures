have hp : 2 ≤ p + 1 := by linarith
  have hq : 2 ≤ q + 1 := by linarith
  have hr : 2 ≤ r + 1 := by linarith

  have hpq : (p + 1) * (q + 1) * (r + 1) = p * q * r + (p + 1) * (q + 1) + (p + 1) + (q + 1) + (r + 1) - 1 := by
    ring_nf

  -- Let $p, q, r$ be integers with $1 < p < q < r$. Show that if $(p - 1) (q - 1) (r - 1)$ divides $pqr - 1$, then $(p, q, r) = (2, 4, 8)$ or $(p, q, r) = (3, 5, 15)$.

  -- We have $p + 1$ and $q + 1$ and $r + 1$ all greater than zero.
  have hp' : 1 ≤ p + 1 := by linarith
  have hq' : 1 ≤ q + 1 := by linarith
  have hr' : 1 ≤ r + 1 := by linarith

  have hpq' : 1 ≤ p + 1 * (q + 1) * (r + 1) := by
    apply one_le_mul hp'
    apply one_le_mul hq'
    apply one_le_mul hr'

  -- We can rewrite the divisibility condition in terms of $p + 1$, $q + 1$, $r + 1$.
  have h₂ : (p + 1) * (q + 1) * (r + 1) - (p + 1) - (q + 1) - (r + 1) + 1 = (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) := by
    ring_nf

  have h₃ : (p + 1) * (q + 1) * (r + 1) - (p + 1) - (q + 1) - (r + 1) + 1 ∣ p * q * r + (p + 1) * (q + 1) + (p + 1) + (q + 1) + (r + 1) - 1 - (p * q * r - 1) := by
    apply dvd_sub
    · apply dvd_trans h₁
      apply dvd_mul_right
    · exact Int.dvd_sub h₃

  rw [hpq] at h₃

  have h₄ : (p + 1) * (q + 1) * (r + 1) - (p + 1) - (q + 1) - (r + 1) + 1 ∣ (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) := by
    apply dvd_trans h₃
    apply dvd_mul_right

  rw [h₂] at h₄

  -- This means that the prime factorisation of $(p + 1) * (q + 1) * (r + 1) - (p + 1) - (q + 1) - (r + 1) + 1$ is a subset of the prime factorisation of $(p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1)$.
  have h₅ : (p + 1) * (q + 1) * (r + 1) - (p + 1) - (q + 1) - (r + 1) + 1 ≠ 0 := by
    linarith

  have h₆ : (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) ≠ 0 := by
    linarith

  have h₇ : (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) ≠ 1 := by
    linarith

  have h₈ : (p + 1) * (q + 1) * (r + 1) - (p + 1) - (q + 1) - (r + 1) + 1 ≠ 1 := by
    linarith

  have h₉ : Prime (p + 1 - 1) := by
    rw [Nat.prime_def]
    refine ⟨Nat.Prime.two_le?_,?_⟩
    · linarith
    · intro m hm hm' hdiv
      have hdiv : m = 1 ∨ m = p + 1 - 1 := by
        exact (Nat.dvd_prime h₆).mp hdiv
      rcases hdiv with hdiv | hdiv
      · rw [hdiv] at hm'
        exact hm'
      · rw [hdiv]
        exact le_sub_one_of_lt h₀
    · linarith

  have h₁₀ : Prime (q + 1 - 1) := by
    rw [Nat.prime_def]
    refine ⟨Nat.Prime.two_le?_,?_⟩
    · linarith
    · intro m hm hm' hdiv
      have hdiv : m = 1 ∨ m = q + 1 - 1 := by
        exact (Nat.dvd_prime h₆).mp hdiv
      rcases hdiv with hdiv | hdiv
      · rw [hdiv] at hm'
        exact hm'
      · rw [hdiv]
        exact le_sub_one_of_lt h₀
    · linarith

  have h₁₁ : Prime (r + 1 - 1) := by
    rw [Nat.prime_def]
    refine ⟨Nat.Prime.two_le?_,?_⟩
    · linarith
    · intro m hm hm' hdiv
      have hdiv : m = 1 ∨ m = r + 1 - 1 := by
        exact (Nat.dvd_prime h₆).mp hdiv
      rcases hdiv with hdiv | hdiv
      · rw [hdiv] at hm'
        exact hm'
      · rw [hdiv]
        exact le_sub_one_of_lt h₀
    · linarith

  have hp'' : (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) ≠ 1 := by
    by_contra! h
    have : (p + 1 - 1) * (q + 1 - 1) ≠ 1 := by
      by_contra! h'
      rw [h'] at h
      simp at h
      rw [h] at h₁₁
      contradiction
    have : ¬p ∣ (q + 1 - 1) * (r + 1 - 1) := by
      by_contra! h'
      have : p ∣ (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) := by
        exact Dvd.dvd.mul_left h' (q + 1 - 1) * (r + 1 - 1)
      rw [h] at this
      have : p ∣ p + 1 - 1 := by
        exact Nat.dvd_sub (by linarith) this
      have : p ≤ p + 1 - 1 := by
        exact Nat.le_of_dvd hp' this
      have : p + 1 - 1 + 1 = p := by
        exact Nat.sub_add_cancel hp'
      rw [this] at hp
      linarith
    have : ¬p ∣ q + 1 - 1 := by
      by_contra! h'
      have : p ∣ (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) := by
        exact Dvd.dvd.mul_right h' ((p + 1 - 1) * (r + 1 - 1))
      rw [h] at this
      have : p ∣ p + 1 - 1 := by
        exact Nat.dvd_sub (by linarith) this
      have : p ≤ p + 1 - 1 := by
        exact Nat.le_of_dvd hp' this
      have : p + 1 - 1 + 1 = p := by
        exact Nat.sub_add_cancel hp'
      rw [this] at hp
      linarith
    have : ¬p ∣ r + 1 - 1 := by
      by_contra! h'
      have : p ∣ (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) := by
        exact Dvd.dvd.mul_right (Dvd.dvd.mul_left h' (q + 1 - 1)) (r + 1 - 1)
      rw [h] at this
      have : p ∣ p + 1 - 1 := by
        exact Nat.dvd_sub (by linarith) this
      have : p ≤ p + 1 - 1 := by
        exact Nat.le_of_dvd hp' this
      have : p + 1 - 1 + 1 = p := by
        exact Nat.sub_add_cancel hp'
      rw [this] at hp
      linarith
    have : (r + 1 - 1) * (p + 1 - 1) * (q + 1 - 1) ≠ 1 := by
      by_contra! h'
      have : p ∣ (r + 1 - 1) * (q + 1 - 1) := by
        exact Nat.dvd_of_mul_eq_one_left h'
      rw [h] at this
      have : p ∣ p + 1 - 1 := by
        exact Nat.dvd_sub (by linarith) this
      have : p ≤ p + 1 - 1 := by
        exact Nat.le_of_dvd hp' this
      have : p + 1 - 1 + 1 = p := by
        exact Nat.sub_add_cancel hp'
      rw [this] at hp
      linarith
    rw [h] at h₈
    have : (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) = 1 := by
      calc
        (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) = 1 := h₈
        _ = 1 := h'
    contradiction

  have hp''' : ¬p + 1 - 1 ∣ (q + 1 - 1) * (r + 1 - 1) := by
    by_contra! h'
    have : p ∣ (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) := by
      exact Dvd.dvd.mul_left h' ((p + 1 - 1) * (r + 1 - 1))
    rw [h] at this
    have : p ∣ p + 1 - 1 := by
      exact Nat.dvd_sub (by linarith) this
    have : p ≤ p + 1 - 1 := by
      exact Nat.le_of_dvd hp' this
    have : p + 1 - 1 + 1 = p := by
      exact Nat.sub_add_cancel hp'
    rw [this] at hp
    linarith

  have hp'''' : (p + 1 - 1) * ((q + 1 - 1) * (r + 1 - 1)) ≠ 1 := by
    by_contra! h'
    have : (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) ≠ 1 := by
      rw [h'] at h₈
      contradiction
    contradiction

  rw [h₂] at h₃
  rw [hpq] at h₃
  clear h₄ h₅ h₆ h₇ h₈ h₉ h₁₀ h₁₁ h₂ h₃

  -- We show that $p + 1$ is prime.
  have h₁₂ : ¬p + 1 - 1 ∣ (p + 1 - 1) * ((q + 1 - 1) * (r + 1 - 1)) := by
    by_contra! h'
    have : (p + 1 - 1) * ((q + 1 - 1) * (r + 1 - 1)) ≠ 1 := by
      by_contra! h'
      rw [h'] at h₃
      simp at h₃
      rw [h₃] at h₈
      contradiction
    have : p ∣ (q + 1 - 1) * (r + 1 - 1) := by
      rw [h₁₂] at h'
      exact Nat.dvd_of_mul_eq_one_left h'
    have hp₁ : p ∣ q + 1 - 1 := by
      by_contra! hq₁
      have : p ∣ (q + 1 - 1) * (r + 1 - 1) := by
        exact Dvd.dvd.mul_right hq₁ (r + 1 - 1)
      have : p ∣ p + 1 - 1 := by
        rw [h₁₂] at this
        exact Nat.dvd_sub (by linarith) this
      have : p ≤ p + 1 - 1 := by
        exact Nat.le_of_dvd hp' this
      have : p + 1 - 1 + 1 = p := by
        exact Nat.sub_add_cancel hp'
      rw [this] at hp
      linarith
    have : p ∣ p + 1 - 1 := by
      by_contra! h
      have : p ∣ (p + 1 - 1) * (q + 1 - 1) := by
        exact Dvd.dvd.mul_left h (q + 1 - 1)
      rw [h₁₂] at this
      have : p ∣ p + 1 - 1 := by
        exact Nat.dvd_sub (by linarith) this
      linarith
    have : p + 1 - 1 + 1 = p := by
      exact Nat.sub_add_cancel hp'
    rw [this] at hp
    linarith

  have hp''' : (p + 1 - 1) * ((q + 1 - 1) * (r + 1 - 1)) = (p + 1 - 1) * (q + 1 - 1) * (r + 1 - 1) := by
    ring_nf

  simp only [h₃, Nat.Prime.dvd_mul h₉, Nat.Prime.dvd_mul h₁₁, hp', hp''', hp''''] at h₁₂

  have hp₁ : p + 1 - 1 ∣ q + 1 - 1 := by
    by_contra! hq₁
    have : p + 1 - 1 ∣ (p + 1 - 1) * (r + 1 - 1) := by
      exact Dvd.dvd.mul_left hq₁ (r + 1 - 1)
    have : p + 1 - 1 ∣ q + 1 - 1 := by
      exact Nat.dvd_of_mul_left_dvd h₃ this
    contradiction

  have hp₂ : p + 1 - 1 ∣ r + 1 - 1 := by
    by_contra! hr₁
    have : p + 1 - 1 ∣ (p + 1 - 1) * (q + 1 - 1) := by
      exact Dvd.dvd.mul_left hq₁ (q + 1 - 1)
    have : p + 1 - 1 ∣ r + 1 - 1 := by
      exact Nat.dvd_of_mul_left_dvd h₃ this
    contradiction

  have h₁₃ : p + 1 - 1 = 1 := by
    by_contra! h
    have : p + 1 - 1 ∣ q + 1 - 1 := by
      exact Nat.dvd_of_mul_left_dvd h₃ h
    have : p + 1 - 1 ∣ r + 1 - 1 := by
      exact Nat.dvd_of_mul_left_dvd h₃ h
    have : p + 1 - 1 = 1 ∨ p + 1 - 1 = q + 1 - 1 := by
      exact (Nat.dvd_prime h₉).mp this
    rcases this with this | this
    · exact this
    · have : q + 1 - 1 = 1 := by
        exact Nat.dvd_of_mul_right_eq_one this
      rw [this] at hq
      linarith
  simp at h₁₃

  -- We show that $q + 1$ is prime.
  have h₁₄ : ¬q + 1 - 1 ∣ (p + 1 - 1) * ((q + 1 - 1) * (r + 1 - 1)) := by
    by_contra! h'
    have : (p + 1 - 1) * ((q + 1 - 1) * (r + 1 - 1)) ≠ 1 := by
      by_contra! h'
      rw [h'] at h₃
      simp at h₃
      rw [h₃] at h₈
      contradiction
    have : q ∣ (p + 1 - 1) * (r + 1 - 1) := by
      rw [h₁₄] at h