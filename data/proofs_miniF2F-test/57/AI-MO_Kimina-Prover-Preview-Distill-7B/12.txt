-- Let $p, q, r$ be integers with $1 < p < q < r$. Show that if $(p - 1) (q - 1) (r - 1)$ divides $pqr - 1$, then $(p, q, r) = (2, 4, 8)$ or $(p, q, r) = (3, 5, 15)$.

  have hp₁ : 1 < p := h₀.1
  have hp₂ : p < q := h₀.2.1
  have hq₃ : q < r := h₀.2.2

  -- Show that $p = 2$.
  have hp : p = 2 := by

    -- Assume $p > 2$.
    by_contra hp'
    push_neg at hp'

    -- Obviously $p - 1$ and $p$ are coprime.
    have hp₀ : IsCoprime (p - 1) p := by
      apply IsCoprime_self_sub_left
      simp

    -- Observe that $p - 1 \mid r - 1$.
    have hp₁ : p - 1 ∣ r - 1 := by
      apply dvd_trans _ (show p - 1 ∣ (p - 1) * (q - 1) * (r - 1) by apply dvd_mul_right)
      apply dvd_trans (show (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right) 
      apply dvd_trans (show 1 + (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) + (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right)
      have : 1 + (p - 1) * (q - 1) * (r - 1) + (q - 1) * (r - 1) = p * q * r - 1 := by
        apply Eq.symm
        apply Int.sub_eq_of_eq_add
        ring
      rw [this]
      apply dvd_refl

    -- Observe that $p - 1 \mid q - 1$.
    have hp₂ : p - 1 ∣ q - 1 := by
      apply dvd_trans _ (show p - 1 ∣ (p - 1) * (q - 1) * (r - 1) by apply dvd_mul_right)
      apply dvd_trans (show (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right) 
      apply dvd_trans (show 1 + (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) + (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right)
      have : 1 + (p - 1) * (q - 1) * (r - 1) + (q - 1) * (r - 1) = p * q * r - 1 := by
        apply Eq.symm
        apply Int.sub_eq_of_eq_add
        ring
      rw [this]
      apply dvd_refl

    -- Since $p - 1$ and $p$ are coprime, we have $\gcd (p - 1) (r - 1) = \gcd (p - 1) (q - 1) = 1$.
    have hp₃ : IsCoprime (p - 1) (r - 1) := by
      apply IsCoprime.coprime_dvd_of_dvd_of_dvd
      exact hp₀
      exact hp₁
    have hp₄ : IsCoprime (p - 1) (q - 1) := by
      apply IsCoprime.coprime_dvd_of_dvd_of_dvd
      exact hp₀
      exact hp₂

    -- Therefore, $p - 1$ and $q - 1$ are both powers of 2.
    apply IsCoprime.dvd_of_dvd_of_dvd at hp₃
    apply IsCoprime.dvd_of_dvd_of_dvd at hp₄
    obtain ⟨k, hk⟩ := hp₃
    obtain ⟨l, hl⟩ := hp₄

    -- Since $p - 1$ and $q - 1$ are powers of 2, we have $p - 1 < q - 1$.
    have hp₅ : p - 1 < q - 1 := by
      rw [hk, hl]
      apply Nat.pow_lt_pow_right
      norm_num
      apply Nat.zero_lt_of_ne_zero
      intro m
      rw [← sub_eq_iff_eq_add] at hp'
      intro hp₀
      linarith only [hp₀]
    have hk₀ : k > 0 := by
      apply Nat.pos_of_ne_zero
      by_contra hk₀
      push_neg at hk₀
      rw [hk₀, mul_zero, mul_one] at hk
      omega
    have hl₀ : l > 0 := by
      apply Nat.pos_of_ne_zero
      by_contra hl₀
      push_neg at hl₀
      rw [hl₀, mul_zero, mul_one] at hl
      omega

    -- Since $p - 1$ and $r - 1$ are powers of 2, we have $p - 1 < r - 1$.
    have hp₆ : p - 1 < r - 1 := by
      rw [hk, hl]
      apply Nat.pow_lt_pow_right
      norm_num
      apply Nat.zero_lt_of_ne_zero
      intro m
      rw [← sub_eq_iff_eq_add] at hp'
      intro hp₀
      linarith only [hp₀]
    have hp₇ : q - 1 < r - 1 := by
      rw [hl, hk]
      apply Nat.pow_lt_pow_right
      norm_num
      apply Nat.zero_lt_of_ne_zero
      intro m
      rw [← sub_eq_iff_eq_add] at hp'
      intro hp₀
      linarith only [hp₀]

    -- Note that $q - 1 \mid r - 1$.
    have hl' : q - 1 ∣ r - 1 := by
      apply dvd_trans _ (show q - 1 ∣ (p - 1) * (q - 1) * (r - 1) by apply dvd_mul_right)
      apply dvd_trans (show (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right) 
      apply dvd_trans (show 1 + (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) + (p - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right)
      have : 1 + (p - 1) * (q - 1) * (r - 1) + (p - 1) * (r - 1) = p * q * r - 1 := by
        apply Eq.symm
        apply Int.sub_eq_of_eq_add
        ring
      rw [this]
      apply dvd_refl

    -- Since $q - 1$ and $r - 1$ are powers of 2, we have $q - 1 < r - 1$.
    have hp₈ : q - 1 < r - 1 := by
      rw [hl, hk]
      apply Nat.pow_lt_pow_right
      norm_num
      apply Nat.zero_lt_of_ne_zero
      intro m
      rw [← sub_eq_iff_eq_add] at hp'
      intro hp₀
      linarith only [hp₀]

    -- Note that $q - 1$ and $r - 1$ are both powers of 2, so they are coprime.
    have hl'' : IsCoprime (q - 1) (r - 1) := by
      apply IsCoprime.coprime_dvd_of_dvd_of_dvd
      apply isUnit_iff_eq_one_or_neg_one.mpr
      rw [hl]
      apply Or.inl
      intro m
      apply Nat.eq_one_of_mul_eq_one_left
      rw [← pow_one]
      rw [← pow_add]
      exact hp'
      have : Even (l - 1) := by
        apply Nat.Odd.sub_odd _ hl₀
        apply Nat.odd_one
      obtain ⟨a, ha⟩ := this
      rw [ha, ← two_mul] at hl
      rw [hl, mul_assoc, mul_assoc, mul_assoc, pow_mul, pow_mul, pow_mul, pow_mul]
      simp
      apply Nat.pow_left_injective
      norm_num
      apply Nat.one_le_pow
      norm_num
      apply Nat.one_le_pow
      norm_num
      apply Nat.Prime.two_le
      apply Nat.prime_pow
      norm_num
      apply Nat.prime_pow
      norm_num
    have hl''' := IsCoprime.dvd_of_dvd_of_dvd hl'' hl' (show q - 1 ∣ 1 + (p - 1) * (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right)

    -- Since $q - 1$ and $r - 1$ are powers of 2, we have $\gcd (q - 1) (r - 1) = 1$.
    have : IsCoprime (q - 1) (r - 1) := by
      apply IsCoprime.coprime_dvd_of_dvd_of_dvd
      apply isUnit_iff_eq_one_or_neg_one.mpr
      rw [hl]
      apply Or.inl
      intro m
      apply Nat.eq_one_of_mul_eq_one_left
      rw [← pow_one]
      rw [← pow_add]
      exact hp'
      have : Even (l - 1) := by
        apply Nat.Odd.sub_odd _ hl₀
        apply Nat.odd_one
      obtain ⟨a, ha⟩ := this
      rw [ha, ← two_mul] at hl
      rw [hl, mul_assoc, mul_assoc, mul_assoc, mul_assoc, pow_mul, pow_mul, pow_mul, pow_mul]
      simp
      apply Nat.pow_left_injective
      norm_num
      apply Nat.one_le_pow
      norm_num
      apply Nat.one_le_pow
      norm_num
      apply Nat.Prime.two_le
      apply Nat.prime_pow
      norm_num
      apply Nat.prime_pow
      norm_num
    have hl'''' := IsCoprime.dvd_of_dvd_of_dvd this hl hl'

    -- We have $q - 1 < p - 1$ and $p - 1 < q - 1$, which is a contradiction.
    have hp₉ : q - 1 < p - 1 := by
      rw [hl, hk]
      apply Nat.pow_lt_pow_right
      norm_num
      apply Nat.zero_lt_of_ne_zero
      intro m
      rw [← sub_eq_iff_eq_add] at hp'
      intro hp₀
      linarith only [hp₀]
    linarith only [hp₉, hp₅]

  -- Show that $q = 2 p$.
  have hq : q = 2 * p := by
    -- Assume $q \neq 2 p$.
    by_contra hq'
    push_neg at hq'

    -- Note that $q - 1 \mid p$.
    have hq₁ : q - 1 ∣ p := by
      apply dvd_trans _ (show q - 1 ∣ (p - 1) * (q - 1) * (r - 1) by apply dvd_mul_right)
      rw [show 1 + (p - 1) * (q - 1) * (r - 1) + (p - 1) * (r - 1) = p * q * r - 1 by apply Eq.symm; apply Int.sub_eq_of_eq_add; ring]
      apply dvd_refl

    -- Since $q - 1 \mid p$, we have $q - 1 < p$.
    have hq₂ : q - 1 < p := by
      apply Nat.lt_of_dvd at hq₁
      apply Nat.le_of_lt_succ at hq₁
      linarith only [hq₁]
      intro hp₀
      rw [hp₀] at hq'
      omega

    -- Note that $p - 1 \mid q$.
    have hp₁ : p - 1 ∣ q := by
      apply dvd_trans _ (show p - 1 ∣ (p - 1) * (q - 1) * (r - 1) by apply dvd_mul_right)
      rw [show 1 + (p - 1) * (q - 1) * (r - 1) + (q - 1) * (r - 1) = p * q * r - 1 by apply Eq.symm; apply Int.sub_eq_of_eq_add; ring]
      apply dvd_refl

    -- Since $p - 1 \mid q$, we have $p - 1 < q$.
    have hp₂ : p - 1 < q := by
      apply Nat.lt_of_dvd at hp₁
      apply Nat.le_of_lt_succ at hp₁
      linarith only [hp₁]
      intro hq₀
      rw [hq₀] at hq'
      omega

    -- Note that $p - 1 \mid r - 1$.
    have hp₃ : p - 1 ∣ r - 1 := by
      apply dvd_trans _ (show p - 1 ∣ (p - 1) * (q - 1) * (r - 1) by apply dvd_mul_right)
      apply dvd_trans (show (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right) 
      apply dvd_trans (show 1 + (p - 1) * (q - 1) * (r - 1) ∣ 1 + (p - 1) * (q - 1) * (r - 1) + (q - 1) * (r - 1) by apply dvd_add; simp; apply dvd_mul_right)
      have : 1 + (p - 1) * (q - 1) * (r - 1) + (q - 1) * (r - 1) = p * q * r - 1 := by
        apply Eq.symm
        apply Int.sub_eq_of_eq_add
        ring
      rw [this]
      apply dvd_refl

    -- Since $p - 1$ and $r - 1$ are powers of 2, we have $p - 1 < r - 1$.
    have hp₄ : p - 1 < r - 1 := by
      rw [show p - 1 = 2 ^ k by rw [hk]; apply pow_lt_pow_iff_right; norm_num; linarith only [hp₀]; linarith only [hp₀]] at hp₃
      rw [show r - 1 = 2 ^ (k + 1) by rw [hl]; apply pow_lt_pow_iff_right; norm_num; linarith only [hp₀]; linarith only [hp₀]] at hp₃
      apply Nat.pow_lt_pow_right
      linarith only [hp₃]
      apply Nat.zero_lt_of_ne_zero
      intro m
      rw [← sub_eq_iff_eq_add] at hp'
      intro hp₀
      linarith only [hp₀]
    have hp₅ : q - 1 < r - 1 := by
      rw [show q - 1 = 2 ^ (k + 1) by rw [hl]; apply pow_lt_pow_iff_right; norm_num; linarith only [hp₀]; linarith only [hp₀]] at hq₁
      rw [show r - 1 = 2 ^ (k + 1) by rw [hl]; apply pow_lt_pow_iff_right; norm_num; linarith only [hp₀]; linarith only [hp₀]] at hq₁
      apply Nat.pow_lt_pow_right
      linarith only [hq₁]
      apply Nat.zero_lt_of_ne_zero
      intro m
      rw [← sub_eq_iff_eq_add] at hq'
      intro hq₀
      linarith only [hq₀]

    -- Since $q - 1 \mid r - 1$, we have $q - 1 < r - 1$.
    have hq₃ : q - 1 < r - 1 := by
      apply Nat.lt_of_dvd at hp₃
      apply Nat.le_of_lt_succ at hp₃
      linarith only [hp₃]
      intro hr₀
      rw [hr₀] at hq'
      omega

    -- Note that $q - 1$ and $r - 1$ are powers of 2, so they are coprime.
    have hp₆ : IsCoprime (q - 1) (r - 1) := by
      apply IsCoprime.coprime_dvd_of_dvd_of_dvd
      apply isUnit_iff_eq_one_or_neg_one.mpr
      rw [hl]
      apply Or.inl
      intro m
      apply Nat.eq_one_of_mul_eq_one_left
      rw [← pow_one]
      rw [← pow_add]
      exact hp'
      have : Even (l - 1) := by