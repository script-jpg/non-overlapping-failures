-- $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9! = 1^{504} \cdot 2^{480} \cdot 3^{336} \cdot 4^{210} \cdot 5^{84} \cdot 6^{24} \cdot 7^{12} \cdot 8^{6} \cdot 9^{4}$
  have h₁ : ∏ i in Finset.Icc 1 9, i! = 1 ^ 504 * 2 ^ 480 * 3 ^ 336 * 4 ^ 210 * 5 ^ 84 * 6 ^ 24 * 7 ^ 12 * 8 ^ 6 * 9 ^ 4 := by
    have h₁ : 1 ^ 504 * 2 ^ 480 * 3 ^ 336 * 4 ^ 210 * 5 ^ 84 * 6 ^ 24 * 7 ^ 12 * 8 ^ 6 * 9 ^ 4 = 1 ^ 504 * 2 ^ 480 * 3 ^ 336 * (2 ^ 2) ^ 210 * (5 ^ 84) * (2 * 3) ^ 24 * 7 ^ 12 * (2 ^ 3) ^ 6 * (3 ^ 2) ^ 4 := by norm_num
    have h₂ : 1 ^ 504 * 2 ^ 480 * 3 ^ 336 * (2 ^ 2) ^ 210 * (5 ^ 84) * (2 * 3) ^ 24 * 7 ^ 12 * (2 ^ 3) ^ 6 * (3 ^ 2) ^ 4 = 2 ^ (2 * 210 + 1 * 24 + 3 * 6) * 3 ^ (1 * 336 + 1 * 24 + 2 * 4) * 5 ^ 84 * 7 ^ 12 := by
      refine Eq.symm (Nat.mul_right_cancel (2 ^ 1 * 3 ^ 1 * 5 ^ 42 * 7 ^ 6)?_)
      rw [Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc]
      exact rfl
    have h₃ : 2 ^ (2 * 210 + 1 * 24 + 3 * 6) * 3 ^ (1 * 336 + 1 * 24 + 2 * 4) * 5 ^ 84 * 7 ^ 12 = 2 ^ 462 * 3 ^ 364 * 5 ^ 84 * 7 ^ 12 := by norm_num
    have h₄ : 2 ^ 462 * 3 ^ 364 * 5 ^ 84 * 7 ^ 12 = 1 ^ 504 * 2 ^ 480 * 3 ^ 336 * 4 ^ 210 * 5 ^ 84 * 6 ^ 24 * 7 ^ 12 * 8 ^ 6 * 9 ^ 4 := by norm_num
    calc
      _ = 1 ^ 504 * 2 ^ 480 * 3 ^ 336 * (2 ^ 2) ^ 210 * (5 ^ 84) * (2 * 3) ^ 24 * 7 ^ 12 * (2 ^ 3) ^ 6 * (3 ^ 2) ^ 4 := by exact h₁
      _ = 2 ^ (2 * 210 + 1 * 24 + 3 * 6) * 3 ^ (1 * 336 + 1 * 24 + 2 * 4) * 5 ^ 84 * 7 ^ 12 := by exact h₂
      _ = 2 ^ 462 * 3 ^ 364 * 5 ^ 84 * 7 ^ 12 := by exact h₃
      _ = 1 ^ 504 * 2 ^ 480 * 3 ^ 336 * 4 ^ 210 * 5 ^ 84 * 6 ^ 24 * 7 ^ 12 * 8 ^ 6 * 9 ^ 4 := by exact h₄
    -- The exponents of the primes in the factorization of $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$
    _ = 2 ^ 462 * 3 ^ 364 * 5 ^ 84 * 7 ^ 12 := by
      refine Nat.mul_right_cancel (2 ^ 2 * 3 ^ 2 * 5 ^ 42 * 7 ^ 6)?_
      rw [Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc, Nat.mul_assoc]
      exact rfl

  -- A perfect square $m ^ 2$ is a divisor of $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ if and only if
  -- $m$ is divisible by $2 ^{229} \cdot 3 ^{178} \cdot 5 ^{42} \cdot 7 ^{6}$
  have h₂ (m : ℕ) : (∃ k, k ^ 2 = m) ∧ ((m * m) ∣ ∏ i in Finset.Icc 1 9, i!) ↔ 2 ^ 229 * 3 ^ 178 * 5 ^ 42 * 7 ^ 6 ∣ m := by
    constructor
    · intro ⟨⟨k, hk⟩, h⟩
      rw [← h₁] at h
      have h₁ : 2 ^ 462 * 3 ^ 364 * 5 ^ 84 * 7 ^ 12 = 2 ^ (2 * 229 + 1 * 1) * 3 ^ (1 * 364 + 1 * 1) * 5 ^ (1 * 84 + 1 * 1) * 7 ^ (1 * 12 + 1 * 1) := by norm_num
      have h₂ : 2 ^ (2 * 229 + 1 * 1) * 3 ^ (1 * 364 + 1 * 1) * 5 ^ (1 * 84 + 1 * 1) * 7 ^ (1 * 12 + 1 * 1) ∣ 2 ^ (2 * k) * 3 ^ (2 * k) * 5 ^ (2 * k) * 7 ^ (2 * k) := by
        refine Nat.mul_dvd_mul?_?_?_?_
        · rw [Nat.pow_dvd_pow_iff]
          exact Nat.dvd_of_mod_eq_zero rfl
        · rw [Nat.pow_dvd_pow_iff]
          exact Nat.dvd_of_mod_eq_zero rfl
        · rw [Nat.pow_dvd_pow_iff]
          exact Nat.dvd_of_mod_eq_zero rfl
        · rw [Nat.pow_dvd_pow_iff]
          exact Nat.dvd_of_mod_eq_zero rfl
      rw [← h₁] at h₂
      apply Nat.Coprime.mul_dvd_of_dvd_of_dvd (by norm_num) at h₂
      rw [Nat.mul_dvd_mul_iff_left (by norm_num)] at h₂
      simp [← hk] at h₂
      exact h₂
    · intro h
      refine ⟨⟨(2 ^ 229 * 3 ^ 178 * 5 ^ 42 * 7 ^ 6) ^ 2,?_⟩,?_⟩
      · rw [hk, Nat.mul_pow]
        norm_num
      · rw [h₁]
        apply Nat.Coprime.mul_dvd_of_dvd_of_dvd (by norm_num)
        apply Nat.pow_dvd_pow
        rw [← Nat.pow_dvd_pow_iff (by norm_num)]
        exact h
        rfl

  -- The number of perfect square divisors of $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is the
  -- same as the number of divisors of $2 ^{229} \cdot 3 ^{178} \cdot 5 ^{42} \cdot 7 ^{6}$
  have h₃ : S.card = (Finset.filter (fun k ↦ 2 ^ 229 * 3 ^ 178 * 5 ^ 42 * 7 ^ 6 ∣ k) (Finset.Ioi 0)).card := by
    apply Set.ncard_eq_toFinset_card
    rw [← h₀]
    ext k
    simp
    rw [h₂]
    simp
    by_cases hk : k = 0
    · rw [hk]
      simp
      refine ⟨?_,?_⟩
      · rw [hk]
        simp
      · rw [hk]
        simp
    · have hk : 0 < k := by exact Nat.zero_lt_of_ne_zero hk
      rw [h₂]
      simp
      exact ⟨hk, by exact Nat.pos_pow_of_pos 2 hk⟩

  -- This is the same as the number of divisors of $2 ^{229} \cdot 3 ^{178} \cdot 5 ^{42} \cdot 7 ^{6}$
  -- which is $(229 + 1) \cdot (178 + 1) \cdot (42 + 1) \cdot (6 + 1) = 672$
  have h₄ : (Finset.filter (fun k ↦ 2 ^ 229 * 3 ^ 178 * 5 ^ 42 * 7 ^ 6 ∣ k) (Finset.Ioi 0)).card = 672 := by
    have h₄ : (Finset.filter (fun k ↦ 2 ^ 229 * 3 ^ 178 * 5 ^ 42 * 7 ^ 6 ∣ k) (Finset.Ioi 0)) = Finset.map { toFun := fun x ↦ 2 ^ 229 * 3 ^ 178 * 5 ^ 42 * 7 ^ 6 * x, inj' := by intros; rw [mul_eq_mul_left₀]; exact Nat.pos_pow_of_pos 2 (by norm_num) } (Finset.Ioi 0) := by
      ext k
      simp
      constructor
      · intro h
        obtain ⟨a, ha⟩ := h
        use a
        rw [← ha]
        simp
      · intro h
        use k
        rw [h]
        simp
    rw [h₄]
    rw [Set.ncard_eq_toFinset_card]
    rw [Finset.card_map]
    simp

  rw [h₃, h₄]
```