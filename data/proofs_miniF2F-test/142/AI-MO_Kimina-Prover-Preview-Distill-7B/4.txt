-- $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9! = 1^{504} \cdot 2^{504} \cdot 3^{504} \cdot \hdots \cdot 9^{504}$
  have h_factorization : ∏ i in Finset.Icc 1 9, i! =
      1 ^ 504 * 2 ^ 504 * 3 ^ 504 * 4 ^ 504 * 5 ^ 504 * 6 ^ 504 * 7 ^ 504 * 8 ^ 504 * 9 ^ 504 := by
    simp [Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top,
          Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top,
          Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top, Nat.factorial_succ]
    <;> norm_num

  -- A perfect square is a divisor of the product if and only if it is of the form $a^{504}$ for $1 \leq a \leq 9$.
  have h_squares_iff : ∀ k : ℕ, k ∈ S ↔ ∃ a : ℕ, 1 ≤ a ∧ a ^ 504 = k := by
    intro k
    constructor
    · intro hk
      rw [h₀] at hk
      rcases hk with ⟨hkpos, hkdvd⟩
      rw [h_factorization] at hkdvd

      -- A prime number $p$ divides $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ if and only if $p \leq 9$.
      have h_p_dvd_iff_le nine (p : ℕ) (hp : Nat.Prime p) : p ∣ ∏ i ∈ Finset.Icc 1 9, i! ↔ p ≤ 9 := by
        simp [Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top,
              Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top,
              Finset.prod_Icc_succ_top, Finset.prod_Icc_succ_top, Nat.factorial_succ]
        constructor
        · intro h
          rcases h with ⟨i, hi⟩
          simp at hi
          obtain ⟨hi1, hi2⟩ := hi
          have h_le : i ≤ 9 := by
            revert hi1
            revert i
            norm_num
          exact Nat.Prime.dvd_of_dvd_pow hp (Nat.pow_dvd_pow_iff_le_right'.mpr h_le)
        · intro h
          have h_9_le : 9 ≤ 9 := by norm_num
          exact Nat.Prime.dvd_of_dvd_pow hp (Nat.Prime.dvd_factorial hp (by norm_num) h_9_le)

      -- For a prime number $p$, we have $p \mid k$ if and only if $p \mid a$.
      have h_p_dvd_iff (p : ℕ) (hp : Nat.Prime p) : p ∣ k ↔ p ∣ a := by
        forward implication
        · intro h
          have h_factorization' : k = 1 ^ 504 * 2 ^ 504 * 3 ^ 504 * 4 ^ 504 * 5 ^ 504 * 6 ^ 504 * 7 ^ 504 * 8 ^ 504 * 9 ^ 504
            := by rw [h_factorization, h]
          rw [h_factorization'] at h
          rcases h with (⟨c1, hc1⟩ | ⟨c2, hc2⟩ | ⟨c3, hc3⟩ | ⟨c4, hc4⟩ | ⟨c5, hc5⟩ | ⟨c6, hc6⟩ | ⟨c7, hc7⟩ | ⟨c8, hc8⟩ | ⟨c9, hc9⟩)
          · have h_le : c1 ≤ 1 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc1 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c1 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc1
            contradiction
          · have h_le : c2 ≤ 2 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc2 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c2 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc2
            contradiction
          · have h_le : c3 ≤ 3 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc3 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c3 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc3
            contradiction
          · have h_le : c4 ≤ 4 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc4 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c4 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc4
            contradiction
          · have h_le : c5 ≤ 5 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc5 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c5 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc5
            contradiction
          · have h_le : c6 ≤ 6 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc6 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c6 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc6
            contradiction
          · have h_le : c7 ≤ 7 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc7 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c7 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc7
            contradiction
          · have h_le : c8 ≤ 8 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc8 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c8 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc8
            contradiction
          · have h_le : c9 ≤ 9 ^ 504 := by
              apply Nat.le_of_dvd
              exact Nat.dvd_trans hc9 (Nat.dvd_prime_pow hp (by norm_num))
            have h_eq : c9 = 0 := by
              rw [Nat.pow_eq_zero_iff'] at h_le
              exact h_le
            rw [h_eq] at hc9
            contradiction
        · intro h
          have h_9_le : 9 ≤ 9 := by norm_num
          exact Nat.Prime.dvd_of_dvd_pow hp (Nat.Prime.dvd_factorial hp (by norm_num) h_9_le)

      -- A square number $p^2$ divides $k$ if and only if $p^2$ divides $a$.
      have h_p2_dvd_iff (p : ℕ) (hp : Nat.Prime p) : p ^ 2 ∣ k ↔ p ^ 2 ∣ a := by
        constructor
        · intro h
          have h_p_dvd : p ∣ a := by
            rcases h_p_dvd_iff hp with h_p_dvd_iff
            exact h_p_dvd_iff.mp h
          replace h_p_dvd : p ∣ a ^ 504 := by
            rw [Nat.pow_dvd_pow_iff_le_right]
            · exact h_p_dvd
            · norm_num
          have h : p ∣ p ^ 2 := by
            rw [Nat.dvd_prime_pow]
            exact hp
          exact Nat.Prime.dvd_of_dvd_pow hp (Nat.dvd_trans h_p_dvd h)
        · intro h
          have h_p_dvd : p ∣ a ^ 504 := by
            rw [Nat.dvd_prime_pow]
            exact hp
          have h_p_dvd' : p ∣ a := by
            rcases h_p_dvd_iff hp with h_p_dvd_iff
            exact h_p_dvd_iff.mpr h
          exact Nat.Prime.dvd_of_dvd_pow hp (Nat.dvd_trans h_p_dvd' h_p_dvd)

      -- A number $m^2$ is a square divisor of $k$ if and only if $m$ divides $a$.
      have h_m2_dvd_iff (m : ℕ) : m ^ 2 ∣ k ↔ m ∣ a := by
        constructor
        · intro h
          rcases m.even_or_odd with hmeven | hmodd
          · obtain ⟨m', h'm'⟩ := hmeven
            have h'm' : Odd m' := by
              exact hmodd
            rw [h'm'] at h
            rw [Nat.pow_mul, Nat.pow_two] at h
            have h_m'_dvd : m' ∣ a ^ 504 := by
              exact Nat.dvd_trans h h_p_dvd_iff_iff.mpr (Nat.Prime.dvd_of_dvd_pow hp (by norm_num))
            have h_m'_dvd' : m' ∣ a := by
              rcases hmodd with ⟨k, hk⟩
              rw [hk] at h_m'_dvd
              rw [Nat.pow_dvd_pow_iff_le_right]
              · exact h_m'_dvd
              · norm_num
            rw [h''] at h
            rw [Nat.pow_mul, Nat.pow_two]
            exact Nat.Prime.dvd_of_dvd_pow hp (Nat.dvd_trans h_m'_dvd' h_m'_dvd)
          · obtain ⟨m', h'm'⟩ := hmodd
            rw [h'm'] at h
            rw [Nat.pow_mul, Nat.pow_two] at h
            have h_m'_dvd : m' ∣ a ^ 504 := by
              have h_m'_dvd' : m' ∣ a := by
                exact Nat.Prime.dvd_of_dvd_pow hp (Nat.dvd_trans h h_p_dvd_iff_iff.mpr (Nat.Prime.dvd_of_dvd_pow hp (by norm_num)))
              exact Nat.dvd_trans h_m'_dvd' h_m'_dvd
            rw [h''] at h
            rw [Nat.pow_mul, Nat.pow_two]
            exact Nat.Prime.dvd_of_dvd_pow hp (Nat.dvd_trans h_m'_dvd h_m'_dvd')
        · intro h
          rcases m.even_or_odd with hmeven | hmodd
          · obtain ⟨m', h'm'⟩ := hmeven
            have h'm' : Odd m' := by
              exact hmodd
            rw [h'm'] at h
            rw [Nat.pow_mul, Nat.pow_two] at h
            have h_m'_dvd : m' ∣ a := by
              exact Nat.Prime.dvd_of_dvd_pow hp (Nat.dvd_trans h h_p_dvd_iff_iff.mpr (Nat.Prime.dvd_of_dvd_pow hp (by norm_num)))
            have h_m'_dvd' : m' ∣ a ^ 504 := by
              rw [h_m'_dvd]
              rw [Nat.dvd_prime_pow]
              · exact Nat.Prime.dvd_of_dvd_pow hp (by norm_num)
              · norm_num
            rw [h''] at h
            rw [Nat.pow_mul, Nat.pow_two]
            exact Nat.dvd_trans h_m'_dvd' h_m'_dvd
          · obtain ⟨m', h'm'⟩ := hmodd
            rw [h'm'] at h
            rw [Nat.pow_mul, Nat.pow_two] at h
            have h_m'_dvd : m' ∣ a := by
              exact Nat.Prime.dvd_of_dvd_pow hp (Nat.dvd_trans h h_p_dvd_iff_iff.mpr (Nat.Prime.dvd_of_dvd_pow hp (by norm_num)))
            have h_m'_dvd' : m' ∣ a ^ 504 := by
              rw [h_m'_dvd]
              rw [Nat.dvd_prime_pow]
              · exact Nat.Prime.dvd_of_dvd_pow hp (by norm_num)
              · norm_num
            rw [h''] at h
            rw [Nat.pow_mul, Nat.pow_two]
            exact Nat.dvd_trans h_m'_dvd' h_m'_dvd

      -- $k$ is a square if and only if $a = b^2$.
      have h_square : k ∈ S ↔ ∃ b : ℕ, b ^ 2 = k := by
        simp [h₀, h_factorization]
        constructor
        · intro h
          rcases h with ⟨hc1, hc2, hc3, hc4, hc5, hc6, hc7, hc8, hc9⟩
          have h_313 : 313 ∣ a := by
            have h_313_dvd_313 : 313 ∣ 313 ^ 504 := by
              exact Nat.dvd_prime_pow (by norm_num) (by norm_num)
            have h_313_dvd_1 : 313 ∣ 1 ^ 504 := by
              rw [h_c1 := hc1]
              exact Dvd.dvd.mul_left h_313_dvd_313 (313 ^ 504)
            have h_313_dvd_2 : 313 ∣ 2 ^ 504 := by
              rw [h_c2 := hc2]
              exact Dvd.dvd.mul_left h_313_dvd_313 (2 ^ 504)
            have h_313_dvd_3 : 313 ∣ 3 ^ 504 := by
              rw [h_c3 := hc3]
              exact Dvd.dvd.mul_left h_313_dvd_313 (3 ^ 504)
            have h_313_dvd_4 : 313 ∣ 4 ^ 504 := by
              rw [h_c4 := hc4]
              exact Dvd.dvd.mul_left h_313_dvd_313 (4 ^ 504)
            have h_313_dvd_5 : 313 ∣ 5 ^ 504 := by
              rw [h_c5 := hc5]
              exact Dvd.dvd.mul_left h_313_dvd_313 (5 ^ 504)
            have h_313_dvd_6 : 313 ∣ 6 ^ 504 := by
              rw [h_c6 := hc6]
              exact Dvd.dvd.mul_left h_313_dvd_313 (6 ^ 504)
            have h_313_dvd_7 : 313 ∣ 7 ^ 504 := by
              rw [h_c7 := hc7]
              exact Dvd.dvd.mul_left h_313_dvd_313 (7 ^ 504)
            have h_313_dvd_8 : 313 ∣ 8 ^ 504 := by
              rw [h_c8 := hc8]
              exact Dvd.dvd.mul_left h_313_dvd_313 (8 ^ 504)
            have h_313_dvd_9 : 313 ∣ 9 ^ 504 := by
              rw [h_c9 := hc9]
              exact Dvd.dvd.mul_left h_313_dvd_313 (9 ^ 504)
            have h_313_dvd_a : 313 ∣ a := by
              rw [h_a := h_c9']
              exact Nat.dvd_trans h_313_dvd_9 (Nat.dvd_prime_pow (by norm_num) (by norm_num))
            exact h_313_dvd_a
          have h_314 : 314 ∣ a := by
            have h_314_dvd_314 : 314 ∣ 314 ^ 504 := by
              exact Nat.dvd_prime_pow (by norm_num) (by norm_num)
            have h_314_dvd_1 : 314 ∣ 1 ^ 504 := by
              rw [h_c1 := hc1]
              exact Dvd.dvd.mul_left h_314_dvd_314 (314 ^ 504)
            have h_314_dvd_2 : 314 ∣ 2 ^ 504 := by
              rw [h_c2 := hc2]
              exact Dvd.dvd.mul_left h_314_dvd_314 (2 ^ 504)
            have h_314_dvd_3 : 314 ∣ 3 ^ 504 := by
              rw [h_c3 := hc3]