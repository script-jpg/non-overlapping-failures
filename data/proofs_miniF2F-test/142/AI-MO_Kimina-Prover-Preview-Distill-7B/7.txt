-- First, show that $2^0 \cdot 3^0 \cdot 5^0 \cdot 7^0 = 1$.
  have h₁ : ∏ p in {0, 1, 2, 3}, 2 ^ p = 1 := by
    simp

  -- Next, show that the number of $3$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to
  -- $$\sum_{k=1}^9 \left\lfloor \frac{k}{3} \right\rfloor = 126.$$
  have h₂ : ∑ k in Finset.Icc 1 9, ↑(⌊(k : ℤ) / 3⌋ : ℕ) = 126 := by
    simp

  -- Finally, show that the number of $5$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to
  -- $$\sum_{k=1}^9 \left\lfloor \frac{k}{5} \right\rfloor = 72.$$
  have h₃ : ∑ k in Finset.Icc 1 9, ↑(⌊(k : ℤ) / 5⌋ : ℕ) = 72 := by
    simp

  -- Note that if $p$ is a prime number, then the number of $p$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to
  -- $$\sum_{k=1}^9 \left\lfloor \frac{k}{p} \right\rfloor.$$
  have h₄ {p : ℕ} (hp : p.Prime) : ∑ k ∈ Finset.Icc 1 9, ↑(⌊(k : ℤ) / p⌋ : ℕ) = 126 ∨ 72 := by
    by_cases h : p < 2
    · left; exact h₂
    · right; exact h₃

  -- Note that the number of $1$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to the number of
  -- times $1$ appears in the 1st, 2nd, 3rd, \hdots, 9th factors, which is equal to
  -- $$1 \cdot 1 \cdot 1 \cdot 1 \cdot 1 \cdot 1 \cdot 1 \cdot 1 \cdot 1 = 1.$$
  have h₅ : ∏ k in Finset.Icc 1 9, ↑(1 : ℕ) = 1 := by
    simp

  -- Note that the number of $2$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to
  -- $$\sum_{k=1}^9 \left\lfloor \frac{k}{2} \right\rfloor = 36.$$
  have h₆ : ∑ k ∈ Finset.Icc 1 9, ↑(⌊(k : ℤ) / 2⌋ : ℕ) = 36 := by
    simp

  -- Note that the number of $3$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to
  -- $$\sum_{k=1}^9 \left\lfloor \frac{k}{3} \right\rfloor = 126.$$
  have h₇ : ∑ k ∈ Finset.Icc 1 9, ↑(⌊(k : ℤ) / 3⌋ : ℕ) = 126 := by
    simp

  -- Note that the number of $5$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to
  -- $$\sum_{k=1}^9 \left\lfloor \frac{k}{5} \right\rfloor = 72.$$
  have h₈ : ∑ k ∈ Finset.Icc 1 9, ↑(⌊(k : ℤ) / 5⌋ : ℕ) = 72 := by
    simp

  -- Note that the number of $7$ in $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$ is equal to
  -- $$\sum_{k=1}^9 \left\lfloor \frac{k}{7} \right\rfloor = 126.$$
  have h₉ : ∑ k ∈ Finset.Icc 1 9, ↑(⌊(k : ℤ) / 7⌋ : ℕ) = 126 := by
    simp

  -- Note that in the prime factorization of $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$, the exponent of $2$ is $36$,
  -- the exponent of $3$ is $126$, the exponent of $5$ is $72$, and the exponent of $7$ is $126$.
  have h₁₀ :
      (∏ k ∈ Finset.Icc 1 9, k!).factorization 2 = 36 ∧
      (∏ k ∈ Finset.Icc 1 9, k!).factorization 3 = 126 ∧
      (∏ k ∈ Finset.Icc 1 9, k!).factorization 5 = 72 ∧
      (∏ k ∈ Finset.Icc 1 9, k!).factorization 7 = 126 := by
    refine ⟨?_,?_,?_,?_⟩
    · rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ, Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp; rw [Nat.factorial_succ]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      norm_num
    · rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ, Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp; rw [Nat.factorial_succ]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      norm_num
    · rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ, Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp; rw [Nat.factorial_succ]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      norm_num
    · rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ, Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp; rw [Nat.factorial_succ]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      rw [Nat.Prime.factorization_mul (by norm_num) (by rw [Nat.factorial_succ]
        rw [Finset.prod_Icc_succ_top (by norm_num)]; simp)]
      norm_num

  -- Note that $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9! = 2^{36} \cdot 3^{126} \cdot 5^{72} \cdot 7^{126} \cdot \mathrm{other}$,
  -- where $\mathrm{other}$ is the product of all the other prime factors.
  have h₁₁ :
      (∏ k ∈ Finset.Icc 1 9, k!) =
        (2 ^ 36) · (3 ^ 126) · (5 ^ 72) · (7 ^ 126) · ∏ k ∈ Finset.Icc 1 9, k! := by
    symm
    calc _
    _ = ((∏ p ∈ Finset.Icc 1 9, p!).factorization 2) • 2 ^ (∏ p ∈ Finset.Icc 1 9, k!).factorization 2
        * ((∏ p ∈ Finset.Icc 1 9, p!).factorization 3) • 3 ^ ((∏ p ∈ Finset.Icc 1 9, k!).factorization 3)
        * ((∏ p ∈ Finset.Icc 1 9, p!).factorization 5) • 5 ^ ((∏ p ∈ Finset.Icc 1 9, k!).factorization 5)
        * ((∏ p ∈ Finset.Icc 1 9, p!).factorization 7) • 7 ^ ((∏ p ∈ Finset.Icc 1 9, k!).factorization 7)
        * ∏ p ∈ Finset.Icc 1 9, p! := by
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [Finset.prod_Icc_succ_top (by norm_num)]
      rw [h₁]
      rw [h₂]
      rw [h₃]
      rw [h₅]
      simp
    _ = _ := by
      rw [h₁₀.1, h₁₀.2.1, h₁₀.2.2]
      ring

  -- Let $S$ be the set of perfect squares divisors of $1! \cdot 2! \cdot 3! \cdot \hdots \cdot 9!$.
  -- We want to show that $|S| = 672$.
  show S.card = 672

  -- First, we show that $S = \{2^a \cdot 3^b \cdot 5^c \cdot 7^d \mid a < 37 \land b < 63 \land c < 36 \land d < 63\}$.
  have hS : S = Finset.image (fun ⟨a, b, c, d⟩ => (2 ^ a) * (3 ^ b) * (5 ^ c) * (7 ^ d)) {(a, b, c, d) : ℕ × ℕ × ℕ × ℕ | a < 37 ∧ b < 63 ∧ c < 36 ∧ d < 63} := by
    ext k
    simp
    constructor
    · -- Let $k \in S$.
      intro hk
      rcases hk with ⟨h₀, h₁⟩
      have h₂ : k ∣ ∏ i ∈ Finset.Icc 1 9, i! := h₁
      have h₃ : ∏ p ∈ {0, 1, 2, 3}, 2 ^ p ∣ k := by
        rw [h₁, h₅]
        exact h₀
      rw [h₁, h₅, h₁₁] at h₂
      norm_num at h₂ h₃
      rcases h₀ with ⟨a, b, c, d, h₀⟩
      have h₄ : 2 ^ 36 * (3 ^ 126 * (5 ^ 72 * (7 ^ 126 * k.2).factorization 2) * (7 ^ 126 * k.2).factorization 3).factorization 2 = 36 := by
        rw [h₁₀.1, h₁₀.2.1, h₁₀.2.2]
        rw [h₀]
        simp
      have h₅ : 2 ^ 36 * (3 ^ 126 * (5 ^ 72 * (7 ^ 126 * k.2).factorization 2) * (7 ^ 126 * k.2).factorization 3).factorization 3 = 126 := by
        rw [h₁₀.1, h₁₀.2.1, h₁₀.2.2]
        rw [h₀]
        simp
      have h₆ : 2 ^ 36 * (3 ^ 126 * (5 ^ 72 * (7 ^ 126 * k.2).factorization 2) * (7 ^ 126 * k.2).factorization 3).factorization 5 = 72 := by
        rw [h₁₀.1, h₁₀.2.1, h₁₀.2.2]
        rw [h₀]
        simp
      have h₇ : 2 ^ 36 * (3 ^ 126 * (5 ^ 72 * (7 ^ 126 * k.2).factorization 2) * (7 ^ 126 * k.2).factorization 3).factorization 7 = 126 := by
        rw [h₁₀.1, h₁₀.2.1, h₁₀.2.2]
        rw [h₀]
        simp
      have h₈ : (3 ^ 126 * (5 ^ 72 * (7 ^ 126 * k.2).factorization 2) * (7 ^ 126 * k.2).factorization 3).factorization 2 = 0 := by
        rw [h₁₀.1, h₁₀.2.1, h₁₀.2.2]
        rw [h₀]
        simp
      have h₉ : (