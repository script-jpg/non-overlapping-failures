have one_le_n : 1 ≤ n := by linarith

  -- First, prove that $3 ^ (2 ^ n) - 1 \equiv 0 \mod 2 ^ (n + 3)$ for positive integers $n$. -/
  have h₀ : 2 ^ (n + 3) ∣ 3 ^ 2 ^ n - 1 := by
    -- $3 ^ (2 ^ n) - 1$ is even for all positive integers $n$. -/
    induction n with
    | zero => simp_all
    | succ n ih =>
      by_cases h₁ : n = 0
      · simp_all
      · have two_le_n : 2 ≤ n := by omega
        rw [Nat.pow_add, Nat.pow_mul]
        rw [←Nat.pow_add] at ih
        -- We have $3 ^ 2 ^ n \equiv 1 \mod 2 ^ {n + 2}$ and $3 ^ 2 ^ n \equiv 1 \mod 2 ^ {n + 3}$ for $2 \leq n$. -/
        have h₂ : 3 ^ 2 ^ n ≡ 1 [MOD 2 ^ (n + 2)] := by
          exact Nat.ModEq.symm (Nat.modEq_iff_dvd.mpr ih)
        have h₃ : 3 ^ 2 ^ n ≡ 1 [MOD 2 ^ (n + 3)] := by
          exact Nat.ModEq.symm (Nat.modEq_iff_dvd.mpr ih)
        -- We have $3 ^ 2 ^ n \equiv 1 + 2 ^ {n + 2} \mod 2 ^ {n + 3}$ and $3 ^ 2 ^ n \equiv 1 + 2 ^ {n + 3} \mod 2 ^ {n + 4}$. -/
        have h₄ : 3 ^ 2 ^ n = 1 + 2 ^ (n + 2) + (3 ^ 2 ^ n - 1 - 2 ^ (n + 2)) := by omega
        have h₅ : 3 ^ 2 ^ n = 1 + 2 ^ (n + 3) + (3 ^ 2 ^ n - 1 - 2 ^ (n + 3)) := by omega
        rw [h₄, Nat.add_mod, h₃, Nat.zero_add, Nat.mod_mod, Nat.zero_mod, Nat.add_mod, h₂, Nat.zero_add, Nat.mod_mod, Nat.zero_mod]
        -- Then, by induction, $3 ^ 2 ^ n - 1 = (3 ^ 2 ^ {n - 1} - 1) + 2 ^ {n + 1} \equiv 2 ^ n + 2 ^ {n + 1} \equiv 2 ^ {n + 1} (1 + 2) \equiv 3 \cdot 2 ^ {n + 1} \equiv 2 \cdot 2 ^ {n + 1} \equiv 2 ^ {n + 2} \mod 2 ^ {n + 3}$. -/
        replace ih := Nat.ModEq.mul_left (3 : ℕ) ih
        replace ih := Nat.ModEq.trans ih (show 3 * 1 ≡ 3 * (1 + 2 ^ (n + 2)) [MOD 2 ^ (n + 3)] by simp_all)
        replace ih := Nat.ModEq.trans ih (show 3 * (1 + 2 ^ (n + 2)) ≡ (1 + 2 ^ (n + 2)) + 2 * 2 ^ (n + 2) [MOD 2 ^ (n + 3)] by simp_all)
        replace ih := Nat.ModEq.trans ih (show (1 + 2 ^ (n + 2)) + 2 * 2 ^ (n + 2) ≡ 1 + 3 * 2 ^ (n + 2) [MOD 2 ^ (n + 3)] by simp_all)
        suffices 1 + 3 * 2 ^ (n + 2) ≡ 1 + 2 * 2 ^ (n + 2) [MOD 2 ^ (n + 3)] by exact ih.symm.trans this
        apply Nat.ModEq.add_left
        rw [Nat.one_add_sub_one (2 ^ (n + 2))]
        exact Nat.ModEq.mul_left (2 ^ (n + 2)) (show 3 ≡ 2 [MOD 2] by simp_all)
        apply Nat.ModEq.pow
        exact Nat.ModEq.symm (Nat.modEq_iff_dvd.mpr (Nat.dvd_pow_self 2 (by omega)))
      -- Then, by induction, $3 ^ 2 ^ n - 1 = (3 ^ 2 ^ {n - 1} - 1) + 2 ^ {n + 1} \equiv 2 ^ n + 2 ^ {n + 1} \equiv 2 ^ {n + 1} (1 + 2) \equiv 3 \cdot 2 ^ {n + 1} \equiv 2 \cdot 2 ^ {n + 1} \equiv 2 ^ {n + 2} \mod 2 ^ {n + 3}$. -/
    have two_le_n : 2 ≤ n := by omega
    have h₁ : 3 ^ 2 ^ n % 2 ^ (n + 3) = 2 ^ (n + 2) := by
      rw [Nat.pow_add, Nat.pow_mul]
      rw [Nat.pow_add, Nat.pow_mul]
      rw [Nat.pow_add]
      -- We have $3 ^ 2 ^ n \equiv 1 \mod 2 ^ {n + 2}$ and $3 ^ 2 ^ n \equiv 1 \mod 2 ^ {n + 3}$ for $2 \leq n$. -/
      have h₂ : 3 ^ 2 ^ n ≡ 1 [MOD 2 ^ (n + 2)] := by
        exact Nat.ModEq.symm (Nat.modEq_iff_dvd.mpr ih)
      have h₃ : 3 ^ 2 ^ n ≡ 1 [MOD 2 ^ (n + 3)] := by
        exact Nat.ModEq.symm (Nat.modEq_iff_dvd.mpr ih)
      -- We have $3 ^ 2 ^ n \equiv 1 + 2 ^ {n + 2} \mod 2 ^ {n + 3}$ and $3 ^ 2 ^ n \equiv 1 + 2 ^ {n + 3} \mod 2 ^ {n + 4}$. -/
      have h₄ : 3 ^ 2 ^ n = 1 + 2 ^ (n + 2) + (3 ^ 2 ^ n - 1 - 2 ^ (n + 2)) := by omega
      have h₅ : 3 ^ 2 ^ n = 1 + 2 ^ (n + 3) + (3 ^ 2 ^ n - 1 - 2 ^ (n + 3)) := by omega
      rw [h₄, Nat.add_mod, h₃, Nat.zero_add, Nat.mod_mod, Nat.zero_mod, Nat.add_mod, h₂, Nat.zero_add, Nat.mod_mod, Nat.zero_mod]
      -- Then, by induction, $3 ^ 2 ^ n - 1 = (3 ^ 2 ^ {n - 1} - 1) + 2 ^ {n + 1} \equiv 2 ^ n + 2 ^ {n + 1} \equiv 2 ^ {n + 1} (1 + 2) \equiv 3 \cdot 2 ^ {n + 1} \equiv 2 \cdot 2 ^ {n + 1} \equiv 2 ^ {n + 2} \mod 2 ^ {n + 3}$. -/
      replace ih := Nat.ModEq.mul_left (3 : ℕ) ih
      replace ih := Nat.ModEq.trans ih (show 3 * 1 ≡ 3 * (1 + 2 ^ (n + 2)) [MOD 2 ^ (n + 3)] by simp_all)
      replace ih := Nat.ModEq.trans ih (show 3 * (1 + 2 ^ (n + 2)) ≡ (1 + 2 ^ (n + 2)) + 2 * 2 ^ (n + 2) [MOD 2 ^ (n + 3)] by simp_all)
      replace ih := Nat.ModEq.trans ih (show (1 + 2 ^ (n + 2)) + 2 * 2 ^ (n + 2) ≡ 1 + 3 * 2 ^ (n + 2) [MOD 2 ^ (n + 3)] by simp_all)
      suffices 1 + 3 * 2 ^ (n + 2) ≡ 1 + 2 * 2 ^ (n + 2) [MOD 2 ^ (n + 3)] by exact ih.symm.trans this
      apply Nat.ModEq.add_left
      rw [Nat.one_add_sub_one (2 ^ (n + 2))]
      exact Nat.ModEq.mul_left (2 ^ (n + 2)) (show 3 ≡ 2 [MOD 2] by simp_all)
    rw [(Nat.coprime_pow_left_iff (by norm_num) (a := 2 ^ (n + 3)) (b := 3 ^ 2 ^ n - 1) (m := 2 ^ (n + 2)) (by omega)).mp h₀]

  rw [Nat.modEq_iff_dvd.mpr h₀]

  -- Compute the remainder of $3^{2^n} - 1 \equiv 2^{n+2} \mod 2^{n+3}$. -/
  have two_pow_n : 2 ^ (n + 2) < 2 ^ (n + 3) := by
    apply Nat.pow_lt_pow_of_lt
    · omega
    · omega
  rw [←Nat.add_sub_assoc (by omega), ←Nat.add_sub_assoc (by omega), ←Nat.add_sub_assoc (by omega)]
  rw [Nat.add_sub_eq_min]
  have two_pow_n_le : 2 ^ (n + 2) ≤ 2 ^ (n + 3) := by exact Nat.pow_le_pow_of_le_right (by omega)
  rw [two_pow_n, two_pow_n_le, Nat.min_eq_right two_pow_n_le]

```