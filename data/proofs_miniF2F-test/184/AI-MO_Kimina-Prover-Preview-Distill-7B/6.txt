-- Since $2^n \mid 2^{n+3}$, we have $3^{2^n} - 1 \equiv 3^{2^n} - 1 \mod 2^{n+3}$.
  have h1 : (3 ^ 2 ^ n - 1) % (2 ^ (n + 3)) = (3 ^ 2 ^ n - 1) % 2 ^ (n + 3) := by
    rfl

  -- Since $n \geq 1$, we have $2^{n+3} \geq 8$.
  have h2 : 2 ^ (n + 3) ≥ 8 := by
    calc
      2 ^ (n + 3) ≥ 2 ^ (1 + 3) := by
        apply Nat.pow_le_pow_of_le
        simp
        omega
      _ = 16 := by simp

  -- Since $3^2 \equiv 1 \mod 8$, by induction, $3^{2^n} \equiv 1 \mod 2^{n+3}$.
  have h3 : 3 ^ 2 ^ n ≡ 1 [MOD 2 ^ (n + 3)] := by
    have : 3 ^ 2 ^ n ≡ 1 [MOD 8] := by
      induction n with
      | zero => simp
      | succ n ih =>
        rw [pow_add]
        rw [show 2 ^ (n + 1 + 1) = 2 ^ (n + 1) * 2 by simp, pow_mul]
        have : 2 ^ (n + 1) ∣ 2 ^ (n + 1) * 2 := by
          exact dvd_mul_right _ _
        apply Nat.ModEq.mul_right this ih
    have : 2 ^ (n + 3) ≥ 8 := by
      calc
        2 ^ (n + 3) ≥ 2 ^ 4 := by
          apply Nat.pow_le_pow_of_le
          omega
          simp
        _ = 16 := by simp
    apply Nat.ModEq.trans this
    apply Nat.ModEq.pow
    have : 2 ^ (n + 3) = (2 ^ (n + 1 + 1)) := by
      rw [show n + 3 = (n + 1 + 1) + 2 by omega, pow_add]
      ring
    rw [this]
    refine Nat.ModEq.trans?_ ih
    apply Nat.ModEq.mul_right
    omega

  -- Since $3^{2^n} \equiv 1 \mod 2^{n+3}$, $3^{2^n} - 1 \equiv 1 - 1 \equiv 0 \mod 2^{n+3}$.
  have h4 : (3 ^ 2 ^ n - 1) % 2 ^ (n + 3) = 0 := by
    rw [Nat.mod_eq_zero_iff_dvd]
    have : 2 ^ (n + 3) ∣ 3 ^ 2 ^ n - 1 := by
      apply Nat.dvd_sub
      apply Nat.one_le_pow
      omega
      apply h3
    exact this

  -- Since $3^{2^n} - 1 \equiv 0 \mod 2^{n+3}$, $(3^{2^n} - 1) \mod 2^{n+3} = 2^{n+2}$.
  rw [h1, h4]
  omega
```