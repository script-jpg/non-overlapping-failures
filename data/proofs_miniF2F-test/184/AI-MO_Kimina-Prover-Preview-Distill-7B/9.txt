have A (n : ℕ) : (3 ^ 2 ^ n - 1) % 2 ^ (n + 2) = 2 ^ n * 2 := by
    induction n with
    | zero => simp [Nat.zero_pow]
    | succ n ih =>
      rw [pow_add]
      calc
        _ = (3 ^ 2 ^ n - 1) % 2 ^ (n + 2) * 3 ^ 2 ^ n + 2 ^ n * 2 * 2 ^ n * 2 := by
          rw [Nat.mod_add_div]
          have c1 : 3 ^ 2 ^ n ≥ 1 := by
            have : 1 ≤ 2 ^ n := Nat.one_le_two_pow
            apply Nat.one_le_pow_le
            linarith
          have c2 : 2 ^ n * 2 ≤ 2 ^ n * 2 ^ n * 3 := by
            have : 2 ^ n * 2 ≤ 2 ^ n * 2 ^ n := by
              apply Nat.mul_le_mul_right
              apply Nat.pow_le_pow_of_le_right
              linarith
            apply Nat.mul_le_mul_right
            linarith
          have c3 : 2 ^ n * 2 ^ n * 3 < 2 ^ n * 2 ^ (n + 1) := by
            have : 2 ^ n * 2 ^ n * 3 < 2 ^ n * 2 ^ n * 2 ^ 1 := by
              apply Nat.mul_lt_mul_of_pos_right
              decide
              apply Nat.pow_lt_pow_of_lt
              linarith
            apply Nat.mul_lt_mul_of_pos_right
            linarith
          have c4 : 2 ^ n * 2 ^ (n + 1) = 2 ^ (n + 1) * 2 ^ (n + 1) := by
            rw [pow_add, mul_comm]
            ring
          rw [c4, Nat.add_sub_assoc]
          simp only [Nat.reduceAdd, ←Nat.add_sub_assoc, Nat.add_sub_cancel_left]
          simp [ih, c1, c2, c3]
          ring
        _ = 2 ^ n * 2 * 2 := by
          rw [ih]
          ring
        _ = 2 ^ (n + 1) * 2 := by
          ring

  calc
    _ = (3 ^ 2 ^ n - 1) % 2 ^ (n + 2) * 3 ^ 2 ^ n + 2 ^ n * 2 * 2 ^ n * 2 := by
      rw [Nat.mod_add_div]
      have c1 : 3 ^ 2 ^ n ≥ 1 := by
        have : 1 ≤ 2 ^ n := Nat.one_le_two_pow
        apply Nat.one_le_pow_le
        linarith
      have c2 : 2 ^ n * 2 ≤ 2 ^ n * 2 ^ n * 3 := by
        have : 2 ^ n * 2 ≤ 2 ^ n * 2 ^ n := by
          apply Nat.mul_le_mul_right
          apply Nat.pow_le_pow_of_le_right
          linarith
        apply Nat.mul_le_mul_right
        linarith
      have c3 : 2 ^ n * 2 ^ n * 3 < 2 ^ n * 2 ^ (n + 1) := by
        have : 2 ^ n * 2 ^ n * 3 < 2 ^ n * 2 ^ n * 2 ^ 1 := by
          apply Nat.mul_lt_mul_of_pos_right
          decide
          apply Nat.pow_lt_pow_of_lt
          linarith
        apply Nat.mul_lt_mul_of_pos_right
        linarith
      have c4 : 2 ^ n * 2 ^ (n + 1) = 2 ^ (n + 1) * 2 ^ (n + 1) := by
        rw [pow_add, mul_comm]
        ring
      rw [c4, Nat.add_sub_assoc]
      simp only [Nat.reduceAdd, ←Nat.add_sub_assoc, Nat.add_sub_cancel_left]
      simp [A, c1, c2, c3]
      ring
    _ = 2 ^ (n + 2) := by
      rw [A]
      ring
```