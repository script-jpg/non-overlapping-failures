-- All positive integers are equal to 1 or composite
  have h2 : ∀ n : ℕ, 0 < n → n = 1 ∨ (1 < n ∧ ∃ m k : ℕ, 1 < m ∧ 1 < k ∧ m * k = n) := by
    intro n hn
    have h2 : n = 1 ∨ n ≠ 1 := by exact Nat.eq_one_or_ne n
    cases h2 with
    | inl h2 => exact Or.inl h2
    | inr h2 =>
      have h3 : n ≠ 1 := h2
      have h4 : 1 < n := Nat.one_lt_of_ne h3
      exact Or.inr ⟨h4, n, 1, Nat.one_lt_of_ne h3, h4, by exact Nat.mul_one n⟩

  -- If $n$ is composite, then $3 < \frac{d(n)}{\sqrt[3]n} < 3.5$.
  have h3 : ∀ n : ℕ, (1 : ℝ) / 3 < (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) ∧
      (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) < 3.5 := by
    intro n
    have h3 : 0 < (Nat.divisors n).card := by exact Nat.card_pos.mpr (Nat.divisors_pos_iff n.ne_zero).mpr (by linarith)
    have h4 : 0 < n := by linarith
    rcases h2 n h4 with h2 | h2
    · rw [h2]
      simp
      norm_num
    · rw [h2]
      simp
      have h5 : 1 < n := h2.1
      have h6 : n ≠ 0 := by linarith
      have h7 : (Nat.divisors n).card > 0 := by
        apply Nat.card_pos.mpr
        apply Nat.divisors_nonempty_iff.mpr
        exact Nat.zero_lt_of_ne_zero h6
      have h8 : (Nat.divisors n).card ≤ n := by apply Nat.card_divisors_le
      have h9 : n ^ ((1 : ℝ) / 3) > 0 := by exact Nat.pow_pos real_of_pos (by linarith) (1 / 3)
      constructor
      · calc
          (1 : ℝ) / 3 < 1 := by norm_num
          _ < (↑n).natCast / n ^ ((1 : ℝ) / 3) := by
            apply div_lt_div₀
            · exact Nat.cast_pos.mpr h5
            · exact h9
            · exact h9
            · exact Nat.one_lt_pow₀ Real.zero_lt_one (by linarith)
      · calc
          (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) ≤ n / n ^ ((1 : ℝ) / 3) := by
            apply div_le_div_right
            · exact h7
            · exact h9
          _ = n ^ (1 - (1 / 3) : ℝ) := by
            rw [← Real.rpow_sub]
            · field_simp
            · norm_num
            · exact Nat.one_lt_pow₀ Real.zero_lt_one (by linarith)
          _ < 3.5 := by
            have h10 : (n : ℝ) ^ (1 - (1 / 3) : ℝ) < 3.5 := by
              have h10 : (n : ℝ) ^ (1 - (1 / 3) : ℝ) ≤ (3 ^ (1 / (3 : ℝ)) : ℝ) := by
                rw [← Real.rpow_mul]
                · simp
                · apply le_of_lt
                  apply Real.rpow_lt_rpow_of_exponent_lt
                  · norm_num
                  · norm_num
                  · linarith
              have h11 : (3 : ℝ) ^ (1 / (3 : ℝ)) < 3.5 := by
                rw [show (3 : ℝ) ^ (1 / (3 : ℝ)) = Real.exp (Real.log 3 / 3) by rw [Real.rpow_def_of_pos (by norm_num)]]
                rw [Real.exp_lt_exp]
                · simp
                · dsimp
                  rw [Real.log_3]
                  have h11 : Real.log 3 < 1.18 := by
                    have h11 : Real.log 3 < (1.18 : ℝ) := by
                      have h11 : (3 : ℝ) < 3.24 := by norm_num
                      have h12 : (3.24 : ℝ) = exp (Real.log 3.24) := by rw [Real.exp_log]; linarith
                      rw [h12]
                      have h13 : Real.log 3.24 < (1.18 : ℝ) := by
                        have : (3.24 : ℝ) < exp (1.18) := by norm_num
                        rw [exp_lt_exp] at this
                        exact this
                      exact h13
                    exact h11
                  linarith
              linarith
            norm_cast at h10
            linarith
  have h3₁ : ∀ n : ℕ, n ≠ N → (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) < (Nat.divisors N).card / N ^ ((1 : ℝ) / 3) := by
    intro n hn
    specialize h₁ n hn
    specialize h₁ n hn
    specialize h3 n
    have h3₂ : f n < f N := h₁
    rw [h₀ n h4, h₀ N hN] at h3₂
    exact h3₂
  -- Define function $h(n) = f(n) - f(n-1)$
  let h (n : ℕ) := f n - f (n - 1)
  -- If $n$ is composite, then $h(n) < 3.5 - 1 = 2.5$.
  have h4 : ∀ n : ℕ, (1 : ℝ) / 3 < h n ∧ h n < 2.5 := by
    intro n
    have h4 : n - 1 < n := by exact Nat.sub_one_lt (by linarith)
    have h5 : h n < f n := by
      simp only [h]
      rw [Nat.sub_lt_iff_lt_add]
      exact Nat.lt_add_one
    have h6 : f n < f N := by
      specialize h3₁ n (by linarith)
      linarith
    have h7 : f N < f (n - 1) + (f n - f (n - 1)) := by exact Nat.lt_add_of_tsub_lt h6
    have h8 : f n - f (n - 1) = h n := by simp [h]
    have h9 : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) < 3.5 := (h3 n).right
    have h10 : (Nat.divisors (n - 1)).card / (n - 1) ^ ((1 : ℝ) / 3) < 3.5 := (h3 (n - 1)).right
    have h11 : f (n - 1) < f N := by
      have h11 : (Nat.divisors (n - 1)).card / (n - 1) ^ ((1 : ℝ) / 3) < (Nat.divisors N).card / N ^ ((1 : ℝ) / 3) := h3₁ (n - 1) (by linarith)
      rw [h₀ (n - 1) (by linarith), h₀ N hN] at h11
      exact h11
    have h12 : (Nat.divisors N).card / N ^ ((1 : ℝ) / 3) < 3.5 := (h3 N).right
    have h13 : (Nat.divisors (n - 1)).card / (n - 1) ^ ((1 : ℝ) / 3) > 1 := by
      simp
      specialize h3 (n - 1)
      exact (h3 (n - 1)).left
    have h14 : f (n - 1) > 1 := by
      rw [h₀ (n - 1) (by linarith)]
      exact h13
    have h15 : 1 + (1 : ℝ) / 3 < (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) := by linarith
    have h16 : f n > 1 := by
      rw [h₀ n (by linarith)]
      linarith
    have h17 : h n < (f n - 1) + (f (n - 1) - f (n - 1)) := by linarith
    have h18 : f n - 1 < (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) - 1 := by linarith
    have h19 : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) - 1 < 3.5 - 1 := by linarith
    have h20 : 1 + (1 : ℝ) / 3 < (Nat.divisors (n - 1)).card / (n - 1) ^ ((1 : ℝ) / 3) := by linarith
    have h21 : 1 < f (n - 1) := by linarith
    have h22 : (Nat.divisors (n - 1)).card / (n - 1) ^ ((1 : ℝ) / 3) > 1 := by linarith
    have h23 : h n < 2.5 := by linarith
    linarith
  -- If $n$ is composite, then $1 < f(n) - f(n-1) < 2.5$.
  replace h4 : ∀ n : ℕ, (1 : ℝ) / 3 < h n ∧ h n < 2.5 := by
    intro n
    have h4₁ : (1 : ℝ) / 3 < h n := by
      simp only [h]
      specialize h3 n
      have h4₁ : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) > 1 := by
        simp
        specialize h3 n
        exact (h3 n).left
      have h4₂ : f (n - 1) < f n := by
        specialize h3₁ n (by linarith)
        linarith
      rw [h₀ n (by linarith), h₀ (n - 1) (by linarith)] at h4₂
      exact h4₂
    specialize h4 n
    have h4₂ : h n < 2.5 := by
      simp only [h]
      specialize h3 n
      have h4₁ : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) > 1 := by
        simp
        specialize h3 n
        exact (h3 n).left
      have h4₂ : f (n - 1) < f n := by
        specialize h3₁ n (by linarith)
        linarith
      rw [h₀ n (by linarith), h₀ (n - 1) (by linarith)] at h4₂
      linarith
    exact ⟨h4₁, h4₂⟩
  -- If $1 < f(n) - f(n-1) < 2.5$, then $2 < f(n) < 4.5$.
  have h5 : ∀ n : ℕ, f (n - 1) < f n ∧ f n < 4.5 := by
    intro n
    have h5₁ : f (n - 1) < f n := by
      specialize h4 n
      linarith
    have h5₂ : f n < 4.5 := by
      specialize h4 n
      have h5₂ : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) < 3.5 := (h3 n).right
      rw [h₀ n (by linarith)] at h5₂
      linarith
    exact ⟨h5₁, h5₂⟩
  -- If $f(n) < 4.5$, then $n < 22$.
  have h6 : ∀ n : ℕ, f n < 4.5 → n < 22 := by
    intro n hn
    by_contra! h6
    have h6₁ : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) < 4.5 := by
      rw [h₀ n (by linarith)]
      exact hn
    have h6₂ : n ≠ 1 := by
      by_contra! h6₂
      rw [h6₂] at h6
      linarith
    have h6₃ : n > 1 := by exact Nat.one_lt_iff_ne_one.mpr h6₂
    have h6₄ : n ^ ((1 : ℝ) / 3) > 1 := by
      have h6₄ : (1 : ℝ) < n := Nat.one_lt_of_ne_zero h6₂
      exact Real.one_lt_rpow h6₄ (by linarith) (1 / 3)
    have h6₅ : (Nat.divisors n).card > 4 := by
      have h6₅ : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) > 1 := by linarith
      have h6₆ : 1 < (4.5 : ℝ) := by norm_num
      have h6₇ : (Nat.divisors n).card / n ^ ((1 : ℝ) / 3) > (4 : ℝ) / n ^ ((1 : ℝ) / 3) := by linarith
      have h6₈ : (4 : ℝ) / n ^ ((1 : ℝ) / 3) > 1 := by linarith
      have h6₉ : (Nat.divisors n).card > (4 : ℝ) / n ^ ((1 : ℝ) / 3) * n ^ ((1 : ℝ) / 3) := by
        rw [gt_iff_lt, div_mul_eq_mul_div, lt_mul_iff_one_lt_right]
        exact h6₇
        exact h6₆
      rw [mul_div_cancel₀ _ h6₆] at h6₉
      have h6₁₀ :  ((4 : ℝ) / n ^ ((1 : ℝ) / 3) * n ^ ((1 : ℝ) / 3)) = 4 := by
        rw [mul_div_cancel₀ _ h6₆]
      rw [h6₁₀] at h6₉
      norm_cast at h6₉
      have h6₁₁ : 4 > (4 : ℕ) := by
        have h6₁₁ : (4 : ℝ) / n ^ ((1 : ℝ) / 3) > (4 : ℝ) / 22 ^ ((1 : ℝ) / 3) := by
          apply div_lt_div_of_pos_left
          · norm_num
          · rw [Real.rpow_lt_rpow_iff (by norm_num) (by norm_num)]
            norm_num
          · norm_num
        have h6₁₂ : (4 : ℝ) / 22 ^ ((1 : ℝ) / 3) > 1 := by
          rw [Real.div_rpow (by norm_num) (by norm_num)]
          rw [Real.one_rpow]
          apply Real.lt_rpow_of_neg
          · norm_num
          · norm_num
          · norm_num
        linarith
      have h6₁₂ : 4 > 4 := by
        have h6₁₂ : (4 : ℕ) > (4 : ℝ) := by exact Nat.ofNat_lt_cast.mpr h6₁₁
        exact Nat.lt_of_cast_lt h6₁₂
      contradiction
    have h6₆ : n ^ ((1 : ℝ) / 3) > 2 := by
      have h6₆ : (2 : ℝ) < n := by norm_cast
      rw [← Real.log_rpow (by norm_num) (by linarith)] at h6₆
      rw [Real.log_div_log_cancel (by norm_num) (by linarith)] at h6₆
      have h6₇ : Real.log n > 0 := by
        apply Real.log_pos
        norm_cast
      have h6₈ : Real.log (n ^ ((1 : ℝ) / 3)) > 0 := by
        simp [← Real.log_rpow]
        linarith
      have h6₉ : Real.log (n ^ ((1 : ℝ) / 3)) = (1 / 3 : ℝ) * Real.log n := by
        rw [Real.log_rpow]
        simp
      have h6₁₀ : (1 : ℝ) / 3 > 0 := by norm_num
      have h6₁₁ : (1 : ℝ) / 3 * Real.log n > 0 := by
        apply mul_pos
        exact h6₁₀
        exact h6₇
      rw [h6₉] at h6₁₁
      exact h6₁₁
    have h6₇ : (Nat.divisors n).card > 4 := h6₅
    have h6₈ : n > 10 := by
      by_contra! h6₈
      have h6₈ : n ^ ((1 : ℝ) / 3) ≤ 2 := by
        have h6₈ : (2 : ℝ) ^ 3 < n := by
          have h6₈ : (2 : ℝ) ^ 3 = 8 := by norm_num
          rw [h6₈]
          norm_cast
        rw [← Real.log_rpow (by norm_num) (by linarith)] at h6₈
        rw [Real.log_div_log_cancel (by norm_num) (by linarith)] at h6₈
        have h