-- Prove that $x_1 = \frac{1}{2}$ is the unique solution.

  use (1 / 2)
  constructor
  · -- Prove that $x_1 = \frac{1}{2}$ is a solution.
    intro n hn
    induction n with
    | zero => contradiction -- base case
    | succ n ih =>
      -- Each step follows from the previous one by straightforward calculations.
      rcases ih with ⟨ih₁, ih₂, ih₃⟩
      constructor
      · norm_num
      · constructor
        · calc
            _ = (1 / 2) * ((1 / 2) + 1 / 1) := by norm_num
            _ = (1 / 2) * (1 / 2 + 1) := by norm_num
            _ = (1 / 2) * (3 / 2) := by norm_num
            _ = 3 / 4 := by norm_num
            _ > 0 := by norm_num
            _ < 3 / 4 := by norm_num
            _ = _ := by norm_num
        · calc
            _ = (1 / 2) * ((1 / 2) + 1 / 1) := by norm_num
            _ = (1 / 2) * (1 / 2 + 1) := by norm_num
            _ = (1 / 2) * (3 / 2) := by norm_num
            _ = 3 / 4 := by norm_num
            _ < 1 := by norm_num
  · -- Prove that if $x_1 \neq \frac{1}{2}$, then the conditions are not satisfied.
    intro a h
    -- Let $a$ be a real number such that $0 < a < a_2 < 1$.
    rcases h 1 with ⟨h₁, h₂, h₃⟩
    -- For each $n \geq 1$, define $a_n = f_n a$.
    let a' (n : ℕ) := f n a
    -- Then, $a_1 = a$.
    have h₀ (n : ℕ) : a' (n + 1) = a' n * (a' n + 1 / n) := by rw [h₁ n, Nat.cast_add]
    have h₁ : a' 1 = a := by simp [a']
    have h₂ (n : ℕ) : 0 < a' (n + 1) := by
      -- sequence $a_n$ is positive
      induction n with
      | zero => simp [h₁]; exact h₁
      | succ n ih =>
        calc
          _ = a' (n + 1) := by simp [h₂]
          _ = a' n * (a' n + 1 / n) := by rw [h₀ n]
          _ > 0 := by positivity
    have h₃ (n : ℕ) : a' (n + 1) > a' n := by
      -- sequence $a_n$ is strictly increasing
      induction n with
      | zero => simp [h₁, h₂]
      | succ n ih =>
        calc
          _ = a' (n + 1) := by simp [h₂]
          _ = a' n * (a' n + 1 / n) := by rw [h₀ n]
          _ > a' n := by nth_rw 2 [← one_mul (a' n)]; left; rw [mul_add]; positivity; positivity
    have h₄ (n : ℕ) : a' n < 1 := by
      -- sequence $a_n$ is positive
      induction n with
      | zero => simp [h₁]; exact h₁
      | succ n ih =>
        calc
          _ = a' (n + 1) := by simp [h₂]
          _ = a' n * (a' n + 1 / n) := by rw [h₀ n]
          _ < 1 := by
            have h₄ : a' n * (a' n + 1 / n) < 1 := by
              calc
                _ = a' (n + 1) := by simp [h₂]
                _ < 1 := by linarith
            exact h₄
    -- Since $a_n \in (0, 1)$, $a_{n+1} = a_n(a_n + \frac{1}{n}) < a_n + \frac{a_n}{n} < a_n + \frac{1}{n}$.
    have h₅ (n : ℕ) : a' (n + 1) < a' n + 1 / n := by
      calc
        _ = a' (n + 1) := by simp [h₂]
        _ = a' n * (a' n + 1 / n) := by rw [h₀ n]
        _ < a' n + 1 / n := by
          have h₅ : a' n * (a' n + 1 / n) < a' n + 1 / n := by
            calc
              _ = a' n * (a' n + 1 / n) - a' n := by ring
              _ = a' n * (a' n + 1 / n - 1) := by ring
              _ < 0 := by
                apply mul_neg_of_pos_of_neg
                positivity
                linarith
          linarith
    -- For each $n \geq 1$, let $b_n = 1 - a_n$.
    let b (n : ℕ) := 1 - a' n
    -- Then, $b_1 = 1 - a$, $0 < b_n$, and $b_{n+1} < b_{n} + \frac{b_n}{n}$.
    have h₆ : b 1 = 1 - a := by simp [b, h₁]
    have h₇ (n : ℕ) : 0 < b n := by
      simp [b]
      induction n with
      | zero => linarith
      | succ n ih =>
        calc
          _ = 1 - a' (n + 1) := by simp [h₂]
          _ = 1 - a' n * (a' n + 1 / n) := by rw [h₀ n]
          _ > 0 := by
            have h₇ : a' n * (a' n + 1 / n) < 1 := by
              calc
                _ = a' (n + 1) := by simp [h₂]
                _ < 1 := by linarith
            linarith
    have h₈ (n : ℕ) : b (n + 1) < b n + b n / n := by
      calc
        _ = 1 - a' (n + 1) := by simp [h₂]
        _ = 1 - a' n * (a' n + 1 / n) := by rw [h₀ n]
        _ = 1 - (a' n + 1 / n) * a' n := by ring
        _ < 1 - (1 / n) * a' n := by
          have h₈ : (a' n + 1 / n) * a' n > (1 / n) * a' n := by
            calc
              _ = a' n * (a' n + 1 / n) := by ring
              _ > a' n := by
                apply (mul_lt_mul_left (by positivity)).mpr
                linarith
                positivity
              _ = a' n + 1 / n - 1 / n := by ring
              _ > a' n + 1 / n - 1 / n - (1 / n) * a' n := by
                linarith
          linarith
        _ = _ := by ring
    -- Since $b_{n+1} < b_n + \frac{b_n}{n}$, $\frac{b_{n+1} - b_n}{b_n} < \frac{1}{n}$.
    have h₉ (n : ℕ) : (b (n + 1) - b n) / b n < 1 / n := by
      calc
        _ = (b (n + 1) - b n) / b n := by ring
        _ = (b n + b n / n - b n) / b n := by
          rw [← h₈ n]
          ring
        _ = (b n / n) / b n := by ring
        _ = 1 / n := by
          field_simp [ne_of_gt (h₇ n)]
          ring
    -- Since $0 < b_n$, $\frac{1}{b_n} > 0$.
    have h₁₀ (n : ℕ) : 1 / b n > 0 := by
      positivity
    -- Since $\frac{b_{n+1} - b_n}{b_n} < \frac{1}{n}$, $\frac{1}{b_{n+1}} < \frac{1}{b_n} + \frac{1}{n}$.
    have h₁₁ (n : ℕ) : (1 / b (n + 1)) < (1 / b n) + 1 / n := by
      calc
        _ = 1 / (b (n + 1) - (b (n + 1) - b n)) := by ring
        _ = 1 / (b n + b n / n - (b n / n)) := by
          congr
          rw [← h₈ n]
          ring
        _ = 1 / (b n + b n / n - b n / n) := by ring
        _ = 1 / (b n + (b n / n - b n / n)) := by ring
        _ = 1 / b n := by
          congr
          rw [← sub_add_cancel b n (b n / n)]
          ring
        _ < 1 / b n + 1 / n := by
          -- Apply the inequality $\frac{1}{x + y} < \frac{1}{x} + \frac{1}{y}$ when $x = b_n$ and $y = \frac{b_n}{n} - b_n$.
          have h₁₁ : (1 / b (n + 1)) < (1 / b n) + (1 / n) := by
            calc
              _ = 1 / (b n + b n / n - b n) := by
                congr
                rw [← sub_add_cancel b n (b n / n)]
                ring
              _ < 1 / b n + 1 / n := by
                apply one_div_lt_add_one_div_of_lt
                positivity
                simp [h₇ n]
                refine (mul_lt_mul_left (by positivity)).mpr?_
                linarith [h₉ n]
          linarith
    -- Since $b_n \leq b_1$ for each $n \geq 1$ and $b_1 > 0$, Zorn's lemma ensures that $\prod_{n \geq 1} b_n$ is positive.
    have h₁₂ : ∏ n, b n > 0 := by
      apply Finset.prod_pos
      · intro n _
        simp [b]
        induction n with
        | zero => linarith
        | succ n ih =>
          calc
            _ = 1 - a' (n + 1) := by simp [h₂]
            _ = 1 - a' n * (a' n + 1 / n) := by rw [h₀ n]
            _ = 1 - (a' n + 1 / n) * a' n := by ring
            _ ≥ 1 - (1 / n) * a' n := by
              have h₁₂ : a' n * (a' n + 1 / n) ≥ (1 / n) * a' n := by
                calc
                  _ = a' n * (a' n + 1 / n) := by ring
                  _ ≥ a' n := by
                    apply (mul_le_mul_left (by positivity)).mpr
                    linarith
                    positivity
                  _ = a' n + 1 / n - 1 / n := by ring
                  _ ≥ a' n + 1 / n - 1 / n - (1 / n) * a' n := by
                    linarith
              linarith
            _ ≥ _ := by
              apply sub_le_sub_left
              simp [h₇ n]
            _ > 0 := by linarith [h₇ 0]
      · intro n _
        simp [h₇ n]
    -- However, $\prod_{n \geq 1} b_n = \prod_{n \geq 1} (1 - a_n)$ is clearly less than or equal to $1 - \sum_{n \geq 1} a_n = 1 - 1 = 0$, a contradiction.
    have h₁₃ : ∏ n, b n ≤ 0 := by
      calc
        _ = ∏ n, 1 - a' n := by
          apply Finset.prod_congr
          rfl
          intro n _
          simp [b]
          linarith [h₇ n]
        _ ≤ 1 - ∑ n, a' n := by
          -- Use the fact that $1 - x \leq e^{-x}$ for each $x \geq 0$.
          have h₁₃ (x : ℝ) : 1 - x ≤ exp (-x) := by
            calc
              _ = 1 - x := by ring
              _ ≤ 1 + (-x) := by linarith [Real.exp_neg_le_add_self (-x)]
              _ = exp (-x) := by ring
          refine Finset.prod_le_exp_sub?_ a'
          intro n _
          linarith [h₇ n]
        _ = 1 - 1 := by
          rw [←Finset.sum_congr a' (fun n hn => (1 : ℝ))]
          apply Finset.sum_congr
          rfl
          intro n hn
          rw [h₁]
        _ = 0 := by norm_num
    linarith
  -- Prove that $x_1 = \frac{1}{2}$ is the only solution.
  intro a h
  rcases h 1 with ⟨h₁, h₂, h₃⟩
  by_contra! ha
  -- Let $a_n = f_n a$ for each $n \geq 1$.
  let a' (n : ℕ) := f n a
  -- Then, $a_1 = a$.
  have h₀ : a' 1 = a := by simp [a']
  have h₁ (n : ℕ) : a' (n + 1) = a' n * (a' n + 1 / n) := by rw [h₁ n, Nat.cast_add]
  -- $a' 2 \neq a' 1 * (a' 1 + 1 / 1)$.
  have h₂ : a' 2 ≠ a' 1 * (a' 1 + 1 / 1) := by
    by_contra! h₂
    simp [a', h₀] at h₂
    norm_num [ha] at h₂
  -- However, $a_{n+1} = a_n(a_n + \frac{1}{n})$ for each $n \geq 1$.
  have h₃ (n : ℕ) : a' (n + 1) = a' n * (a' n + 1 / n) := by rw [h₁ n, Nat.cast_add]
  -- Since $a_1 = a > 0$, $a_2 = a_1(a_1 + 1/1) > 0$, and inductively, $a_n > 0$ for each $n \geq 1$.
  have h₄ : ∀ n, 0 < a' n := by
    intro n
    induction n with
    | zero => simp [h₀]; exact h₀
    | succ n ih =>
      calc
        _ = a' (n + 1) := by simp [h₃ n]
        _ = a' n * (a' n + 1 / n) := by rw [h₁ n]
        _ > 0 := by positivity
  -- Since $a_1 = a < 1$, $a_2 = a_1(a_1 + 1/1) < 1$, and inductively, $a_n < 1$ for each $n \geq 1$.
  have h₅ : ∀ n, a' n < 1 := by
    intro n
    induction n with
    | zero => simp [h₀]; exact h₀
    | succ n ih =>
      calc
        _ = a' (n + 1) := by simp [h₃ n]
        _ = a' n * (a' n + 1 / n) := by rw [h₁ n]
        _ < 1 := by
          have h₅ : a' n * (a' n + 1 / n) < 1 := by
            calc
              _ = a' (n + 1) := by simp [h₃ n]
              _ < 1 := by linarith
          exact h₅
  -- Since $0 < a_n < 1$, $0 < a_{n+1} = a_n(a_n + \frac{1}{n}) < a_n + \frac{a_n}{n} < a_n + \frac{1}{n}$.
  have h₆ (n : ℕ) : a' (n + 1) < a' n + 1 / n := by
    calc
      _ = a' (n + 1) := by simp [h₃ n]
      _ = a' n * (a' n + 1 / n) := by rw [h₁ n]
      _ < a' n + 1 / n := by
        have h₆ : a' n * (a' n + 1 / n) < a' n + 1 / n := by
          calc
            _ = a' n