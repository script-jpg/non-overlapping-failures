constructor

  -- The answer is $f(z) = 0$ for all $z$ or $f(z) = 2z + c$ for some constant $c$.
  · intro hf
    -- Let $P(a, b)$ be the assertion that $f(2a) + 2f(b) = f(f(a + b))$.
    let P (a b : ℤ) := f (2 * a) + 2 * f b = f (f (a + b))
    -- We first show that $f(0) = 0$.
    have f0 : f 0 = 0 := by
      -- Substitute $a = b = 0$ into $P$.
      have h := P 0 0
      simp at h
      -- Now $f(f(0)) = f(0) + 2f(0) = 3f(0)$.
      have h' := P 0 (0 + 0)
      simp at h'
      -- So $f(0) = 3f(0)$ and therefore $f(0) = 0$.
      linarith

    -- For any $z$, substitute $a = 0$ and $b = z$ into $P$.
    have h1 : ∀ z, f (f z) = f 0 + 2 * f z := by
      intro z
      have h := P 0 z
      simp [f0] at h
      exact h

    -- For any $z$, we have $f(2 \cdot 0) + 2f(z) = f(f(z))$ by $P$.
    have h2 : ∀ z, f (f z) = f 0 + 2 * f z := by
      intro z
      specialize P 0 z
      simp [f0] at P
      exact P

    -- Let $c = f(1) - 2$.
    let c := f 1 - 2
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + c := by
      -- We first show that $f(1) = c + 2$.
      have f1 : f 1 = c + 2 := by
        simp [c]
      -- We prove that $f(z) = 2z + c$ for all $z \geq 0$ by induction.
      have h3 : ∀ z, 0 ≤ z → f z = 2 * z + c := by
        intro z hz
        induction z with
        | zero => simp
        | succ z ih =>
          -- Base case: $f(0) = 0 = 2 \cdot 0 + c$.
          · rify at hz
            simp at hz
            linarith only [f0, ih, h1]
          -- Inductive step: Assume $f(z) = 2z + c$, show $f(z + 1) = 2(z + 1) + c$.
          · rify at hz ih
            simp at hz ih
            have : f (z + 1) = 2 * (z + 1) + c := by
              calc
                _ = f (2 * (z + 1) + 1 - (z + 1)) := by ring_nf
                _ = f (f (z + 1)) - 2 * f (2 * (z + 1) + 1) + 2 * f (z + 1) := by
                  rw [← hf, add_assoc]
                  ring_nf
                  simp [f0]
                  ring
                _ = _ := by
                  rw [h2, hf, hf, ih, f1]
                  simp
                  ring_nf
                  simp [c]
                  linarith only [hz]
            exact this

      -- Now show that $f(z) = 2z + c$ for all $z < 0$.
      have h4 : ∀ z, z < 0 → f z = 2 * z + c := by
        intro z hz
        -- Since $z < 0$, we have $-z > 0$.
        have : 0 < -z := by omega
        -- We have $f(-z) = 2(-z) + c$ by the previous case.
        have h5 := h3 (-z) this
        -- Now $f(-z) = 2(-z) + c = -2z + c$.
        simp at h5
        -- We have $f(-z) = f(f(z)) - 2f(2z) + 2f(z)$ by $P$.
        have h6 := hf z (-z)
        simp [f0] at h6
        -- So $-2z + c = f(f(z)) - 2f(2z) + 2f(z)$.
        rw [h5] at h6
        -- We also have $f(-z) = 2(-z) + c$ by $P$.
        have h7 := hf (-z) z
        simp [f0] at h7
        -- So $-2z + c = f(f(-z)) - 2f(-2z) + 2f(-z) = f(-2z) + 2(-2z) + 2f(-z)$.
        rw [h5] at h7
        -- By rearranging, we get $f(-2z) = -2z + c - 2f(-z) + 2(-2z) + 2f(-z) = -2z + c + 2f(-z) - 4z + 2f(-z)$.
        have h8 : f (-2 * z) = -2 * z + c + 2 * f (-z) - 4 * z + 2 * f (-z) := by
          linarith
        -- So $f(-2z) = 2(-2z) + 2c$.
        rw [h5, hf] at h8
        ring_nf at h8
        -- Now $f(-2z) = 2(-2z) + c$.
        replace h8 := h3 (-2 * z) (by omega)
        -- So $c = 2c$, which means $c = 0$.
        have c_eq_zero : c = 0 := by
          linarith
        -- So $f(-2z) = 2(-2z) + 0$.
        simp [c_eq_zero] at h8
        -- We have $f(z) = 2z + c$ for all $z < 0$.
        exact h8

      -- Let $z$ be a nonzero integer.
      have hz : z > 0 ∨ z < 0 := by omega
      cases hz with
      | inl hz =>
        -- If $z > 0$, then $f(z) = 2z + c$ by the previous case.
        exact h3 z hz
      | inr hz =>
        -- If $z < 0$, then $f(z) = 2z + c$ by the previous case.
        exact h4 z hz

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Let $c = f(1) - 2$.
    -- We claim that $f(z) = 2z + c$ for all $z$.
    have f_eq (z : ℤ) : f z = 2 * z + (f 1 - 2) := by
      -- We have $f(z) = 2z + c$ for all $z$ by the previous case.
      have h := f_eq z
      -- $c = f(1) - 2$ by definition.
      simp [c, sub_eq_iff_eq_add] at h ⊢
      exact h

    -- Trivial case.
    exact Or.inl (fun z => Or.inl (f_eq z))

  -- Now we show that the answer is correct.
  · intro h
    -- Consider two cases.
    cases h with
    | inl h =>
      -- If $f(z) = 0$ for all $z$, then the equation is satisfied.
      intro a b
      simp [h, hf]
    | inr h =>
      -- If $f(z) = 2z + c$ for some constant $c$, then the equation is satisfied.
      intro a b
      calc
        _ = 2 * (2 * a) + 2 * (2 * b) + c := by rw [h (2 * a), h (2 * b)]; ring
        _ = 2 * (2 * a + 2 * b) + c := by ring
        _ = 2 * (a + b) + c := by ring
        _ = _ := by rw [h (a + b)]
```