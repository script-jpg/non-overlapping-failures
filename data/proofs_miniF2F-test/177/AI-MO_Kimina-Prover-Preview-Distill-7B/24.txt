constructor

  -- sufficiency
 . intro hf

    -- By setting $a = 0, b = 0$, we get $f(0) = 0$.
    have f_0 : f 0 = 0 := by
      have h := hf 0 0
      simp at h
      linarith

    -- By setting $a = 0, b = n$, we get $f(2n) = 2f(n)$.
    have f_2n (n : ℤ) : f (2 * n) = 2 * f n := by
      have h := hf 0 n
      simp at h
      linarith

    -- By setting $b = 0, a = n$, we get $f(f(n)) = f(2n) + 2f(0) = f(2n)$
    have f_f (n : ℤ) : f (f n) = f (2 * n) := by
      have h := hf n 0
      simp at h
      linarith

    -- By setting $a = n, b = n$, we get $f(4n) = 4f(n)$.
    have f_4n (n : ℤ) : f (4 * n) = 4 * f n := by
      have h1 := hf n n
      have h2 := hf (2 * n) (2 * n)
      simp at h1 h2
      rw [f_2n, ←h1, f_2n] at h2
      linarith

    -- By setting $a = n, b = 2n$, we get $f(6n) = 2f(2n) + 2f(3n)$.
    have f_6n (n : ℤ) : f (6 * n) = 2 * f (2 * n) + 2 * f (3 * n) := by
      have h1 := hf n (2 * n)
      have h2 := hf (2 * n) (3 * n)
      simp at h1 h2
      rw [f_2n] at h1 h2
      linarith

    -- By setting $a = n, b = 3n$, we get $f(8n) = 4f(2n) + 2f(4n)$.
    have f_8n (n : ℤ) : f (8 * n) = 4 * f (2 * n) + 2 * f (4 * n) := by
      have h1 := hf n (3 * n)
      have h2 := hf (3 * n) (5 * n)
      simp at h1 h2
      rw [f_2n, f_4n] at h1 h2
      linarith

    -- By setting $a = 2n, b = 2n$, we get $f(8n) = 2f(4n)$.
    have f_8n' (n : ℤ) : f (8 * n) = 2 * f (4 * n) := by
      have h := hf (2 * n) (2 * n)
      simp at h
      rw [f_4n, f_4n] at h
      linarith

    -- By setting $a = 4n, b = 2n$, we get $f(12n) = 2f(6n) + 2f(6n)$.
    have f_12n (n : ℤ) : f (12 * n) = 4 * f (6 * n) := by
      have h1 := hf (4 * n) (2 * n)
      have h2 := hf (2 * n) (4 * n)
      simp at h1 h2
      rw [f_6n, f_6n] at h1 h2
      linarith

    -- By setting $a = 3n, b = 3n$, we get $f(9n) = 2f(3n)$.
    have f_9n (n : ℤ) : f (9 * n) = 2 * f (3 * n) := by
      have h := hf (3 * n) (3 * n)
      simp at h
      linarith

    -- By setting $a = 6n, b = 3n$, we get $f(15n) = 2f(12n) + 2f(9n)$.
    have f_15n (n : ℤ) : f (15 * n) = 2 * f (12 * n) + 2 * f (9 * n) := by
      have h1 := hf (6 * n) (3 * n)
      have h2 := hf (3 * n) (6 * n)
      simp at h1 h2
      rw [f_12n, f_9n] at h1 h2
      linarith

    -- By setting $a = 4n, b = 4n$, we get $f(16n) = 4f(4n)$.
    have f_16n (n : ℤ) : f (16 * n) = 4 * f (4 * n) := by
      have h := hf (4 * n) (4 * n)
      simp at h
      linarith

    -- By setting $a = n, b = n$, we get $f(n) = 0$ or $f(n) = 2n$.
    have f_self (n : ℤ) : f n = 0 ∨ f n = 2 * n := by
      have h1 := hf n n
      have h2 := hf (4 * n) (4 * n)
      simp at h1 h2
      rw [f_4n] at h1 h2
      have h3 : 2 * (f n - f (2 * n)) = f n - f (2 * n) := by linarith
      have h4 : f n - f (2 * n) = 0 := by
        have h5 : f n - f (2 * n) = 2 * (f n - f (2 * n)) := by linarith
        linarith
      have h5 : f n = f (2 * n) := by linarith
      rw [f_2n] at h5
      have h6 : f n = 0 ∨ f n = 2 * n := by omega
      exact h6

    -- By setting $a = n, b = n$, we get $f(n) = 0$ or $f(n) = 2n$.
    have f_self' (n : ℤ) : f n = 0 ∨ ∃ c, f n = 2 * n + c := by
      rcases f_self n with h | h
     . left; exact h
     . right
        use 0
        linarith

    -- By setting $a = n, b = m$, we get $f(2n) = 2f(n)$ and $f(2m) = 2f(m)$
    -- so $f(2n) = 2f(n) = 2f(m) = f(2m)$
    have f_eq (n m : ℤ) : f (2 * n) = f (2 * m) := by
      rw [f_2n]
      have h1 := f_self' n
      have h2 := f_self' m
      rcases h1 with h1 | h1
     . rcases h2 with h2 | h2
       . rw [h1, h2]
       . linarith
     . rcases h2 with h2 | h2
       . linarith
       . rw [h1, h2]

    -- Therefore, $f$ is either completely zero or of the form $f(n) = 2n + c$.
    by_cases f_zero : ∀ z, f z = 0
   . left; exact f_zero
   . right
      use f 1
      intro z
      have h := f_self' z
      rcases h with h | h
     . rw [h, f_zero 1]
        linarith
     . rcases h with ⟨c, h⟩
        have h' := f_eq z 1
        rw [h, h'] at h
        linarith

  -- necessity
 . intro hf z
    rcases hf z with hz | ⟨c, hz⟩
   . rw [hz]
      simp
   . rw [hz]
      simp

```