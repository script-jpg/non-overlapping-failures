-- We will use the intermediate value theorem to show that there are exactly
  -- 6 solutions to the equation $1 - 3\sin\theta + 5\cos3\theta = 0$ in the
  -- interval $(0, 2\pi]$.

  -- First, we show that for any solution $\theta$ to the equation $1 - 3\sin\theta + 5\cos3\theta = 0$
  -- we have $|\cos\theta - \cos(3\theta)| \ge \frac 12$.

  have h₁ (x : ℝ) (hx : 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0) :
      abs (Real.cos x - Real.cos (3 * x)) ≥ 1 / 2 := by
    -- We can write $|cos x - cos 3x|$ as $|2\sin 2x \sin x|$.

    have : abs (Real.cos x - Real.cos (3 * x)) = abs (2 * Real.sin (2 * x) * Real.sin x) := by
      rw [Real.cos_three_mul, Real.cos_two_mul]
      ring
    rw [this]

    -- We can write $|2\sin 2x \sin x|$ as $2|\sin 2x \sin x|$.

    have : abs (2 * Real.sin (2 * x) * Real.sin x) = 2 * abs (Real.sin (2 * x) * Real.sin x) := by
      rw [abs_mul]
      norm_num
    rw [this]

    -- We now show that $\sin 2x \sin x \neq 0$.

    have h₃ : Real.sin (2 * x) * Real.sin x ≠ 0 := by
      by_contra! h₃
      rw [mul_eq_zero] at h₃
      rcases h₃ with h₃ | h₃
      -- If $\sin 2x = 0$, then $1 - 3\sin x + 0 = 1 - 3\sin x = 0$, so $\sin x = \frac 13$, but this is not a solution.
      · have h₄ : Real.sin (2 * x) = 0 := by
          rw [Real.sin_eq_zero_iff]
          right
          apply mem_Icc.mpr
          constructor <;> linarith [Real.pi_pos]
        have h₅ : 1 - 3 * Real.sin x = 0 := by
          rw [h₄] at hx
          linarith
        have h₆ : Real.sin x = 1 / 3 := by linarith
        have h₇ : Real.sin x ^ 2 + Real.cos x ^ 2 = 1 := Real.sin_sq_add_cos_sq x
        rw [h₆] at h₇
        have h₈ : Real.cos x ^ 2 = 8 / 9 := by linarith
        have h₉ : Real.cos x ^ 2 ≥ 0 := by
          exact sq_nonneg (Real.cos x)
        linarith
      -- If $\sin x = 0$, then $1 - 0 + 5\cos 3x = 5\cos 3x = 0$, so $\cos 3x = \frac 15$, but this is not a solution.
      · have h₄ : Real.sin x = 0 := by
          rw [mul_eq_zero] at h₃
          tauto
        have h₅ : 5 * Real.cos (3 * x) = 0 := by
          rw [h₄] at hx
          linarith
        have h₆ : Real.cos (3 * x) = 0 := by linarith
        have h₇ : Real.cos (3 * x) ^ 2 + Real.sin (3 * x) ^ 2 = 1 := Real.cos_sq_add_sin_sq (3 * x)
        rw [h₆] at h₇
        have h₈ : Real.sin (3 * x) ^ 2 = 1 := by linarith
        have h₉ : Real.sin (3 * x) ^ 2 ≥ 0 := by
          exact sq_nonneg (Real.sin (3 * x))
        linarith

    -- We know that $|a b| \le |a| |b|$, so $|2\sin 2x \sin x| \le 2|\sin 2x| |\sin x|$.

    have : abs (Real.sin (2 * x) * Real.sin x) ≤ 2 * abs (Real.sin (2 * x)) * abs (Real.sin x) := by
      calc
        abs (Real.sin (2 * x) * Real.sin x) = abs (Real.sin (2 * x)) * abs (Real.sin x) := by
          rw [abs_mul]
        _ ≤ 2 * abs (Real.sin (2 * x)) * abs (Real.sin x) := by
          linarith only [show 0 ≤ abs (Real.sin (2 * x)) * abs (Real.sin x) by positivity]
    rw [mul_le_mul_iff_of_pos_right (by positivity)] at this

    -- We can write $\sin 2x = 2\sin x \cos x$, so $|\sin 2x| = |2\sin x \cos x| = 2|\sin x| |\cos x|$.

    have : abs (Real.sin (2 * x)) = 2 * abs (Real.sin x * Real.cos x) := by
      rw [Real.sin_two_mul]
      rw [abs_mul]
      norm_num
    rw [this, abs_mul] at this

    -- We now show that $|\cos x - \cos 3x| \ge |\cos x - 1|$, which is enough to prove the
    -- claim that $|\cos x - \cos 3x| \ge \frac 12$.

    suffices abs (Real.cos x - 1) ≤ 1 / 2 by
      calc
        abs (Real.cos x - Real.cos (3 * x)) ≥ abs (Real.cos x - 1) := by
          linarith only [show 0 ≤ 1 - Real.cos (3 * x) by linarith [Real.cos_le_one (3 * x), hx]]
        _ ≤ 1 / 2 := this
    rw [abs_le]
    nth_rw 2 [abs_le]
    nth_rw 1 [show 1 = 2 * (1 / 2) by norm_num]
    constructor
    -- To show that $|\cos x - 1| \le \frac 12$, we first show that $\cos x \ge \frac 12$.

    · have h₄ : 1 / 2 ≤ Real.cos x := by
        rw [show 1 / 2 = Real.cos (Real.pi / 3) by rw [Real.cos_pi_div_three]]
        rw [abs_le]
        constructor
        -- We know that $\cos(\pi - \alpha) = -\cos(\alpha)$ and $\cos(\alpha - 2\pi) = \cos(\alpha)$.
        -- So for $\frac \pi 3 \le \theta \le \frac 5{3\pi}$, we have $\cos(\theta) \ge \cos(\frac \pi 3)$.
        · refine Real.cos_le_cos_of_nonneg_of_le_pi?_?_?_
          any_goals try linarith [Real.pi_pos]
          rw [show 2 * Real.pi - Real.pi / 3 = 5 * Real.pi / 3 by ring]
          refine le_trans?_ (show 5 * Real.pi / 3 ≤ 2 * Real.pi by linarith [Real.pi_pos])
          exact Real.cos_two_pi_le Real.cos_pi_div_three
        -- For $0 \le \theta \le \frac \pi 3$, we have $\cos(\theta) \ge \cos(\frac \pi 3)$
        · refine Real.cos_le_cos_of_nonneg_of_le_pi?_?_?_
          any_goals try linarith [Real.pi_pos]
          exact h₃
      linarith only [h₄]
    -- Now we show that $\cos x \le \frac 3 2$, which is enough to prove that $|\cos x - 1| \le \frac 12$.

    · have h₅ : Real.cos x ≤ 3 / 2 := by
        have h₆ : Real.cos x ≤ 1 := by
          exact Real.cos_le_one x
        linarith only [h₆]
      linarith only [h₅]


  -- We divide the interval $(0, 2\pi]$ into 6 subintervals of the form $(a_k, a_{k + 1}]$,
  -- where $a_0 = 0$ and $a_{k + 1} = a_k + \frac{2\pi}{6}$ for $k = 0, \ldots, 5$.

  let a : ℕ → ℝ := fun k => (2 * Real.pi / 6 : ℝ) * k

  -- We show that for each $k = 0, \ldots, 5$ there is exactly one solution to the equation
  -- $1 - 3\sin\theta + 5\cos3\theta = 0$ in the interval $(a_k, a_{k + 1}]$.

  have h₂ (k : ℕ) (hk : k < 6) : ∃! x ∈ (Set.Ioc (a k) (a (k + 1))) :
      1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 := by

    -- Let $f(\theta) = \cos(\theta) - \cos(3\theta)$.
    let f (θ : ℝ) := Real.cos θ - Real.cos (3 * θ)

    -- We can write $f(\theta) = 2\sin(2\theta)\sin(\theta)$ for all $\theta$.
    have h₄ (θ : ℝ) : f θ = 2 * Real.sin (2 * θ) * Real.sin θ := by
      simp [f]
      rw [Real.cos_three_mul, Real.cos_two_mul]
      ring

    -- Let $g(\theta) = 2\sin(2\theta)$.
    let g (θ : ℝ) := 2 * Real.sin (2 * θ)

    -- Then $f(\theta) = g(\theta) \sin(\theta)$ for all $\theta$.
    have h₅ (θ : ℝ) : f θ = g θ * Real.sin θ := by
      simp [h₄, h₅]
      ring

    -- The function $g(\theta)$ is monotonic on each interval $(a_k, a_{k + 1}]$.
    have h₆ : StrictMonoOn g (Set.Ioc (a k) (a (k + 1))) := by
      refine StrictMonoOn.mono (strictMonoOn_id (a (k + 1)))?_
      intro x hx y hy hxy
      simp [a] at hx hy
      simp [g]
      rw [show 2 * (2 * Real.pi / 6 * (k + 1)) = 2 * Real.pi / 6 * (k + 1) + 2 * Real.pi / 6 by ring]
      rw [Real.sin_add_two_pi]
      simp
      exact add_lt_add_right (hx ▸ hy) (2 * Real.pi / 6)
      exact lt_of_le_of_ne (by positivity) (by linarith [hx, hy])

    -- The function $\sin(\theta)$ is monotonic on each interval $(a_k, a_{k + 1}]$.
    have h₇ : StrictMonoOn Real.sin (Set.Ioc (a k) (a (k + 1))) := by
      refine StrictMonoOn.mono (strictMonoOn_id (a (k + 1)))?_
      intro x hx y hy hxy
      simp [a] at hx hy
      simp [Real.sin]
      exact add_lt_add_right (hx ▸ hy) (Real.pi / 2)
      exact lt_of_le_of_ne (by positivity) (by linarith [hx, hy])

    -- The function $f(\theta) = g(\theta) \sin(\theta)$ is strictly monotonic on each interval
    -- $(a_k, a_{k + 1}]$ because it is the product of two monotonic functions.
    have h₈ : StrictMonoOn f (Set.Ioc (a k) (a (k + 1))) := by
      refine StrictMonoOn.mono (strictMonoOn_id (a (k + 1)))?_
      intro x hx y hy hxy
      simp [h₅]
      rw [mul_lt_mul_iff_of_pos_right]
      · exact h₆ hx hy hxy
      · exact h₇ hx hy hxy
      · apply lt_of_le_of_ne (le_of_lt hx) (le_of_lt hy)
        by_contra! h₈
        simp [h₄] at h₈
        have h₈ := congr_arg (fun t ↦ Real.arccos t) h₈
        simp [-Real.arccos] at h₈
        rw [Real.arccos_cos] at h₈
        · simp [a] at hx hy
          simp [hk] at hx hy
          rw [← hx, ← hy] at h₈
          linarith [Real.pi_pos]
        · exact hx
        · exact hy
        · apply ne_of_gt
          exact Real.arccos_pos.mpr (.injOn.mp ⟨by linarith only [hx, Real.pi_pos], by linarith only [hy, Real.pi_pos]⟩)
        · apply ne_of_gt
          exact Real.arccos_pos.mpr (.injOn.mp ⟨by linarith only [hx, Real.pi_pos], by linarith only [hy, Real.pi_pos]⟩)
        · apply ne_of_gt
          exact lt_trans (by simp [a]; linarith [Real.pi_pos]) (by linarith [hx, hy])
        · apply ne_of_gt
          exact lt_trans (by simp [a]; linarith [Real.pi_pos]) (by linarith [hx, hy])

    -- We show that $f(\theta) = 0$ has exactly one solution in each interval $(a_k, a_{k + 1}]$.
    have h₈' (k : ℕ) (hk : k < 6) : ∃! x ∈ (Set.Ioc (a k) (a (k + 1))) : f x = 0 := by
      -- The minimum value of $f(\theta)$ on $(a_k, a_{k + 1}]$ is $f(a_{k + 1})$.
      have h₉ : f (a (k + 1)) = 0 := by
        simp [f]
        left
        rw [show 3 * (2 * Real.pi / 6 * (k + 1)) = 2 * Real.pi / 6 * 3 * (k + 1) by ring]
        rw [Real.cos_three_mul, Real.cos_two_pi_mul]
        simp
      -- The maximum value of $f(\theta)$ on $(a_k, a_{k + 1}]$ is $f(a_k)$.
      have h₁₀ : f (a k) = -2 := by
        simp [f]
        rw [show 3 * (2 * Real.pi / 6 * k) = 2 * Real.pi / 6 * 3 * k by ring]
        rw [Real.cos_three_mul, Real.cos_two_pi_mul]
        simp
        linarith only [Real.cos_le_one (2 * Real.pi / 6 * k)]
      have h₁₁ : f continuousOn (Set.Ioc (a k) (a (k + 1))) := by
        apply ContinuousOn.sub
        · apply ContinuousOn.mul
          · exact continuousOn_const
          · apply continuousOn_cos
        · apply continuousOn_cos
      -- By the intermediate value theorem, $f(\theta) = c$ has at least one solution
      -- in $(a_k, a_{k + 1}]$ for all $c \in (f(a_{k + 1}), f(a_k))$.
      have h₁₂ (c : ℝ) : c ∈ Set.Ioo (f (a (k + 1))) (f (a k)) → ∃ x ∈ (Set.Ioc (a k) (a (k + 1))) : f x = c := by
        intro h₁₂
        simp at h₁₂
        let g := fun x ↦ (f x - c) / (f (a k) - c)
        have h₁₃ : c ∈ Set.Ioo (f (a (k + 1))) (f (a k)) := h₁₂
        have h₁₄ : g continuousOn (Set.Ioc (a k) (a (k + 1))) := by
          apply ContinuousOn.div
          · apply ContinuousOn.sub
            · apply ContinuousOn.mul
              · exact continuousOn_const
              · apply continuousOn_cos
            · apply continuousOn_cos
          · exact continuousOn_const
          · exact ne_of_lt (by linarith [h₁₃.left, h₁₃.right])
        have h₁₅ : g (a k) = 0 := by
          simp [g]
          rw [h₁₀, h₉]
          norm_num
        have h₁₆ : g (a (k + 1)) = 1 := by
          simp [g, h₉, h₁₀]
          norm_num
        have h₁₇ : 0 < g continuousOn (Set.Ioc (a k) (a (k + 1))) := by
          apply ContinuousOn.pos_of_pos_of_mem
          · simp [h₁₅]
          · exact Set.mem_Ioo.mpr ⟨by linarith only [h₁₃.left], by linarith only [h₁₃.right]⟩
        have h₁₈ : 0 < (1 : ℝ) := by norm_num
        have h₁₉ : ∃ x ∈ (Set.Ioc (a k) (a (k + 1))), g x = 0 ∧