-- We will use the intermediate value theorem to show that there are exactly
  -- 6 solutions to the equation.
  suffices P : ∀ d : ℕ, 0 < d → d < 6 → ∃ x : ℝ, 0 < x ∧ x ≤ 2 * Real.pi ∧ (d : ℝ) = 1 - 3 * Real.sin x + 5 * Real.cos (3 * x)
  · have ⟨x0, h0⟩ := P 0 (by norm_num) (by norm_num)
    have ⟨x1, h1⟩ := P 1 (by norm_num) (by norm_num)
    have ⟨x2, h2⟩ := P 2 (by norm_num) (by norm_num)
    have ⟨x3, h3⟩ := P 3 (by norm_num) (by norm_num)
    have ⟨x4, h4⟩ := P 4 (by norm_num) (by norm_num)
    have ⟨x5, h5⟩ := P 5 (by norm_num) (by norm_num)
    -- As the equation has at least 6 solutions, we will show that it has at most 6 solutions.
    suffices H : ∀ x : ℝ, 0 < x ∧ x ≤ 2 * Real.pi → 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) ≠ 0 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x0 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x1 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x2 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x3 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x4 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x5  by
      -- If the equation has at most 6 solutions, then it has exactly 6 solutions.
      have hS : S = {x0, x1, x2, x3, x4, x5} := by
        suffices S = ({x0, x1, x2, x3, x4, x5} : Finset ℝ) by
          norm_cast at this
          rw [this]
        ext x
        simp [hS, h₀]
        constructor
        · intro h
          simp [h]
          tauto
        · intro h
          simp [h]
          tauto
      rw [hS]
      rw [Finset.card]
      simp
    intro x ⟨h0, h1⟩
    have hS : 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) ≠ 0 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x0 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x1 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x2 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x3 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x4 ∨ 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 0 ∧ x = x5 := by
      clear * - h0 h1
      -- Suppose that $1 - 3 \sin \theta + 5 \cos 3 \theta = 0$. We will show that $\theta$ is equal to $x0, x1, x2, x3, x4$ or $x5$
      -- so that we can apply the above proposition.
      by_cases h' : 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) < 0
      · -- If $1 - 3 \sin \theta + 5 \cos 3 \theta < 0$, then $\cos 3\theta < -1/5$.
        have : Real.cos (3 * x) < (-1 : ℝ) / 5 := by nlinarith
        -- $\cos 3\theta < -1/5$ implies that $3\theta$ is in the range $(2k\pi - 2\pi/3, 2k\pi + 2\pi/3)$ for some $k$.
        have ⟨k, hk⟩ := Real.cos_lt_iff.mp this
        -- We have $3 x \in (2k\pi - 2\pi/3, 2k\pi + 2\pi/3)$.
        have h2 : 3 * x ∈ (Ioo (2 * Real.pi * k - 2 * Real.pi * (1 / 3)) (2 * Real.pi * k + 2 * Real.pi * (1 / 3))) := by
          constructor
          · linarith
          · linarith
        -- We define $y = 3x - 2k\pi$.
        let y := 3 * x - 2 * Real.pi * k
        -- So $y \in (-2\pi/3, 2\pi/3)$.
        have hy : y ∈ Ioo (-2 * Real.pi * (1 / 3)) (2 * Real.pi * (1 / 3)) := by
          simp [y]
          rw [sub_lt_iff_lt_add]
          constructor
          · linarith
          · linarith
        -- By the properties of the cosine function, we have $\cos y = \cos (3x)$.
        have h3 : Real.cos y = Real.cos (3 * x) := by
          simp [y]
          rw [Real.cos_sub_int_mul_two_pi]
        -- $\cos y = \cos (3x)$ implies that $\cos y < -1/5$.
        have h4 : Real.cos y < (-1 : ℝ) / 5 := by linarith
        -- We show that $y$ is in the range $(2\pi k - 2\pi/3, 2\pi k + 2\pi/3)$.
        have h5 : y ∈ (Ioo (2 * Real.pi * k - 2 * Real.pi * (1 / 3)) (2 * Real.pi * k + 2 * Real.pi * (1 / 3)) : Set ℝ) := by
          simp [y]
          constructor
          · linarith
          · linarith
        have g : 3 * x = y + 2 * Real.pi * k := by
          simp [y]
          ring
        -- If $y \in (-2\pi/3, 2\pi/3)$ and $\cos y < -1/5$, then $y \in (\pi/2, 2\pi/3)$.
        have hk' : k = 0 ∨ k = 1 ∨ k = -1 ∨ k = -2 := by
          by_cases hk' : k = 0 ∨ k = 1 ∨ k = -1 ∨ k = -2 ∨ k ≥ 3
          · tauto
          · replace hk' : k ≥ 3 := by omega
            -- If $k \geq 3$, then $\cos y = \cos (3x) < -1/5$.
            have h6 : Real.cos y < (-1 : ℝ) / 5 := by linarith
            -- However, if $k \geq 3$, then $y \in (-2\pi/3, 2\pi/3)$ and $\cos y \geq -1/5$.
            have h7 : Real.cos y ≥ (-1 : ℝ) / 5 := by
              -- We have $y \in (-2\pi/3, 2\pi/3)$.
              have h8 : y ∈ Icc (-2 * Real.pi * (1 / 3)) (2 * Real.pi * (1 / 3)) := by
                simp
                constructor
                · linarith
                · linarith
              -- We have $\cos y \in [-1, 1]$.
              have h9 : Real.cos y ∈ Set.Icc (Real.cos 2 * Real.pi * (1 / 3)) (Real.cos (-2 * Real.pi * (1 / 3))) := by
                apply Real.cos_mem_Icc
              -- Because $y \in (-2\pi/3, 2\pi/3)$, $\cos y \geq \cos (2\pi/3) = -1/2 > -1/5$.
              simp at h9
              rw [show Real.cos 2 * Real.pi * (1 / 3) = Real.cos (2 * Real.pi / 3) by ring] at h9
              rw [show Real.cos (-2 * Real.pi * (1 / 3)) = Real.cos (2 * Real.pi / 3) by rw [← Real.cos_neg]; ring] at h9
              have h10 : Real.cos (2 * Real.pi / 3) = -1 / 2 := by
                rw [show 2 * Real.pi / 3 = Real.pi - Real.pi / 3 by ring]
                rw [Real.cos_pi_sub]
                norm_num
              rw [h10] at h9
              norm_num at h9
              exact h9
            linarith
        -- We consider each case for $k$.
        rcases hk' with hk' | hk' | hk' | hk'
        -- If $k = 0$, then $\theta = y/3 \in (0, \pi/2)$.
        · simp [hk'] at g
          have hy0 : y > 0 := by
            simp [y]
            linarith
          have hy1 : y < 2 * Real.pi := by
            simp [y]
            linarith
          have hx0 : x = y / 3 := by
            linarith
          -- We have $y \in (0, 2\pi)$, so $x \in (0, \pi/2)$.
          have hx1 : x > 0 := by
            linarith
          have hx2 : x < Real.pi / 2 := by
            linarith
          -- If $x \in (0, \pi/2)$, then $1 - 3\sin x + 5\cos3x \neq 0$.
          left
          intro h
          -- We have $\cos 3x = \cos y \in [-1, 1]$.
          have hcos : Real.cos (3 * x) ∈ Set.Icc (Real.cos (2 * Real.pi)) (Real.cos 0) := by
            apply Real.cos_mem_Icc
            -- Because $3x \in [-2\pi/3, 2\pi/3]$, $\cos 3x \geq -1/2 > -1/5$.
            rw [g]
            simp
            have g0 : y ≥ 0 := by
              simp [y]
              linarith
            have g1 : y ≤ 2 * Real.pi := by
              simp [y]
              linarith
            constructor
            · linarith
            · linarith
          -- Because $3x \in [-2\pi/3, 2\pi/3]$, $\cos 3x \geq -1/2 > -1/5$.
          simp at hcos
          rw [show Real.cos (2 * Real.pi) = 1 by simp] at hcos
          rw [show Real.cos 0 = 1 by simp] at hcos
          have hcos0 : Real.cos (3 * x) ≥ -1 / 2 := by nlinarith
          -- However, $1 - 3\sin x + 5\cos3x = 0$ implies that $\cos3x = -1/5 < -1/2$.
          have hcos1 : Real.cos (3 * x) = -1 / 5 := by linarith
          linarith
        -- If $k = 1$, then $\theta = (y + 2\pi/3)/3 \in (\pi/3, \pi/2)$.
        · simp [hk'] at g
          have hy0 : y > 2 * Real.pi / 3 := by
            simp [y]
            linarith
          have hy1 : y < 4 * Real.pi / 3 := by
            simp [y]
            linarith
          have hx0 : x = (y + 2 * Real.pi / 3) / 3 := by
            rw [g]
            ring
          -- We have $y \in (\pi/3, 4\pi/3)$, so $x \in (\pi/3, \pi/2)$.
          have hx1 : x > Real.pi / 3 := by
            rw [hx0]
            linarith
          have hx2 : x < Real.pi / 2 := by
            rw [hx0]
            linarith
          -- If $x \in (\pi/3, \pi/2)$, then $1 - 3\sin x + 5\cos3x \neq 0$.
          left
          intro h
          -- We have $\cos 3x = \cos y \in [-1, 1]$.
          have hcos : Real.cos (3 * x) ∈ Set.Icc (Real.cos (4 * Real.pi / 3)) (Real.cos (2 * Real.pi / 3)) := by
            apply Real.cos_mem_Icc
            -- Because $3x \in [2\pi/3, 4\pi/3]$, $\cos 3x \leq -1/2 < -1/5$.
            rw [g]
            simp
            have g0 : y ≥ 2 * Real.pi / 3 := by
              simp [y]
              linarith
            have g1 : y ≤ 4 * Real.pi / 3 := by
              simp [y]
              linarith
            constructor
            · linarith
            · linarith
          -- Because $3x \in [2\pi/3, 4\pi/3]$, $\cos 3x \leq -1/2 < -1/5$.
          simp at hcos
          have hcos0 : Real.cos (3 * x) ≤ -1 / 2 := by nlinarith
          rw [show Real.cos (4 * Real.pi / 3) = -1 / 2 by rw [show 4 * Real.pi / 3 = Real.pi + Real.pi / 3 by ring]; rw [Real.cos_add, Real.cos_pi, Real.sin_pi]; norm_num] at hcos
          have hcos1 : Real.cos (3 * x) = -1 / 5 := by linarith
          -- However, $1 - 3\sin x + 5\cos3x = 0$ implies that $\cos3x = -1/5 > -1/2$.
          linarith
        -- If $k = -1$, then $\theta = (y + 8\pi/3)/3 \in (2\pi/3, 5\pi/6)$.
        · simp [hk'] at g
          have hy0 : y > 4 * Real.pi / 3 := by
            simp [y]
            linarith
          have hy1 : y < 8 * Real.pi / 3 := by
            simp [y]
            linarith
          have hx0 : x = (y + 8 * Real.pi / 3) / 3 := by
            rw [g]
            ring
          -- We have $y \in (2\pi/3, 8\pi/3)$, so $x \in (2\pi/3, 4\pi/3)$.
          have hx1 : x > 2 * Real.pi / 3 := by
            rw [hx0]
            linarith
          have hx2 : x < 4 * Real.pi / 3 := by
            rw [hx0]
            linarith
          -- If $x \in (2\pi/3, 4\pi/3)$, then $1 - 3\sin x + 5\cos3x \neq 0$.
          left
          intro h
          -- We have $\cos 3x = \cos y \in [-1, 1]$.
          have hcos : Real.cos (3 * x) ∈ Set.Icc (Real.cos (8 * Real.pi / 3)) (Real.cos (4 * Real.pi / 3)) := by
            apply Real.cos_mem_Icc
            -- Because $3x \in [4\pi/3, 8\pi/3]$, $\cos 3x \in [-1, 1]$.
            rw [g]
            simp
            have g0 : y ≥ 4 * Real.pi / 3 := by
              simp [y]
              linarith
            have g1 : y ≤ 8 * Real.pi / 3 := by
              simp [y]
              linarith
            constructor
            · linarith
            · linarith
          -- Because $3x \in [4\pi/3, 8\pi/3]$, $\cos 3x \in [-1, 1]$.
          simp at hcos
          have hcos0 : Real.cos (3 * x) ≥ -1 := by nlinarith
          have hcos1 : Real.cos (3 * x) ≤ 1 := by nlinarith
          -- However, $1 - 3\sin x + 5\cos3x = 0$ implies that $\cos3x = -1/5 \leq -1$.
          have hcos : Real.cos (3 * x) = -1 / 5 := by linarith
          -- However, $\cos3x \leq 1$ and $-1/5 > -1$.