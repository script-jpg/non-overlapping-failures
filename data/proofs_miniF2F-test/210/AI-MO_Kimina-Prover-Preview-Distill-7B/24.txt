-- First, show that S is the set of the 6 solutions that we found in
  -- AMC12B_2021_P13-1.
  have h₁ : S = {
      4 * Real.pi / 3, Real.pi / 2, 5 * Real.pi / 3, 3 * Real.pi / 2, 2 * Real.pi,
      7 * Real.pi / 3
  } := by

    -- We prove that S = {x1, x2, x3, x4, x5, x6} by showing that S ⊆ {x1, x2, x3, x4, x5, x6}
    -- and {x1, x2, x3, x4, x5, x6} ⊆ S.
    ext x
    constructor
    · -- First, assume that x ∈ S, so we need to show that x ∈ {x1, x2, x3, x4, x5, x6}.
      intro hx
      -- To that end, first extract the conditions on x from hx.
      have ⟨hx1, hx2, hx3⟩ := hx

      -- Then, we need to show that x = x1 ∨ x = x2 ∨ x = x3 ∨ x = x4 ∨ x = x5 ∨ x = x6.
      have hx4 : x = 4 * Real.pi / 3 ∨ x = Real.pi / 2 ∨ x = 5 * Real.pi / 3 ∨
        x = 3 * Real.pi / 2 ∨ x = 2 * Real.pi ∨ x = 7 * Real.pi / 3 := by

        -- Remove the cos(3θ) term from the equation.
        have h₁ : 1 - 3 * Real.sin x + 5 * Real.cos (3 * x) = 1 - 3 * Real.sin x + 4 * Real.cos x ^ 3 - 15 * Real.cos x ^ 2 := by
          rw [Real.cos_three_mul]
          ring_nf
        rw [h₁] at hx3

        -- We get a cubic equation in sin(x) and cos(x).
        rw [show 1 - 3 * Real.sin x + 4 * Real.cos x ^ 3 - 15 * Real.cos x ^ 2 = 3 * (cos x - 1) * (1 - 2 * cos x) * (cos x + 2 * cos x - 1) by ring_nf] at hx3

        -- To solve this equation, we need to show that the term in the parentheses
        -- is never negative.
        have h₂ : cos x + 2 * cos x - 1 ≥ 0 := by linarith only [show -1 ≤ cos x by apply Real.neg_one_le_cos, show cos x ≤ 1 by apply Real.cos_le_one]
        -- Now, we can divide both sides of the equation by this term.
        replace hx3 : (cos x - 1) * (1 - 2 * cos x) = 0 := by exact eq_zero_of_ne_zero_of_mul_left_eq_zero (by linarith only [h₂]) hx3

        -- We have sin²(x) + cos²(x) = 1.
        have h₃ : Real.sin x ^ 2 + Real.cos x ^ 2 = 1 := by exact Real.sin_sq_add_cos_sq x

        -- We need to show that cos x = 1 or cos x = 1/2.
        replace h₂ : cos x = 1 ∨ cos x = 1 / 2 := by
          -- We can write cos²(x) = 1/4.
          rcases hx3 with hx3 | hx3
          · -- First, assume that cos x = 1.
            exact Or.inl (by linarith only [hx3])
          · -- Otherwise, cos x - 1/2 = 0.
            apply eq_of_sub_eq_zero at hx3
            -- We get (cos x - 1) * (cos x - 1/2) = 0.
            have h₄ : (cos x - 1) * (cos x - 1 / 2) = 0 := by
              calc
                (cos x - 1) * (cos x - 1 / 2) = (cos x - 1) * (cos x - 1) / 2 := by ring_nf
              _ = (cos x - 1) ^ 2 / 2 := by ring_nf
              _ = ((1 - 2 * cos x) * (cos x - 1)) / 2 := by congr!; ring_nf
              _ = 0 / 2 := by rw [hx3]
              _ = 0 := by norm_num
            -- Now, we can conclude that cos x = 1 or cos x = 1/2.
            simp at h₄
            exact h₄

        -- Now, we need to find all values of sin x corresponding to the possible values of cos x.
        rcases h₂ with h₂ | h₂
        · -- First, consider the case where cos x = 1.
          have h₅ : sin x = 0 := by
            rw [h₂] at h₃
            linarith only [h₃]
          have h₆ : (sin x + 1) * (sin x - 1) = 0 := by
            calc
              (sin x + 1) * (sin x - 1) = sin x ^ 2 - 1 := by ring_nf
              _ = -cos x ^ 2 := by rw [←h₃]; ring_nf
              _ = -1 := by rw [h₂]; norm_num
              _ = - (sin x ^ 2 + cos x ^ 2) := by rw [h₃]
              _ = - (sin x ^ 2 + 1 ^ 2) := by rw [h₂]
              _ = - (sin x + 1) * (sin x - 1) := by ring_nf
          -- Now we have sin x = 1 or sin x = -1.
          simp at h₆
          rcases h₆ with h₆ | h₆
          · -- If sin x = 1, then x = π/2 + 2kπ.
            have h₇ : sin (x - 2 * Real.pi) = 1 := by
              rw [Real.sin_sub, Real.sin_two_pi, Real.cos_two_pi]
              rw [h₆, h₂]
              norm_num
            have h₈ : x - 2 * Real.pi = Real.pi / 2 + 2 * Real.pi * (1 / 2) := by
              rw [Real.sin_eq_one_iff] at h₇
              rcases h₇ with ⟨k, hk⟩
              use k - 1
              nth_rw 1 [show 1 = 1 / 2 + 1 / 2 by norm_num, ←hk]
              ring_nf
            -- We get x = π/2 + 2kπ.
            replace h₈ : x = Real.pi / 2 + 2 * Real.pi * (k : ℝ) := by
              calc
                x = 2 * Real.pi + (x - 2 * Real.pi) := by ring
              _ = 2 * Real.pi + (Real.pi / 2 + 2 * Real.pi * (1 / 2)) := by rw [h₈]
              _ = Real.pi / 2 + 2 * Real.pi * (1 / 2 + 1) := by ring
              _ = Real.pi / 2 + 2 * Real.pi * (1 / 2 + 1 * (k : ℝ)) := by simp only [←mul_one (2 * Real.pi), ←mul_assoc]
              _ = Real.pi / 2 + 2 * Real.pi * (1 / 2 + k) := by ring
            -- Because 0 < x ≤ 2π, x = π/2.
            have hkpos : 0 < k := by
              by_contra!
              replace this : k ≤ 0 := by linarith only [this]
              have h₉ : 2 * Real.pi * (k : ℝ) ≤ 0 := by
                rw [←mul_assoc]
                apply mul_nonpos_of_nonneg_of_nonpos
                simp only [mul_nonneg_iff_of_pos_left]
                linarith only [this]
                exact Real.pi_nonneg
              have h₁₀ : Real.pi / 2 + 2 * Real.pi * (k : ℝ) ≤ Real.pi / 2 := by
                linarith only [h₉]
              rw [←h₈] at h₁₀
              linarith only [hx1, h₁₀]
            have hkpos : k < 1 := by
              by_contra!
              replace this : k ≥ 1 := by linarith only [this]
              have h₁₀ : 2 * Real.pi * (k : ℝ) ≥ 2 * Real.pi := by
                rw [←mul_assoc]
                apply mul_le_mul_of_nonneg_left
                simp only [le_of_lt]
                exact this
                exact Real.pi_nonneg
              have h₁₁ : Real.pi / 2 + 2 * Real.pi * (k : ℝ) ≥ Real.pi / 2 + 2 * Real.pi := by
                linarith only [h₁₀]
              rw [←h₈] at h₁₁
              linarith only [h₁₁, hx2]
            -- We get x = π/2.
            have h₁₁ : k = 1 / 2 := by linarith only [hkpos, hkpos]
            rw [h₈]
            norm_cast
          · -- If sin x = -1, then x = 3π/2 + 2kπ.
            have h₇ : sin (x - 2 * Real.pi) = -1 := by
              rw [Real.sin_sub, Real.sin_two_pi, Real.cos_two_pi]
              rw [h₆, h₂]
              norm_num
            have h₈ : x - 2 * Real.pi = 3 * Real.pi / 2 + 2 * Real.pi * (1 / 2) := by
              rw [Real.sin_eq_neg_one_iff] at h₇
              rcases h₇ with ⟨k, hk⟩
              use k - 1
              nth_rw 1 [show -1 = -1 / 2 - 1 / 2 by norm_num, ←hk]
              ring_nf
            -- We get x = 3π/2 + 2kπ.
            replace h₈ : x = 3 * Real.pi / 2 + 2 * Real.pi * (k : ℝ) := by
              calc
                x = 2 * Real.pi + (x - 2 * Real.pi) := by ring
              _ = 2 * Real.pi + (3 * Real.pi / 2 + 2 * Real.pi * (1 / 2)) := by rw [h₈]
              _ = 3 * Real.pi / 2 + 2 * Real.pi * (1 / 2 + 1) := by ring
              _ = 3 * Real.pi / 2 + 2 * Real.pi * (1 / 2 + 1 * (k : ℝ)) := by simp only [←mul_one (2 * Real.pi), ←mul_assoc]
              _ = 3 * Real.pi / 2 + 2 * Real.pi * (1 / 2 + k) := by ring
            -- Because 0 < x ≤ 2π, there is no solution in this case.
            have hkpos : 0 < k := by
              by_contra!
              replace this : k ≤ 0 := by linarith only [this]
              have h₉ : 2 * Real.pi * (k : ℝ) ≤ 0 := by
                rw [←mul_assoc]
                apply mul_nonpos_of_nonneg_of_nonpos
                simp only [mul_nonneg_iff_of_pos_left]
                linarith only [this]
                exact Real.pi_nonneg
              have h₁₀ : 3 * Real.pi / 2 + 2 * Real.pi * (k : ℝ) ≤ 3 * Real.pi / 2 := by
                linarith only [h₉]
              rw [←h₈] at h₁₀
              linarith only [h₁₀, hx1]
            have hkpos : k < 1 := by
              by_contra!
              replace this : k ≥ 1 := by linarith only [this]
              have h₁₀ : 2 * Real.pi * (k : ℝ) ≥ 2 * Real.pi := by
                rw [←mul_assoc]
                apply mul_le_mul_of_nonneg_left
                simp only [le_of_lt]
                exact this
                exact Real.pi_nonneg
              have h₁₁ : 3 * Real.pi / 2 + 2 * Real.pi * (k : ℝ) ≥ 3 * Real.pi / 2 + 2 * Real.pi := by
                linarith only [h₁₀]
              rw [←h₈] at h₁₁
              linarith only [h₁₁, hx2]
            -- We get x = 3π/2.
            have h₁₁ : k = 1 / 2 := by linarith only [hkpos, hkpos]
            rw [h₈]
            norm_cast
        · -- Now, consider the case where cos x = 1/2.
          have h₅ : sin x = - (√3 / 2) ∨ sin x = (√3 / 2) := by
            rw [←h₂] at h₃
            -- We have sin²(x) = 3/4.
            have h₄ : sin x ^ 2 = 3 / 4 := by
              calc
                sin x ^ 2 = 1 - cos x ^ 2 := by rw [←h₃]; ring_nf
                _ = 1 - (1 / 2) ^ 2 := by rw [h₂]
                _ = 3 / 4 := by norm_num
            -- We have sin x ≥ 0 or sin x ≤ 0.
            have h₅ : sin x ≥ 0 ∨ sin x ≤ 0 := by exact Or.elim (sin_nonneg_of_nonneg_of_le_pi (by linarith only [hx1]) (by linarith only [hx2])) (fun _ => by linarith only [h₃])
            -- Now, we use the fact that sin²(x) = 3/4 to get the possible values of sin x.
            rcases h₅ with h₅ | h₅
            · -- If sin x ≥ 0, then sin x = √3/2.
              have h₆ : sin x = Real.sqrt (3 / 4) := by
                rw [←h₅, Real.sqrt_sq (by exact h₄)]
              rw [h₆]
              right
              rw [Real.sqrt_eq_iff_eq_sq (by norm_num] (by norm_num) (by norm_num)]
              norm_num
              rw [show (3 : ℝ) / 4 = (√3 / 2) ^ 2 by norm_num]
              apply pow_left_inj₀ (by norm_num) (by norm_num) (by norm_num)
            · -- If sin x ≤ 0, then sin x = -√3/2.
              have h₆ : sin x = - Real.sqrt (3 / 4) := by
                rw [←h₅, Real.sqrt_sq (by linarith only [h₄])]
              rw [h₆]
              left
              rw [Real.sqrt_eq_iff_eq_sq (by norm_num) (by norm_num) (by norm_num)]
              norm_num
              rw [show (3 : ℝ) / 4 = (√3 / 2) ^ 2 by norm_num]
              apply pow_left_inj₀ (by norm_num) (by norm_num) (by norm_num)
          -- Now, we have sin x = √3/2 or sin x = -√3/2.
          rcases h₅ with h₅ | h₅
          · -- If sin x = √3/2, then x = π/3 + 2kπ or x = 2π/3 + 2kπ.
            have h₆ : (sin (x - 2 * Real.pi) + 1) * (sin (x - 2 * Real.pi) - 1) = 0 := by
              calc
                (sin (x - 2 * Real.pi) + 1) * (sin (x - 2 * Real.pi) - 1) = sin (x - 2 * Real.pi) ^ 2 - 1 := by ring_nf
              _ = - cos (x - 2 * Real.pi) ^ 2 := by rw [←Real.sin_sq_add_cos_sq (x - 2 * Real.pi)]; ring_nf
              _ = -1 := by rw [h₅]; norm_num
              _ = - (sin (x - 2 * Real.pi) ^ 2 + cos (x - 2 * Real.pi) ^ 2) := by rw [Real.sin_sq_add_cos_sq (x - 2 * Real.pi)]
              _ = - (sin (x - 2 * Real.pi) ^ 2 + 1 ^ 2) := by rw [h₅]
              _ = - (sin (x - 2 * Real.pi) + 1) * (sin (x - 2 * Real.pi) - 1) := by ring_nf
            -- Now, we have sin (x - 2π) = 1 or sin (x - 2π) = -1.
            simp at h₆
            rcases h₆ with h₆ | h₆
            · -- If sin (x - 2π) = 1, then x - 2π = π/2 + 2kπ.
              have h₇ : (x - 2 * Real.pi) = Real.pi / 2 + 2 * Real.pi * (1 / 2) := by
                rw [Real.sin_eq_one_iff] at h₆
                rcases h₆ with ⟨k, hk⟩
                use k - 1
                nth_rw 1 [show 1 = 1 / 2 + 1 / 2 by norm_num, ←